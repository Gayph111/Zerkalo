<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Зеркало - современная социальная сеть</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* ===== ОСНОВНЫЕ ПЕРЕМЕННЫЕ И СТИЛИ ===== */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #c7d2fe;
            --secondary: #f8fafc;
            --text: #1e293b;
            --text-light: #64748b;
            --text-lighter: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --card-bg: #ffffff;
            --background: #f8fafc;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --error: #ef4444;
            --error-light: #fecaca;
            --success: #10b981;
            --success-light: #a7f3d0;
            --warning: #f59e0b;
            --warning-light: #fde68a;
            --info: #3b82f6;
            --info-light: #bfdbfe;
            --online: #10b981;
            --offline: #94a3b8;
            --away: #f59e0b;
            --dnd: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ===== АНИМАЦИИ ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in { animation: fadeIn 0.3s ease; }
        .slide-in { animation: slideIn 0.3s ease; }
        .slide-up { animation: slideUp 0.3s ease; }

        /* ===== ХЕЛПЕРЫ ===== */
        .hidden { display: none !important; }
        .loading { animation: pulse 1.5s ease-in-out infinite; }
        .spinner { animation: spin 1s linear infinite; }
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== КНОПКИ ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            user-select: none;
        }

        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover { background-color: var(--primary-dark); }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }

        .btn-danger:hover { background-color: #dc2626; }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover { background-color: #059669; }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background-color: var(--secondary);
            color: var(--primary);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 16px;
        }

        .btn-block { width: 100%; }
        .btn-rounded { border-radius: 50px; }

        /* ===== КАРТОЧКИ ===== */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover { box-shadow: var(--shadow-md); }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .card-body {
            padding: 20px;
        }

        .card-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background-color: var(--secondary);
        }

        /* ===== ШАПКА ===== */
        header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.9);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            transition: transform 0.2s;
        }

        .logo:hover { transform: scale(1.05); }
        .logo-icon { font-size: 28px; }

        /* Поиск */
        .search-container {
            flex: 0 1 400px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--border);
            border-radius: 50px;
            font-size: 14px;
            background-color: var(--secondary);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-top: 4px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--secondary);
        }

        /* Навигация */
        .nav-links {
            display: flex;
            gap: 4px;
        }

        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 16px;
            color: var(--text-light);
            text-decoration: none;
            font-size: 12px;
            border-radius: var(--radius);
            transition: all 0.2s;
            min-width: 70px;
        }

        .nav-link:hover {
            background-color: var(--secondary);
            color: var(--text);
        }

        .nav-link.active {
            color: var(--primary);
            background-color: var(--primary-light);
        }

        .nav-link i {
            font-size: 20px;
        }

        /* Уведомления */
        .badge {
            background-color: var(--error);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Профиль пользователя */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover { transform: scale(1.05); }

        .status-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-online { background-color: var(--online); }
        .status-offline { background-color: var(--offline); }
        .status-away { background-color: var(--away); }
        .status-dnd { background-color: var(--dnd); }

        .status-pulse {
            animation: pulse 2s infinite;
        }

        /* ===== ОСНОВНОЙ КОНТЕНТ ===== */
        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 24px;
            padding: 24px 0;
            min-height: calc(100vh - 64px);
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Левая панель */
        .left-panel {
            position: sticky;
            top: 88px;
            height: fit-content;
        }

        .user-card {
            padding: 20px;
        }

        .user-info {
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 16px;
            position: relative;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-username {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .user-clan {
            display: inline-block;
            background-color: var(--primary-light);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .user-bio {
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: left;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .user-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Центральная панель */
        .feed {
            display: flex;
            flex-direction: column;
            gap: 24px; /* Увеличили расстояние между постами */
        }

        /* Создание поста */
        .create-post {
            padding: 16px;
        }

        .post-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .post-input {
            flex: 1;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            transition: border-color 0.2s;
        }

        .post-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }

        .post-attachments {
            display: flex;
            gap: 8px;
        }

        .attachment-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: var(--radius);
            background: none;
            border: 1px solid var(--border);
            color: var(--text-light);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .attachment-btn:hover {
            background-color: var(--secondary);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Посты */
        .post {
            position: relative;
            margin-bottom: 0; /* Убираем марджин снизу, так как используем gap в .feed */
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            cursor: pointer;
        }

        .post-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .post-author-info {
            flex: 1;
        }

        .post-author-name {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .verified-badge {
            color: var(--success);
            font-size: 14px;
        }

        .post-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            font-size: 13px;
        }

        .post-time {
            color: var(--text-lighter);
        }

        .post-content {
            padding: 0 20px 16px;
            line-height: 1.6;
        }

        .post-attachment {
            margin: 12px 0;
            border-radius: var(--radius);
            overflow: hidden;
            max-width: 100%;
        }

        .post-attachment img {
            width: 100%;
            max-height: 500px;
            object-fit: cover;
        }

        .attachment-info {
            padding: 8px 12px;
            background-color: var(--secondary);
            font-size: 13px;
            color: var(--text-light);
        }

        /* Улучшенные действия поста */
        .post-actions-footer {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 20px;
            border-top: 1px solid var(--border-light);
            background-color: var(--secondary);
        }

        .post-actions-footer .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius);
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            flex: 1;
            max-width: 100px;
        }

        .post-actions-footer .action-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .post-actions-footer .action-btn.active,
        .post-actions-footer .action-btn.liked {
            color: var(--primary);
        }

        .post-actions-footer .action-btn.liked {
            color: #f43f5e;
        }

        .post-actions-footer .action-btn.liked:hover {
            color: #e11d48;
        }

        .post-actions-footer .action-btn .fa-heart {
            color: inherit;
        }

        .post-actions-footer .action-count {
            font-weight: 600;
            font-size: 13px;
            color: inherit;
        }

        /* Репосты */
        .repost-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px 0;
            color: var(--text-light);
            font-size: 13px;
        }

        .repost-content {
            margin: 12px 20px;
            padding: 16px;
            background-color: var(--secondary);
            border-radius: var(--radius);
            border-left: 3px solid var(--primary-light);
        }

        /* Комментарии */
        .comments-section {
            padding: 0 20px;
            margin-top: 16px;
        }

        .comment {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .comment:last-child {
            margin-bottom: 0;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            background-color: var(--secondary);
            padding: 12px;
            border-radius: var(--radius);
        }

        .comment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .comment-author {
            font-weight: 600;
            font-size: 13px;
        }

        .comment-time {
            color: var(--text-lighter);
            font-size: 12px;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.5;
        }

        .add-comment {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
            transition: border-color 0.2s;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Правая панель */
        .right-panel {
            position: sticky;
            top: 88px;
            height: fit-content;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        /* Список онлайн */
        .online-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: var(--radius);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .online-user:hover {
            background-color: var(--secondary);
        }

        .online-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
        }

        .online-user-info {
            flex: 1;
        }

        .online-user-name {
            font-weight: 500;
            font-size: 14px;
        }

        .online-user-status {
            font-size: 12px;
            color: var(--online);
        }

        /* Рекомендации */
        .recommended-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .recommended-user:hover {
            background-color: var(--secondary);
        }

        .recommended-user-info {
            flex: 1;
        }

        .recommended-user-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .recommended-user-bio {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        /* ===== СТРАНИЦЫ ===== */
        .page {
            padding: 24px 0;
            min-height: calc(100vh - 64px);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text);
        }

        /* Страница профиля */
        .profile-header {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 24px;
            position: relative;
        }

        .profile-cover {
            height: 200px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            position: relative;
        }

        .profile-cover-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .profile-info {
            padding: 0 32px 32px;
            position: relative;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            position: absolute;
            top: -60px;
            left: 32px;
            border: 4px solid var(--card-bg);
        }

        .profile-main-info {
            margin-left: 140px;
            padding-top: 16px;
        }

        .profile-name-large {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-username-large {
            color: var(--text-light);
            font-size: 16px;
            margin-bottom: 8px;
        }

        .profile-bio-large {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 16px;
            max-width: 600px;
        }

        .profile-stats-large {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
        }

        .profile-stat-large {
            text-align: center;
        }

        .profile-stat-value-large {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .profile-stat-label-large {
            font-size: 14px;
            color: var(--text-light);
        }

        .profile-actions-large {
            display: flex;
            gap: 12px;
        }

        .profile-tabs {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .tab-list {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
        }

        .tab {
            padding: 16px 20px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            margin-bottom: -1px;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-badge {
            background-color: var(--primary-light);
            color: var(--primary);
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        .tab-content {
            padding: 24px;
        }

        /* Страница сообщений */
        .messages-container {
            display: flex;
            height: calc(100vh - 180px);
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .conversations-sidebar {
            width: 320px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .conversation-item:hover,
        .conversation-item.active {
            background-color: var(--secondary);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
        }

        .conversation-info {
            flex: 1;
            overflow: hidden;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .conversation-last-message {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-lighter);
        }

        .messages-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-bg);
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
        }

        .chat-user-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .chat-user-details p {
            font-size: 13px;
            color: var(--online);
        }

        .messages-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-color: var(--background);
        }

        .message {
            display: flex;
            max-width: 70%;
            animation: slideIn 0.3s ease;
        }

        .message.outgoing {
            margin-left: auto;
        }

        .message-content {
            background-color: var(--secondary);
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.outgoing .message-content {
            background-color: var(--primary);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-lighter);
            margin-top: 4px;
            text-align: right;
        }

        .message-input-container {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background-color: var(--card-bg);
        }

        .message-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-attachments {
            display: flex;
            gap: 8px;
        }

        .message-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Страница групп */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .group-card {
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .group-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .group-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 16px;
        }

        .group-name {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .group-description {
            text-align: center;
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .group-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .group-stat {
            text-align: center;
        }

        .group-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .group-stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        /* ===== АДМИН ПАНЕЛЬ ===== */
        .admin-panel {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--radius);
            padding: 32px;
            color: white;
            margin-bottom: 24px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .admin-stat-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
        }

        .admin-stat-card:hover {
            transform: translateY(-4px);
        }

        .admin-stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .admin-stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .admin-section {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .admin-users-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .admin-user-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            gap: 16px;
        }

        .admin-user-item:last-child {
            border-bottom: none;
        }

        .admin-user-info {
            flex: 1;
        }

        .admin-user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .admin-user-meta {
            font-size: 13px;
            color: var(--text-light);
        }

        /* ===== МОДАЛЬНЫЕ ОКНА ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        .modal-large {
            max-width: 800px;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background-color: var(--secondary);
            color: var(--text);
        }

        .modal-body {
            padding: 20px;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: var(--secondary);
        }

        /* Эмодзи селектор */
        .emoji-selector {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .emoji-option {
            font-size: 24px;
            cursor: pointer;
            text-align: center;
            padding: 8px;
            border-radius: var(--radius);
            transition: all 0.2s;
            user-select: none;
        }

        .emoji-option:hover {
            background-color: var(--secondary);
            transform: scale(1.1);
        }

        .emoji-option.selected {
            background-color: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* ===== УВЕДОМЛЕНИЯ ===== */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
            width: 100%;
        }

        .notification {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease;
            transition: all 0.3s;
        }

        .notification.hiding {
            transform: translateX(100%);
            opacity: 0;
        }

        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification.success .notification-icon { color: var(--success); }
        .notification.error .notification-icon { color: var(--error); }
        .notification.info .notification-icon { color: var(--primary); }
        .notification.warning .notification-icon { color: var(--warning); }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-lighter);
            cursor: pointer;
            padding: 2px;
            flex-shrink: 0;
        }

        /* ===== АВТОРИЗАЦИЯ ===== */
        .auth-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--background) 0%, #e2e8f0 100%);
            padding: 20px;
        }

        .auth-container {
            width: 100%;
            max-width: 440px;
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.5s ease;
        }

        .auth-header {
            padding: 32px 32px 20px;
            text-align: center;
        }

        .auth-logo {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--text-light);
            font-size: 16px;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
        }

        .auth-tab:hover {
            color: var(--text);
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-body {
            padding: 32px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-text {
            display: block;
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-light);
        }

        /* ===== ГОЛОСОВЫЕ СООБЩЕНИЯ ===== */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: var(--secondary);
            border-radius: var(--radius);
            margin: 8px 0;
        }

        .voice-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .voice-play-btn:hover {
            background-color: var(--primary-dark);
        }

        .voice-waveform {
            flex: 1;
            height: 36px;
            background-color: rgba(99, 102, 241, 0.1);
            border-radius: 18px;
            position: relative;
            overflow: hidden;
        }

        .voice-wave {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to right,
                var(--primary) 0px,
                var(--primary) 2px,
                transparent 2px,
                transparent 4px
            );
            animation: voiceWave 1s linear infinite;
        }

        @keyframes voiceWave {
            from { transform: translateX(-4px); }
            to { transform: translateX(0); }
        }

        .voice-duration {
            font-size: 14px;
            color: var(--text-light);
        }

        /* ===== АДАПТИВНОСТЬ ===== */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .header-content {
                flex-wrap: wrap;
                height: auto;
                padding: 12px 0;
            }

            .logo {
                font-size: 20px;
            }

            .search-container {
                order: 3;
                flex: 1 0 100%;
                margin-top: 12px;
            }

            .user-menu {
                margin-left: auto;
            }

            .nav-links {
                order: 2;
                flex: 1;
                justify-content: space-around;
                margin: 0 10px;
            }

            .nav-link {
                min-width: auto;
                padding: 8px 12px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px 0;
            }

            .left-panel,
            .right-panel {
                position: static;
            }

            .messages-container {
                flex-direction: column;
                height: calc(100vh - 120px);
            }

            .conversations-sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .profile-main-info {
                margin-left: 0;
                margin-top: 60px;
            }

            .profile-avatar-large {
                position: relative;
                top: 0;
                left: 0;
                margin: -60px auto 20px;
            }

            .groups-grid {
                grid-template-columns: 1fr;
            }

            .emoji-selector {
                grid-template-columns: repeat(6, 1fr);
            }
            
            /* Улучшаем адаптивность шапки для мобильных */
            .header-content {
                padding: 8px 0;
            }
            
            .nav-link span {
                font-size: 10px;
            }
            
            .nav-link i {
                font-size: 16px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .main-content {
                grid-template-columns: 240px 1fr;
            }

            .right-panel {
                display: none;
            }
        }

        /* ===== ПОЛЕЗНЫЕ КЛАССЫ ===== */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-light); }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }

        .bg-primary { background-color: var(--primary); }
        .bg-secondary { background-color: var(--secondary); }
        .bg-success { background-color: var(--success); }
        .bg-error { background-color: var(--error); }
        .bg-warning { background-color: var(--warning); }

        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-5 { margin-bottom: 20px; }

        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mt-5 { margin-top: 20px; }

        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .flex-column { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-1 { flex: 1; }

        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .gap-5 { gap: 20px; }

        .w-100 { width: 100%; }
        .h-100 { height: 100%; }

        .cursor-pointer { cursor: pointer; }
        .user-select-none { user-select: none; }

        .border { border: 1px solid var(--border); }
        .border-top { border-top: 1px solid var(--border); }
        .border-bottom { border-bottom: 1px solid var(--border); }

        .rounded { border-radius: var(--radius); }
        .rounded-circle { border-radius: 50%; }

        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }

        .position-relative { position: relative; }
        .position-absolute { position: absolute; }

        .d-none { display: none; }
        .d-block { display: block; }
        .d-inline-block { display: inline-block; }

        /* ===== ИКОНКИ ===== */
        .icon-sm { font-size: 14px; }
        .icon-md { font-size: 18px; }
        .icon-lg { font-size: 24px; }
        .icon-xl { font-size: 32px; }
    </style>
</head>
<body>
    <!-- Контейнер для уведомлений -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Авторизация -->
    <div id="authPage" class="auth-page">
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-mirror"></i>
                    Зеркало
                </div>
                <div class="auth-subtitle">Современная социальная сеть</div>
            </div>

            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Вход</div>
                <div class="auth-tab" id="registerTab">Регистрация</div>
            </div>

            <div class="auth-body">
                <!-- Форма входа -->
                <form class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Юзернейм или Email</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="@username или email@example.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input type="password" id="loginPassword" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                            <i class="fas fa-sign-in-alt"></i> Войти
                        </button>
                    </div>

                    <div class="text-center text-muted">
                        <small>Для демо-доступа используйте @onegin / admin123</small>
                    </div>
                </form>

                <!-- Форма регистрации -->
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Юзернейм</label>
                        <input type="text" id="regUsername" class="form-control" placeholder="@username" required>
                        <small class="form-text">Начинается с @, должен быть уникальным</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Отображаемое имя</label>
                        <input type="text" id="regDisplayName" class="form-control" placeholder="Ваше имя" required>
                        <small class="form-text">Как вас будут видеть другие пользователи</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email (опционально)</label>
                        <input type="email" id="regEmail" class="form-control" placeholder="email@example.com">
                        <small class="form-text">Для восстановления пароля и уведомлений</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">О себе</label>
                        <textarea id="regDescription" class="form-control" placeholder="Расскажите о себе..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Аватарка (эмодзи)</label>
                        <div class="emoji-selector" id="registerEmojiSelector"></div>
                        <input type="hidden" id="regEmoji" value="😀">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input type="password" id="regPassword" class="form-control" required>
                        <small class="form-text">Минимум 8 символов</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Подтвердите пароль</label>
                        <input type="password" id="regConfirmPassword" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                            <i class="fas fa-user-plus"></i> Зарегистрироваться
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Основное приложение -->
    <div id="mainApp" class="hidden">
        <!-- Шапка -->
        <header>
            <div class="container">
                <div class="header-content">
                    <!-- Логотип -->
                    <a href="#" class="logo" id="homeLogo">
                        <i class="fas fa-mirror logo-icon"></i>
                        <span>Зеркало</span>
                    </a>

                    <!-- Поиск -->
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Поиск пользователей, групп, сообществ...">
                        <div class="search-results hidden" id="searchResults"></div>
                    </div>

                    <!-- Навигация -->
                    <nav class="nav-links">
                        <a href="#" class="nav-link active" data-page="feed" id="navFeed">
                            <i class="fas fa-home"></i>
                            <span>Лента</span>
                        </a>
                        <a href="#" class="nav-link" data-page="messages" id="navMessages">
                            <i class="fas fa-comments"></i>
                            <span>Сообщения</span>
                            <span class="badge hidden" id="messagesBadge">0</span>
                        </a>
                        <a href="#" class="nav-link" data-page="groups" id="navGroups">
                            <i class="fas fa-users"></i>
                            <span>Группы</span>
                        </a>
                        <a href="#" class="nav-link" data-page="notifications" id="navNotifications">
                            <i class="fas fa-bell"></i>
                            <span>Уведомления</span>
                            <span class="badge hidden" id="notificationsBadge">0</span>
                        </a>
                        <a href="#" class="nav-link hidden" data-page="admin" id="navAdmin">
                            <i class="fas fa-shield-alt"></i>
                            <span>Админ</span>
                        </a>
                    </nav>

                    <!-- Профиль пользователя -->
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">
                            <span id="userAvatarEmoji">😀</span>
                            <div class="status-indicator status-online" id="userStatusIndicator"></div>
                        </div>
                        <button class="btn-icon" id="logoutBtn" title="Выйти">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Основной контент - Лента -->
        <div id="feedPage" class="page">
            <div class="container">
                <div class="main-content">
                    <!-- Левая панель (профиль) -->
                    <div class="left-panel">
                        <div class="card user-card">
                            <div class="user-info">
                                <div class="profile-avatar">
                                    <span id="profileEmoji">😀</span>
                                    <div class="status-indicator status-online" id="profileStatusIndicator"></div>
                                </div>
                                <h3 class="user-name" id="profileName">Имя Фамилия</h3>
                                <div class="user-username" id="profileUsername">
                                    @username
                                    <i class="fas fa-check-circle verified-badge hidden" id="profileVerifiedBadge"></i>
                                </div>
                                <div class="user-clan" id="profileClan">😀 Клан</div>
                                
                                <div class="user-bio" id="profileBio">
                                    Пользователь пока ничего не написал в описании
                                </div>

                                <div class="user-stats">
                                    <div class="stat">
                                        <div class="stat-value" id="statPosts">0</div>
                                        <div class="stat-label">Постов</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-value" id="statFollowers">0</div>
                                        <div class="stat-label">Подписчиков</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-value" id="statFollowing">0</div>
                                        <div class="stat-label">Подписок</div>
                                    </div>
                                </div>

                                <div class="user-actions">
                                    <button class="btn btn-primary btn-block" id="createPostBtn">
                                        <i class="fas fa-plus"></i> Новый пост
                                    </button>
                                    <button class="btn btn-secondary btn-block" id="editProfileBtn">
                                        <i class="fas fa-edit"></i> Редактировать
                                    </button>
                                    <button class="btn btn-secondary btn-block" id="viewProfileBtn">
                                        <i class="fas fa-user"></i> Мой профиль
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Статус сети -->
                        <div class="card panel-section">
                            <div class="card-header">
                                <div class="card-title">Статус сети</div>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-center justify-between">
                                    <div class="d-flex align-center gap-2">
                                        <div class="status-indicator status-online status-pulse"></div>
                                        <span>В сети</span>
                                    </div>
                                    <span class="text-muted" id="onlineCount">0 онлайн</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Центральная панель (лента) -->
                    <div class="feed">
                        <!-- Создание поста -->
                        <div class="card create-post" id="createPostForm">
                            <div class="post-input-container">
                                <div class="post-avatar" id="currentUserEmoji">😀</div>
                                <textarea class="post-input" id="postText" placeholder="Что у вас нового?" rows="3"></textarea>
                            </div>
                            <div class="post-actions">
                                <div class="post-attachments">
                                    <button type="button" class="attachment-btn" id="addPhotoBtn">
                                        <i class="fas fa-image"></i>
                                        <span>Фото</span>
                                    </button>
                                    <button type="button" class="attachment-btn" id="addFileBtn">
                                        <i class="fas fa-paperclip"></i>
                                        <span>Файл</span>
                                    </button>
                                    <button type="button" class="attachment-btn" id="addVoiceBtn">
                                        <i class="fas fa-microphone"></i>
                                        <span>Голос</span>
                                    </button>
                                </div>
                                <button class="btn btn-primary" id="publishPostBtn">
                                    <i class="fas fa-paper-plane"></i> Опубликовать
                                </button>
                            </div>
                            <div id="postAttachments" class="hidden mt-3"></div>
                        </div>

                        <!-- Посты -->
                        <div id="postsContainer"></div>

                        <!-- Загрузка -->
                        <div id="postsLoader" class="hidden text-center py-4">
                            <div class="spinner">
                                <i class="fas fa-circle-notch"></i>
                            </div>
                        </div>

                        <!-- Пустая лента -->
                        <div class="card hidden" id="emptyFeed">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-feather-alt icon-xl text-muted mb-3"></i>
                                <h3 class="mb-2">Лента пуста</h3>
                                <p class="text-muted mb-4">Будьте первым, кто опубликует что-нибудь!</p>
                                <button class="btn btn-primary" id="emptyFeedPostBtn">
                                    <i class="fas fa-plus"></i> Создать первый пост
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Правая панель (онлайн, рекомендации) -->
                    <div class="right-panel">
                        <!-- Онлайн сейчас -->
                        <div class="card panel-section">
                            <div class="card-header">
                                <div class="card-title">Онлайн сейчас</div>
                            </div>
                            <div class="card-body">
                                <div id="onlineUsersList"></div>
                            </div>
                        </div>

                        <!-- Рекомендации -->
                        <div class="card panel-section">
                            <div class="card-header">
                                <div class="card-title">Рекомендуем подписаться</div>
                            </div>
                            <div class="card-body">
                                <div id="recommendedUsersList"></div>
                            </div>
                        </div>

                        <!-- Популярные группы -->
                        <div class="card panel-section">
                            <div class="card-header">
                                <div class="card-title">Популярные группы</div>
                            </div>
                            <div class="card-body">
                                <div id="popularGroupsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница профиля -->
        <div id="profilePage" class="page hidden">
            <div class="container" id="profileContainer">
                <!-- Заголовок профиля будет вставляться через JS -->
            </div>
        </div>

        <!-- Страница сообщений -->
        <div id="messagesPage" class="page hidden">
            <div class="container">
                <h1 class="page-title">
                    <i class="fas fa-comments"></i>
                    Сообщения
                </h1>
                <div class="messages-container" id="messagesContainer">
                    <!-- Содержимое будет вставляться через JS -->
                </div>
            </div>
        </div>

        <!-- Страница групп -->
        <div id="groupsPage" class="page hidden">
            <div class="container">
                <div class="d-flex align-center justify-between mb-4">
                    <h1 class="page-title">
                        <i class="fas fa-users"></i>
                        Группы и сообщества
                    </h1>
                    <button class="btn btn-primary" id="createGroupBtn">
                        <i class="fas fa-plus"></i> Создать группу
                    </button>
                </div>
                
                <!-- Табы групп -->
                <div class="card mb-4">
                    <div class="tab-list">
                        <div class="tab active" data-tab="all">Все группы</div>
                        <div class="tab" data-tab="my">Мои группы <span class="tab-badge" id="myGroupsCount">0</span></div>
                        <div class="tab" data-tab="channels">Каналы</div>
                        <div class="tab" data-tab="communities">Сообщества</div>
                    </div>
                    <div class="tab-content">
                        <div id="groupsContent">
                            <div class="groups-grid" id="allGroupsGrid"></div>
                            <div class="groups-grid hidden" id="myGroupsGrid"></div>
                            <div class="groups-grid hidden" id="channelsGrid"></div>
                            <div class="groups-grid hidden" id="communitiesGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница уведомлений -->
        <div id="notificationsPage" class="page hidden">
            <div class="container">
                <div class="d-flex align-center justify-between mb-4">
                    <h1 class="page-title">
                        <i class="fas fa-bell"></i>
                        Уведомления
                    </h1>
                    <button class="btn btn-secondary" id="markAllReadBtn">
                        <i class="fas fa-check-double"></i> Прочитать все
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div id="notificationsList">
                            <!-- Уведомления будут загружены через JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Админ панель -->
        <div id="adminPage" class="page hidden">
            <div class="container">
                <div class="admin-panel">
                    <h1 class="mb-3">
                        <i class="fas fa-shield-alt"></i> Админ панель
                    </h1>
                    <p>Управление системой и пользователями</p>
                    
                    <div class="admin-stats">
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="adminTotalUsers">0</div>
                            <div class="admin-stat-label">Пользователей</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="adminOnlineUsers">0</div>
                            <div class="admin-stat-label">Онлайн сейчас</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="adminTotalPosts">0</div>
                            <div class="admin-stat-label">Постов</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="adminTotalGroups">0</div>
                            <div class="admin-stat-label">Групп</div>
                        </div>
                    </div>
                </div>

                <!-- Верификация пользователей -->
                <div class="admin-section">
                    <h2 class="mb-3">
                        <i class="fas fa-user-check"></i> Верификация пользователей
                    </h2>
                    <div class="admin-users-list" id="adminUsersList"></div>
                </div>

                <!-- Управление группами -->
                <div class="admin-section">
                    <h2 class="mb-3">
                        <i class="fas fa-users-cog"></i> Управление группами
                    </h2>
                    <div id="adminGroupsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    
    <!-- Модалка выбора эмодзи для клана -->
    <div class="modal-overlay" id="clanModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Выберите клан</h2>
                <button class="modal-close" id="closeClanModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="emoji-selector" id="clanEmojiSelector"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelClanBtn">Отмена</button>
                <button class="btn btn-primary" id="saveClanBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модалка редактирования профиля -->
    <div class="modal-overlay" id="editProfileModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Редактировать профиль</h2>
                <button class="modal-close" id="closeEditProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Отображаемое имя</label>
                    <input type="text" id="editDisplayName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">О себе</label>
                    <textarea id="editBio" class="form-control" rows="4" placeholder="Расскажите о себе..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Статус</label>
                    <input type="text" id="editStatus" class="form-control" placeholder="Ваш статус...">
                </div>
                <div class="form-group">
                    <label class="form-label">Аватарка (эмодзи)</label>
                    <div class="emoji-selector" id="editEmojiSelector"></div>
                    <input type="hidden" id="editEmoji" value="😀">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditProfileBtn">Отмена</button>
                <button class="btn btn-primary" id="saveProfileBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модалка создания группы -->
    <div class="modal-overlay" id="createGroupModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 class="modal-title">Создать группу</h2>
                <button class="modal-close" id="closeCreateGroupModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Тип</label>
                    <div class="d-flex gap-2 mb-3" id="groupTypeSelector">
                        <button type="button" class="btn btn-secondary flex-1 active" data-group-type="group">Группа</button>
                        <button type="button" class="btn btn-secondary flex-1" data-group-type="channel">Канал</button>
                        <button type="button" class="btn btn-secondary flex-1" data-group-type="community">Сообщество</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Название</label>
                    <input type="text" id="groupName" class="form-control" placeholder="Название группы" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Юзернейм</label>
                    <input type="text" id="groupUsername" class="form-control" placeholder="@groupname" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea id="groupDescription" class="form-control" rows="3" placeholder="Опишите вашу группу..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Аватарка (эмодзи)</label>
                    <div class="emoji-selector" id="groupEmojiSelector"></div>
                    <input type="hidden" id="groupEmoji" value="👥">
                </div>
                <div class="form-group">
                    <label class="form-label">Приватность</label>
                    <div class="d-flex gap-2" id="groupPrivacySelector">
                        <button type="button" class="btn btn-secondary flex-1 active" data-privacy="public">Публичная</button>
                        <button type="button" class="btn btn-secondary flex-1" data-privacy="private">Приватная</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateGroupBtn">Отмена</button>
                <button class="btn btn-primary" id="saveGroupBtn">Создать</button>
            </div>
        </div>
    </div>

    <!-- Модалка голосового сообщения -->
    <div class="modal-overlay" id="voiceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Голосовое сообщение</h2>
                <button class="modal-close" id="closeVoiceModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="voice-waveform mb-3">
                        <div class="voice-wave"></div>
                    </div>
                    <button class="btn btn-primary btn-lg" id="recordVoiceBtn">
                        <i class="fas fa-microphone"></i> Начать запись
                    </button>
                    <div class="mt-3 text-muted" id="recordingTime">00:00</div>
                    <audio id="voicePreview" class="hidden" controls></audio>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelVoiceBtn">Отмена</button>
                <button class="btn btn-primary hidden" id="sendVoiceBtn">Отправить</button>
            </div>
        </div>
    </div>

    <!-- Модалка выбора файла -->
    <div class="modal-overlay" id="fileModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Выберите файл</h2>
                <button class="modal-close" id="closeFileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <label for="fileInput" class="btn btn-primary btn-lg mb-3">
                        <i class="fas fa-upload"></i> Выбрать файл
                    </label>
                    <input type="file" id="fileInput" class="d-none" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
                    <div class="text-muted mt-2">
                        Поддерживаются: изображения, видео, PDF, документы
                    </div>
                    <div id="filePreview" class="mt-3 hidden">
                        <img id="previewImage" class="w-100 rounded" style="max-height: 200px; object-fit: cover;">
                        <div id="previewFileInfo" class="mt-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelFileBtn">Отмена</button>
                <button class="btn btn-primary hidden" id="uploadFileBtn">Загрузить</button>
            </div>
        </div>
    </div>

	<script type="text/template" id="postTemplate">
		<div class="card post" data-post-id="{{id}}">
			{{#if is_repost}}
			<div class="repost-header">
				<i class="fas fa-retweet"></i>
				<span>{{user.username}} репостнул(а)</span>
			</div>
			{{/if}}
			
			<div class="post-header">
                <div class="post-author">
                    <div class="user-avatar cursor-pointer view-profile" data-user-id="{{user.id}}">
                        <span>{{user.emoji}}</span>
                        <div class="status-indicator {{#if user.is_online}}status-online{{else}}status-offline{{/if}}"></div>
                    </div>
                    <div class="post-author-info">
                        <div class="post-author-name">
                            <span class="view-profile cursor-pointer" data-user-id="{{user.id}}">{{user.username}}</span>
                            {{#if user.is_verified}}
                            <i class="fas fa-check-circle verified-badge"></i>
                            {{/if}}
                        </div>
                        <div class="post-meta">
                            <span class="post-time" title="{{created_at}}">{{timeAgo}}</span>
                            {{#if hasAttachment}}
                            <i class="fas fa-paperclip"></i>
                            {{/if}}
                            {{#if hasVoice}}
                            <i class="fas fa-microphone"></i>
                            {{/if}}
                        </div>
                    </div>
                </div>
                <button class="btn-icon post-menu-btn" data-post-id="{{id}}">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
            </div>

			<div class="post-content">
				{{content}}
				
				{{#if media_url}}
				<div class="post-attachment mt-3">
					{{#if media_type 'image'}}
					<img src="{{media_url}}" alt="{{media_name}}" loading="lazy">
					{{else media_type 'video'}}
					<video controls style="width:100%; max-height:400px;">
						<source src="{{media_url}}" type="video/mp4">
					</video>
					{{else media_type 'audio'}}
					<div class="audio-player">
						<div class="audio-info">{{media_name}}</div>
						<audio controls style="width:100%;">
							<source src="{{media_url}}" type="audio/mp3">
						</audio>
						<a href="{{media_url}}" download class="btn btn-sm btn-secondary mt-2">
							<i class="fas fa-download"></i> Скачать
						</a>
					</div>
					{{else}}
					<div class="file-attachment">
						<div class="attachment-info">
							<i class="fas fa-file"></i>
							<div>
								<div>{{media_name}}</div>
								<div class="text-muted">{{media_size}} • {{media_type}}</div>
							</div>
							<a href="{{media_url}}" download class="btn btn-sm btn-primary ml-auto">
								<i class="fas fa-download"></i> Скачать
							</a>
						</div>
					</div>
					{{/if}}
				</div>
				{{/if}}

				{{#if voice_url}}
				<div class="voice-message mt-3">
					<button class="voice-play-btn" data-voice-url="{{voice_url}}">
						<i class="fas fa-play"></i>
					</button>
					<div class="voice-waveform">
						<div class="voice-wave"></div>
					</div>
					<div class="voice-duration">{{formatVoiceDuration voice_duration}}</div>
				</div>
				{{/if}}
			</div>

			<!-- Кнопки взаимодействия -->
			<div class="post-actions-footer">
				<button class="action-btn like-btn {{#if liked}}liked{{/if}}" data-post-id="{{id}}">
					<i class="{{#if liked}}fas{{else}}far{{/if}} fa-heart"></i>
					<span class="action-count">{{likes_count}}</span>
				</button>
				<button class="action-btn comment-btn" data-post-id="{{id}}">
					<i class="far fa-comment"></i>
					<span class="action-count">{{comments_count}}</span>
				</button>
				<button class="action-btn repost-btn" data-post-id="{{id}}">
					<i class="fas fa-retweet"></i>
					<span class="action-count">{{reposts_count}}</span>
				</button>
				<button class="action-btn share-btn" data-post-id="{{id}}">
					<i class="fas fa-share"></i>
				</button>
			</div>
		</div>
	</script>


    <script type="text/template" id="commentTemplate">
        <div class="comment" data-comment-id="{{id}}">
            <div class="comment-avatar view-profile cursor-pointer" data-user-id="{{user.id}}">
                <span>{{user.emoji}}</span>
            </div>
            <div class="comment-content">
                <div class="comment-header">
                    <div class="comment-author view-profile cursor-pointer" data-user-id="{{user.id}}">
                        {{user.username}}
                    </div>
                    <div class="comment-time">{{timeAgo}}</div>
                </div>
                <div class="comment-text">{{content}}</div>
            </div>
        </div>
    </script>

    <script type="text/template" id="conversationTemplate">
        <div class="conversation-item" data-conversation-id="{{id}}">
            <div class="conversation-avatar">
                <span>{{avatar}}</span>
                {{#if is_online}}
                <div class="status-indicator status-online"></div>
                {{/if}}
            </div>
            <div class="conversation-info">
                <div class="conversation-name">
                    {{name}}
                    {{#if is_verified}}
                    <i class="fas fa-check-circle verified-badge"></i>
                    {{/if}}
                </div>
                <div class="conversation-last-message">{{last_message}}</div>
            </div>
            <div class="conversation-time">{{last_message_time}}</div>
        </div>
    </script>

    <script type="text/template" id="messageTemplate">
        <div class="message {{#if outgoing}}outgoing{{/if}}" data-message-id="{{id}}">
            <div class="message-content">
                {{content}}
                {{#if file_url}}
                <div class="mt-2">
                    <a href="{{file_url}}" target="_blank" class="d-flex align-center gap-2">
                        <i class="fas fa-paperclip"></i>
                        <span>{{file_name}}</span>
                    </a>
                </div>
                {{/if}}
                <div class="message-time">{{created_at}}</div>
            </div>
        </div>
    </script>

	<!-- Исправленный шаблон профиля -->
	<script type="text/template" id="profileTemplate">
		<div class="profile-header">
			<div class="profile-cover" style="background: linear-gradient(135deg, {{avatar_color}} 0%, #4f46e5 100%);">
				<div class="profile-cover-actions">
					{{#if is_own_profile}}
					<button class="btn btn-secondary" id="editProfileCoverBtn">
						<i class="fas fa-camera"></i>
					</button>
					{{else}}
					<button class="btn {{#if is_following}}btn-danger{{else}}btn-primary{{/if}} follow-btn" 
							data-user-id="{{id}}">
						{{#if is_following}}
						<i class="fas fa-user-minus"></i> Отписаться
						{{else}}
						<i class="fas fa-user-plus"></i> Подписаться
						{{/if}}
					</button>
					<button class="btn btn-secondary message-btn" data-user-id="{{id}}">
						<i class="fas fa-envelope"></i> Сообщение
					</button>
					{{/if}}
				</div>
			</div>
			<div class="profile-info">
				<div class="profile-avatar-large">
					<span>{{emoji}}</span>
					<div class="status-indicator {{#if is_online}}status-online{{else}}status-offline{{/if}}"></div>
				</div>
				<div class="profile-main-info">
					<h1 class="profile-name-large">
						{{display_name}}
						{{#if is_verified}}
						<i class="fas fa-check-circle verified-badge"></i>
						{{/if}}
					</h1>
					<div class="profile-username-large">{{username}}</div>
					<div class="profile-bio-large">{{description}}</div>
					<div class="profile-clan-large">{{clan}} Клан</div>
					
					<div class="profile-stats-large">
						<div class="profile-stat-large">
							<div class="profile-stat-value-large">{{posts_count}}</div>
							<div class="profile-stat-label-large">Постов</div>
						</div>
						<div class="profile-stat-large">
							<div class="profile-stat-value-large" id="followersCount">{{followers_count}}</div>
							<div class="profile-stat-label-large">Подписчиков</div>
						</div>
						<div class="profile-stat-large">
							<div class="profile-stat-value-large" id="followingCount">{{following_count}}</div>
							<div class="profile-stat-label-large">Подписок</div>
						</div>
					</div>

					<div class="profile-actions-large">
						{{#if is_own_profile}}
						<button class="btn btn-primary" id="profileEditBtn">
							<i class="fas fa-edit"></i> Редактировать
						</button>
						<button class="btn btn-secondary" id="profileShareBtn">
							<i class="fas fa-share"></i> Поделиться
						</button>
						{{else}}
						<button class="btn btn-secondary" id="profileReportBtn">
							<i class="fas fa-flag"></i> Пожаловаться
						</button>
						{{/if}}
					</div>
				</div>
			</div>
		</div>

		<div class="profile-tabs">
			<div class="tab-list">
				<div class="tab active" data-tab="posts">
					Публикации
					<span class="tab-badge">{{posts_count}}</span>
				</div>
				<div class="tab" data-tab="reposts">
					Репосты
					<span class="tab-badge">{{reposts_count}}</span>
				</div>
				<div class="tab" data-tab="media">
					Медиа
				</div>
				<div class="tab" data-tab="followers">
					Подписчики
					<span class="tab-badge" id="followersTabCount">{{followers_count}}</span>
				</div>
				<div class="tab" data-tab="following">
					Подписки
					<span class="tab-badge" id="followingTabCount">{{following_count}}</span>
				</div>
			</div>
			<div class="tab-content">
				<div id="profilePostsTab" class="tab-pane active">
					<div id="profilePostsContainer"></div>
				</div>
				<div id="profileRepostsTab" class="tab-pane">
					<div id="profileRepostsContainer"></div>
				</div>
				<div id="profileMediaTab" class="tab-pane">
					<div id="profileMediaContainer" class="media-grid"></div>
				</div>
				<div id="profileFollowersTab" class="tab-pane">
					<div id="profileFollowersContainer" class="users-list"></div>
				</div>
				<div id="profileFollowingTab" class="tab-pane">
					<div id="profileFollowingContainer" class="users-list"></div>
				</div>
			</div>
		</div>
	</script>

    <script type="text/template" id="groupCardTemplate">
        <div class="group-card" data-group-id="{{id}}">
            <div class="card-body">
                <div class="group-avatar">
                    <span>{{avatar}}</span>
                </div>
                <h3 class="group-name">{{name}}</h3>
                <div class="group-description">{{description}}</div>
                <div class="group-stats">
                    <div class="group-stat">
                        <div class="group-stat-value">{{members_count}}</div>
                        <div class="group-stat-label">Участников</div>
                    </div>
                    <div class="group-stat">
                        <div class="group-stat-value">{{posts_count}}</div>
                        <div class="group-stat-label">Постов</div>
                    </div>
                </div>
                <button class="btn btn-primary btn-block mt-3 join-group-btn" data-group-id="{{id}}">
                    {{#if is_member}}
                    <i class="fas fa-check"></i> Вы в группе
                    {{else}}
                    <i class="fas fa-plus"></i> Вступить
                    {{/if}}
                </button>
            </div>
        </div>
    </script>

    <!-- Основной JavaScript код -->
	<script>
		// ========== КОНФИГУРАЦИЯ ==========
		const SUPABASE_URL = 'https://kzbznupjamhualdewyxk.supabase.co';
		const SUPABASE_KEY = 'sb_publishable_VSXNcvoaf2meTwwR8gr80g_Y_YEhSgd';

		// Инициализация Supabase
		let supabaseClient;
		try {
			supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
		} catch (error) {
			console.error('Ошибка инициализации Supabase:', error);
		}

		// ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
		let currentUser = null;
		let allUsers = [];
		let allPosts = [];
		let allGroups = [];
		let notifications = [];
		let conversations = [];
		let currentMessages = [];
		let currentConversation = null;
		let onlineUsers = new Set();
		let emojis = ['😀', '😎', '🤖', '👻', '🐱', '🦊', '🐶', '🦁', '🚀', '🎨', '🎮', '🎵', '📸', '📚', '🍳', '🌍', '👨‍💻', '👩‍💻', '🧠', '💡', '🔥', '🌟', '🌙', '☀️', '🌈', '🍕', '⚽', '🎭', '🎸', '🎬', '👑', '💎'];
		let selectedFile = null;
		let selectedVoice = null;
		let isRecording = false;
		let recordingTimer = null;
		let recordingSeconds = 0;
		let mediaRecorder = null;
		let audioChunks = [];

		// ========== СИСТЕМНЫЕ УВЕДОМЛЕНИЯ ==========
		function showNotification(title, message, type = 'info', duration = 5000) {
			const container = document.getElementById('notificationContainer');
			if (!container) return;
			
			const notification = document.createElement('div');
			notification.className = `notification ${type}`;
			
			const icons = {
				success: 'check-circle',
				error: 'exclamation-circle',
				warning: 'exclamation-triangle',
				info: 'info-circle'
			};
			
			notification.innerHTML = `
				<div class="notification-icon">
					<i class="fas fa-${icons[type] || 'info-circle'}"></i>
				</div>
				<div class="notification-content">
					<div class="notification-title">${title}</div>
					<div class="notification-message">${message}</div>
				</div>
				<button class="notification-close">&times;</button>
			`;
			
			container.appendChild(notification);
			
			const closeBtn = notification.querySelector('.notification-close');
			if (closeBtn) {
				closeBtn.addEventListener('click', () => {
					notification.classList.add('hiding');
					setTimeout(() => notification.remove(), 300);
				});
			}
			
			if (duration > 0) {
				setTimeout(() => {
					if (notification.parentNode) {
						notification.classList.add('hiding');
						setTimeout(() => notification.remove(), 300);
					}
				}, duration);
			}
			
			return notification;
		}

		// ========== ФОРМАТИРОВАНИЕ ВРЕМЕНИ ==========
		function formatTimeAgo(dateString) {
			if (!dateString) return 'давно';
			
			const date = new Date(dateString);
			const now = new Date();
			const diffMs = now - date;
			const diffMins = Math.floor(diffMs / 60000);
			const diffHours = Math.floor(diffMs / 3600000);
			const diffDays = Math.floor(diffMs / 86400000);
			
			if (diffMins < 1) return 'только что';
			if (diffMins < 60) return `${diffMins} мин. назад`;
			if (diffHours < 24) return `${diffHours} ч. назад`;
			if (diffDays < 7) return `${diffDays} д. назад`;
			
			return date.toLocaleDateString('ru-RU', {
				day: 'numeric',
				month: 'short',
				year: diffDays > 365 ? 'numeric' : undefined
			});
		}

		function formatFileSize(bytes) {
			if (!bytes || bytes === 0) return '0 Bytes';
			const k = 1024;
			const sizes = ['Bytes', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
		}

		function formatVoiceDuration(seconds) {
			if (!seconds) return '0:00';
			const mins = Math.floor(seconds / 60);
			const secs = Math.floor(seconds % 60);
			return `${mins}:${secs.toString().padStart(2, '0')}`;
		}

		// ========== РАБОТА С БАЗОЙ ДАННЫХ ==========
		async function loadInitialData() {
			try {
				if (!supabaseClient) {
					throw new Error('Supabase не инициализирован');
				}
				
				// Загружаем текущего пользователя если есть
				const savedUser = localStorage.getItem('mirror_user');
				if (savedUser) {
					currentUser = JSON.parse(savedUser);
					
					// Обновляем статус онлайн
					await updateOnlineStatus();
				}
				
				// Загружаем пользователей
				const { data: users, error: usersError } = await supabaseClient
					.from('users')
					.select('*')
					.order('created_at', { ascending: false })
					.limit(100);
				
				if (!usersError) {
					allUsers = users || [];
				}
				
				// Загружаем посты
				const { data: posts, error: postsError } = await supabaseClient
					.from('posts')
					.select(`
						*,
						user:users(*)
					`)
					.order('created_at', { ascending: false })
					.limit(50);
				
				if (!postsError) {
					allPosts = posts || [];
				}
				
				// Загружаем группы
				const { data: groups, error: groupsError } = await supabaseClient
					.from('groups')
					.select('*')
					.order('created_at', { ascending: false })
					.limit(20);
				
				if (!groupsError) {
					allGroups = groups || [];
				}
				
				// Загружаем уведомления если пользователь авторизован
				if (currentUser) {
					await loadNotifications();
					await loadConversations();
				}
				
				return true;
			} catch (error) {
				console.error('Ошибка загрузки данных:', error);
				showNotification('Ошибка', 'Не удалось загрузить данные', 'error');
				return false;
			}
		}

		async function updateOnlineStatus() {
			if (!currentUser || !supabaseClient) return;
			
			try {
				// Обновляем статус в базе
				await supabaseClient
					.from('users')
					.update({
						is_online: true,
						last_seen: new Date().toISOString()
					})
					.eq('id', currentUser.id);
				
				// Получаем онлайн пользователей
				const { data: onlineUsersData } = await supabaseClient
					.from('users')
					.select('id')
					.eq('is_online', true);
				
				if (onlineUsersData) {
					onlineUsers = new Set(onlineUsersData.map(u => u.id));
				}
				
				// Обновляем интерфейс
				updateOnlineUI();
				
			} catch (error) {
				console.error('Ошибка обновления статуса:', error);
			}
		}

		async function loadNotifications() {
			if (!currentUser || !supabaseClient) return;
			
			try {
				const { data, error } = await supabaseClient
					.from('notifications')
					.select(`
						*,
						from_user:users!notifications_from_user_id_fkey(*)
					`)
					.eq('user_id', currentUser.id)
					.order('created_at', { ascending: false })
					.limit(50);
				
				if (!error) {
					notifications = data || [];
					
					// Обновляем бейдж
					const unreadCount = notifications.filter(n => !n.is_read).length;
					const badge = document.getElementById('notificationsBadge');
					if (badge) {
						badge.textContent = unreadCount;
						badge.classList.toggle('hidden', unreadCount === 0);
					}
					
					// Если открыта страница уведомлений, обновляем список
					if (document.getElementById('notificationsPage') && 
						!document.getElementById('notificationsPage').classList.contains('hidden')) {
						renderNotifications();
					}
				}
			} catch (error) {
				console.error('Ошибка загрузки уведомлений:', error);
			}
		}

		async function loadConversations() {
			if (!currentUser || !supabaseClient) return;
			
			try {
				// Получаем диалоги пользователя
				const { data: participants, error } = await supabaseClient
					.from('conversation_participants')
					.select(`
						conversation:conversations(*)
					`)
					.eq('user_id', currentUser.id);
				
				if (!error && participants) {
					conversations = participants.map(p => p.conversation);
					
					// Загружаем информацию о собеседниках для каждого диалога
					for (let conv of conversations) {
						const { data: convParticipants } = await supabaseClient
							.from('conversation_participants')
							.select(`
								user:users(*)
							`)
							.eq('conversation_id', conv.id)
							.neq('user_id', currentUser.id);
						
						if (convParticipants && convParticipants.length > 0) {
							const otherUser = convParticipants[0].user;
							conv.name = otherUser.display_name;
							conv.avatar = otherUser.emoji;
							conv.is_online = otherUser.is_online;
						}
					}
					
					// Если открыта страница сообщений, обновляем список
					if (document.getElementById('messagesPage') && 
						!document.getElementById('messagesPage').classList.contains('hidden')) {
						renderConversations();
					}
				}
			} catch (error) {
				console.error('Ошибка загрузки диалогов:', error);
			}
		}

		// ========== ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ==========
		function updateUI() {
			if (!currentUser) return;
			
			// Обновляем информацию в шапке
			const userAvatarEmoji = document.getElementById('userAvatarEmoji');
			const profileEmoji = document.getElementById('profileEmoji');
			const currentUserEmoji = document.getElementById('currentUserEmoji');
			const profileName = document.getElementById('profileName');
			const profileUsername = document.getElementById('profileUsername');
			const profileClan = document.getElementById('profileClan');
			const profileBio = document.getElementById('profileBio');
			const statPosts = document.getElementById('statPosts');
			const statFollowers = document.getElementById('statFollowers');
			const statFollowing = document.getElementById('statFollowing');
			
			if (userAvatarEmoji) userAvatarEmoji.textContent = currentUser.emoji;
			if (profileEmoji) profileEmoji.textContent = currentUser.emoji;
			if (currentUserEmoji) currentUserEmoji.textContent = currentUser.emoji;
			if (profileName) profileName.textContent = currentUser.display_name;
			if (profileUsername) profileUsername.textContent = currentUser.username;
			if (profileClan) profileClan.textContent = `${currentUser.clan} Клан`;
			if (profileBio) profileBio.textContent = currentUser.description || 'Пользователь пока ничего не написал в описании';
			if (statPosts) statPosts.textContent = currentUser.posts_count || 0;
			if (statFollowers) statFollowers.textContent = currentUser.followers_count || 0;
			if (statFollowing) statFollowing.textContent = currentUser.following_count || 0;
			
			// Показываем галочку верификации
			const verifiedBadge = document.getElementById('profileVerifiedBadge');
			if (verifiedBadge) {
				verifiedBadge.classList.toggle('hidden', !currentUser.is_verified);
			}
			
			// Показываем админку если пользователь @onegin
			const adminNav = document.getElementById('navAdmin');
			if (adminNav && currentUser.username === '@onegin') {
				adminNav.classList.remove('hidden');
			}
		}

		function updateOnlineUI() {
			// Обновляем счетчик онлайн
			const onlineCount = document.getElementById('onlineCount');
			if (onlineCount) {
				onlineCount.textContent = `${onlineUsers.size} онлайн`;
			}
			
			// Загружаем онлайн пользователей
			loadOnlineUsers();
			loadRecommendedUsers();
			loadPopularGroups();
		}

		async function loadOnlineUsers() {
			const container = document.getElementById('onlineUsersList');
			if (!container) return;
			
			// Показываем только онлайн пользователей, исключая текущего
			const online = allUsers.filter(user => 
				onlineUsers.has(user.id) && user.id !== currentUser?.id
			).slice(0, 10);
			
			if (online.length === 0) {
				container.innerHTML = '<div class="text-center text-muted py-3">Нет пользователей онлайн</div>';
				return;
			}
			
			container.innerHTML = online.map(user => `
				<div class="online-user" data-user-id="${user.id}">
					<div class="online-user-avatar">
						<span>${user.emoji}</span>
						<div class="status-indicator status-online"></div>
					</div>
					<div class="online-user-info">
						<div class="online-user-name">${user.username}</div>
						<div class="online-user-status">В сети</div>
					</div>
				</div>
			`).join('');
			
			// Добавляем обработчики кликов
			container.querySelectorAll('.online-user').forEach(item => {
				item.addEventListener('click', () => {
					const userId = item.dataset.userId;
					showUserProfile(userId);
				});
			});
		}

		async function loadRecommendedUsers() {
			const container = document.getElementById('recommendedUsersList');
			if (!container || !currentUser) return;
			
			try {
				// Исправленный запрос - без сортировки по несуществующему столбцу
				const { data: notFollowing, error } = await supabaseClient
					.from('users')
					.select('*')
					.neq('id', currentUser.id)
					.order('created_at', { ascending: false })
					.limit(5);
				
				if (error) throw error;
				
				if (!notFollowing || notFollowing.length === 0) {
					container.innerHTML = '<div class="text-center text-muted py-3">Нет рекомендаций</div>';
					return;
				}
				
				container.innerHTML = notFollowing.map(user => `
					<div class="recommended-user" data-user-id="${user.id}">
						<div class="user-avatar">
							<span>${user.emoji}</span>
						</div>
						<div class="recommended-user-info">
							<div class="recommended-user-name">${user.username}</div>
							<div class="recommended-user-bio">${user.description?.slice(0, 50) || 'Нет описания'}...</div>
						</div>
						<button class="btn btn-sm btn-primary follow-btn" data-user-id="${user.id}">
							Подписаться
						</button>
					</div>
				`).join('');
				
				// Добавляем обработчики
				container.querySelectorAll('.recommended-user').forEach(item => {
					item.addEventListener('click', (e) => {
						if (!e.target.classList.contains('follow-btn')) {
							const userId = item.dataset.userId;
							showUserProfile(userId);
						}
					});
				});
				
				container.querySelectorAll('.follow-btn').forEach(btn => {
					btn.addEventListener('click', async (e) => {
						e.stopPropagation();
						const userId = btn.dataset.userId;
						await toggleFollow(userId);
					});
				});
				
			} catch (error) {
				console.error('Ошибка загрузки рекомендаций:', error);
				container.innerHTML = '<div class="text-center text-muted py-3">Нет рекомендаций</div>';
			}
		}

		async function loadPopularGroups() {
			const container = document.getElementById('popularGroupsList');
			if (!container) return;
			
			const popular = allGroups
				.sort((a, b) => (b.members_count || 0) - (a.members_count || 0))
				.slice(0, 5);
			
			if (popular.length === 0) {
				container.innerHTML = '<div class="text-center text-muted py-3">Нет групп</div>';
				return;
			}
			
			container.innerHTML = popular.map(group => `
				<div class="online-user" data-group-id="${group.id}">
					<div class="online-user-avatar">
						<span>${group.avatar || '👥'}</span>
					</div>
					<div class="online-user-info">
						<div class="online-user-name">${group.name}</div>
						<div class="online-user-status">${group.members_count || 0} участников</div>
					</div>
				</div>
			`).join('');
			
			// Добавляем обработчики кликов
			container.querySelectorAll('.online-user[data-group-id]').forEach(item => {
				item.addEventListener('click', () => {
					const groupId = item.dataset.groupId;
					showGroupInfo(groupId);
				});
			});
		}

		// ========== РЕНДЕРИНГ ПОСТОВ ==========
		async function renderPosts(posts = allPosts) {
			const container = document.getElementById('postsContainer');
			const emptyFeed = document.getElementById('emptyFeed');
			const loader = document.getElementById('postsLoader');
			
			if (!container) return;
			
			// Скрываем лоадер
			if (loader) loader.classList.add('hidden');
			
			// Очищаем контейнер
			container.innerHTML = '';
			
			if (posts.length === 0) {
				if (emptyFeed) emptyFeed.classList.remove('hidden');
				return;
			}
			
			if (emptyFeed) emptyFeed.classList.add('hidden');
			
			// Рендерим посты
			for (const post of posts) {
				try {
					const postElement = await createPostElement(post);
					if (postElement) {
						container.appendChild(postElement);
					}
				} catch (error) {
					console.error('Ошибка рендеринга поста:', error, post);
				}
			}
			
			// Добавляем обработчики событий
			addPostEventListeners();
		}

		async function createPostElement(post) {
			const template = document.getElementById('postTemplate').innerHTML;
			
			// Получаем информацию о пользователе
			const user = post.user || await getUserById(post.user_id);
			
			// Проверяем лайки
			let isLiked = false;
			if (currentUser && post.likes) {
				isLiked = post.likes.includes(currentUser.id);
			}
			
			// Формируем HTML
			let html = template
				.replace(/\{\{id\}\}/g, post.id)
				.replace(/\{\{isRepost\}\}/g, post.is_repost ? 'true' : '')
				.replace(/\{\{user\.id\}\}/g, user?.id || '')
				.replace(/\{\{user\.username\}\}/g, user?.username || 'Неизвестно')
				.replace(/\{\{user\.emoji\}\}/g, user?.emoji || '😀')
				.replace(/\{\{user\.is_online\}\}/g, onlineUsers.has(user?.id) ? 'true' : '')
				.replace(/\{\{user\.is_verified\}\}/g, user?.is_verified ? 'true' : '')
				.replace(/\{\{created_at\}\}/g, post.created_at)
				.replace(/\{\{timeAgo\}\}/g, formatTimeAgo(post.created_at))
				.replace(/\{\{content\}\}/g, post.content || '')
				.replace(/\{\{hasAttachment\}\}/g, post.media_url ? 'true' : '')
				.replace(/\{\{hasVoice\}\}/g, post.voice_url ? 'true' : '')
				.replace(/\{\{media_url\}\}/g, post.media_url || '')
				.replace(/\{\{media_name\}\}/g, post.media_name || '')
				.replace(/\{\{media_size\}\}/g, formatFileSize(post.media_size || 0))
				.replace(/\{\{media_type\}\}/g, post.media_type || '')
				.replace(/\{\{voice_url\}\}/g, post.voice_url || '')
				.replace(/\{\{voice_duration\}\}/g, formatVoiceDuration(post.voice_duration))
				.replace(/\{\{liked\}\}/g, isLiked ? 'true' : '')
				.replace(/\{\{likes_count\}\}/g, post.likes_count || 0)
				.replace(/\{\{comments_count\}\}/g, post.comments_count || 0)
				.replace(/\{\{reposts_count\}\}/g, post.reposts_count || 0);
			
			// Обработка условных блоков
			html = html.replace(/\{\{#if ([^}]+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, condition, content) => {
				const conditions = {
					'isRepost': post.is_repost,
					'user.is_online': onlineUsers.has(user?.id),
					'user.is_verified': user?.is_verified,
					'hasAttachment': !!post.media_url,
					'hasVoice': !!post.voice_url,
					'liked': isLiked,
					'media_type \'image\'': post.media_type === 'image',
					'media_type \'video\'': post.media_type === 'video',
					'media_type \'audio\'': post.media_type === 'audio'
				};
				
				return conditions[condition] ? content : '';
			});
			
			// Удаляем оставшиеся выражения
			html = html.replace(/\{\{[^}]+\}\}/g, '');
			
			const div = document.createElement('div');
			div.innerHTML = html;
			return div.firstElementChild;
		}

		async function getUserById(userId) {
			if (!userId) return null;
			
			// Ищем в локальном кэше
			let user = allUsers.find(u => u.id === userId);
			
			if (!user && supabaseClient) {
				// Загружаем из базы
				const { data } = await supabaseClient
					.from('users')
					.select('*')
					.eq('id', userId)
					.single();
				
				if (data) {
					user = data;
					allUsers.push(user);
				}
			}
			
			return user || {
				id: userId,
				username: 'Неизвестно',
				emoji: '😀',
				is_verified: false,
				is_online: false
			};
		}

		function addPostEventListeners() {
			// Лайки
			document.querySelectorAll('.like-btn').forEach(btn => {
				btn.addEventListener('click', async (e) => {
					e.stopPropagation();
					const postId = btn.dataset.postId;
					await toggleLike(postId);
				});
			});
			
			// Комментарии
			document.querySelectorAll('.comment-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					e.stopPropagation();
					const postId = btn.dataset.postId;
					const commentsSection = document.getElementById(`comments-${postId}`);
					if (commentsSection) {
						commentsSection.classList.toggle('hidden');
						if (!commentsSection.classList.contains('hidden')) {
							loadComments(postId);
							const commentInput = commentsSection.querySelector('.comment-input');
							if (commentInput) commentInput.focus();
						}
					}
				});
			});
			
			// Репосты
			document.querySelectorAll('.repost-btn').forEach(btn => {
				btn.addEventListener('click', async (e) => {
					e.stopPropagation();
					const postId = btn.dataset.postId;
					await createRepost(postId);
				});
			});
			
			// Поделиться
			document.querySelectorAll('.share-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					e.stopPropagation();
					const postId = btn.dataset.postId;
					const postUrl = `${window.location.origin}?post=${postId}`;
					navigator.clipboard.writeText(postUrl).then(() => {
						showNotification('Успех', 'Ссылка скопирована в буфер обмена', 'success');
					});
				});
			});
			
			// Отправка комментариев
			document.querySelectorAll('.send-comment-btn').forEach(btn => {
				btn.addEventListener('click', async (e) => {
					e.stopPropagation();
					const postId = btn.dataset.postId;
					const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
					if (input && input.value.trim()) {
						await addComment(postId, input.value.trim());
						input.value = '';
					}
				});
			});
			
			// Enter для отправки комментария
			document.querySelectorAll('.comment-input').forEach(input => {
				input.addEventListener('keypress', (e) => {
					if (e.key === 'Enter' && !e.shiftKey) {
						e.preventDefault();
						const postId = input.dataset.postId;
						const btn = document.querySelector(`.send-comment-btn[data-post-id="${postId}"]`);
						if (btn) btn.click();
					}
				});
			});
			
			// Просмотр профиля
			document.querySelectorAll('.view-profile').forEach(el => {
				el.addEventListener('click', (e) => {
					e.stopPropagation();
					const userId = el.dataset.userId;
					if (userId) showUserProfile(userId);
				});
			});
			
			// Воспроизведение голосовых сообщений
			document.querySelectorAll('.voice-play-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					e.stopPropagation();
					const voiceUrl = btn.dataset.voiceUrl;
					if (voiceUrl) {
						const audio = new Audio(voiceUrl);
						audio.play();
					}
				});
			});
			
			// Скачивание файлов
			document.querySelectorAll('.download-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					e.stopPropagation();
					const fileUrl = btn.dataset.fileUrl;
					const fileName = btn.dataset.fileName;
					if (fileUrl && fileName) {
						const link = document.createElement('a');
						link.href = fileUrl;
						link.download = fileName;
						link.click();
					}
				});
			});
			
			// Воспроизведение аудио
			document.querySelectorAll('.play-audio-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					e.stopPropagation();
					const audioUrl = btn.dataset.audioUrl;
					if (audioUrl) {
						const audio = new Audio(audioUrl);
						audio.play();
					}
				});
			});
		}

		// ========== ВЗАИМОДЕЙСТВИЯ С ПОСТАМИ ==========
		async function toggleLike(postId) {
			if (!currentUser || !supabaseClient) {
				showNotification('Ошибка', 'Войдите в систему', 'error');
				return;
			}
			
			try {
				// Проверяем, лайкал ли уже пользователь
				const { data: existingLike, error: checkError } = await supabaseClient
					.from('post_likes')
					.select('id')
					.eq('post_id', postId)
					.eq('user_id', currentUser.id)
					.single();
				
				if (existingLike) {
					// Удаляем лайк
					const { error: deleteError } = await supabaseClient
						.from('post_likes')
						.delete()
						.eq('post_id', postId)
						.eq('user_id', currentUser.id);
					
					if (deleteError) throw deleteError;
					
					// Обновляем интерфейс
					const likeBtn = document.querySelector(`.like-btn[data-post-id="${postId}"]`);
					if (likeBtn) {
						const icon = likeBtn.querySelector('i');
						const count = likeBtn.querySelector('.action-count');
						
						icon.className = 'far fa-heart';
						likeBtn.classList.remove('liked');
						count.textContent = parseInt(count.textContent) - 1;
					}
					
				} else {
					// Добавляем лайк
					const { error: insertError } = await supabaseClient
						.from('post_likes')
						.insert([{
							post_id: postId,
							user_id: currentUser.id
						}]);
					
					if (insertError) throw insertError;
					
					// Обновляем интерфейс
					const likeBtn = document.querySelector(`.like-btn[data-post-id="${postId}"]`);
					if (likeBtn) {
						const icon = likeBtn.querySelector('i');
						const count = likeBtn.querySelector('.action-count');
						
						icon.className = 'fas fa-heart';
						likeBtn.classList.add('liked');
						count.textContent = parseInt(count.textContent) + 1;
					}
					
					// Создаем уведомление
					const post = allPosts.find(p => p.id === postId);
					if (post && post.user_id !== currentUser.id) {
						await createNotification(post.user_id, 'like', postId);
					}
				}
				
			} catch (error) {
				console.error('Ошибка лайка:', error);
				showNotification('Ошибка', 'Не удалось поставить лайк', 'error');
			}
		}

		async function addComment(postId, content) {
			if (!currentUser || !supabaseClient) {
				showNotification('Ошибка', 'Войдите в систему', 'error');
				return;
			}
			
			try {
				// Добавляем комментарий
				const { data: newComment, error } = await supabaseClient
					.from('comments')
					.insert([{
						post_id: postId,
						user_id: currentUser.id,
						content: content
					}])
					.select(`
						*,
						user:users(*)
					`)
					.single();
				
				if (error) throw error;
				
				// Обновляем интерфейс
				const commentsList = document.getElementById(`comments-list-${postId}`);
				if (commentsList) {
					const template = document.getElementById('commentTemplate').innerHTML;
					let html = template
						.replace(/\{\{id\}\}/g, newComment.id)
						.replace(/\{\{user\.id\}\}/g, newComment.user.id)
						.replace(/\{\{user\.username\}\}/g, newComment.user.username)
						.replace(/\{\{user\.emoji\}\}/g, newComment.user.emoji)
						.replace(/\{\{timeAgo\}\}/g, 'только что')
						.replace(/\{\{content\}\}/g, newComment.content);
					
					html = html.replace(/\{\{[^}]+\}\}/g, '');
					
					commentsList.insertAdjacentHTML('beforeend', html);
					
					// Добавляем обработчик клика на профиль
					const newCommentEl = commentsList.lastElementChild;
					newCommentEl.querySelectorAll('.view-profile').forEach(el => {
						el.addEventListener('click', (e) => {
							e.stopPropagation();
							const userId = el.dataset.userId;
							if (userId) showUserProfile(userId);
						});
					});
				}
				
				// Обновляем счетчик комментариев
				const commentBtn = document.querySelector(`.comment-btn[data-post-id="${postId}"]`);
				if (commentBtn) {
					const count = commentBtn.querySelector('.action-count');
					if (count) {
						count.textContent = parseInt(count.textContent) + 1;
					}
				}
				
				// Создаем уведомление
				const post = allPosts.find(p => p.id === postId);
				if (post && post.user_id !== currentUser.id) {
					await createNotification(post.user_id, 'comment', postId);
				}
				
			} catch (error) {
				console.error('Ошибка комментария:', error);
				showNotification('Ошибка', 'Не удалось добавить комментарий', 'error');
			}
		}

		async function loadComments(postId) {
			try {
				const { data: comments, error } = await supabaseClient
					.from('comments')
					.select(`
						*,
						user:users(*)
					`)
					.eq('post_id', postId)
					.order('created_at', { ascending: true });
				
				if (error) throw error;
				
				const container = document.getElementById(`comments-list-${postId}`);
				if (!container) return;
				
				container.innerHTML = '';
				
				if (!comments || comments.length === 0) {
					container.innerHTML = '<div class="text-center text-muted py-3">Нет комментариев</div>';
					return;
				}
				
				comments.forEach(comment => {
					const template = document.getElementById('commentTemplate').innerHTML;
					let html = template
						.replace(/\{\{id\}\}/g, comment.id)
						.replace(/\{\{user\.id\}\}/g, comment.user.id)
						.replace(/\{\{user\.username\}\}/g, comment.user.username)
						.replace(/\{\{user\.emoji\}\}/g, comment.user.emoji)
						.replace(/\{\{timeAgo\}\}/g, formatTimeAgo(comment.created_at))
						.replace(/\{\{content\}\}/g, comment.content);
					
					html = html.replace(/\{\{[^}]+\}\}/g, '');
					
					container.insertAdjacentHTML('beforeend', html);
				});
				
				// Добавляем обработчики клика на профиль
				container.querySelectorAll('.view-profile').forEach(el => {
					el.addEventListener('click', (e) => {
						e.stopPropagation();
						const userId = el.dataset.userId;
						if (userId) showUserProfile(userId);
					});
				});
				
			} catch (error) {
				console.error('Ошибка загрузки комментариев:', error);
			}
		}

		async function createRepost(postId) {
			if (!currentUser || !supabaseClient) {
				showNotification('Ошибка', 'Войдите в систему', 'error');
				return;
			}
			
			try {
				// Получаем оригинальный пост
				const { data: originalPost, error: postError } = await supabaseClient
					.from('posts')
					.select('*')
					.eq('id', postId)
					.single();
				
				if (postError) throw postError;
				
				// Создаем репост
				const { data: newPost, error: repostError } = await supabaseClient
					.from('posts')
					.insert([{
						user_id: currentUser.id,
						content: '',
						original_post_id: postId,
						is_repost: true
					}])
					.select(`
						*,
						user:users(*)
					`)
					.single();
				
				if (repostError) throw repostError;
				
				// Обновляем счетчик репостов
				await supabaseClient
					.from('posts')
					.update({ reposts_count: (originalPost.reposts_count || 0) + 1 })
					.eq('id', postId);
				
				// Обновляем локальный список постов
				allPosts.unshift(newPost);
				
				// Обновляем интерфейс
				renderPosts(allPosts);
				
				// Создаем уведомление
				if (originalPost.user_id !== currentUser.id) {
					await createNotification(originalPost.user_id, 'repost', postId);
				}
				
				showNotification('Успех', 'Пост репостнут!', 'success');
				
			} catch (error) {
				console.error('Ошибка репоста:', error);
				showNotification('Ошибка', 'Не удалось сделать репост', 'error');
			}
		}

		// ========== СОЗДАНИЕ ПОСТА ==========
		async function createPost(content, attachments = {}) {
			if (!currentUser || !supabaseClient) {
				showNotification('Ошибка', 'Войдите в систему', 'error');
				return false;
			}
			
			if (!content.trim() && !attachments.media && !attachments.voice) {
				showNotification('Ошибка', 'Введите текст или добавьте вложение', 'error');
				return false;
			}
			
			try {
				const postData = {
					user_id: currentUser.id,
					content: content.trim(),
					created_at: new Date().toISOString()
				};
				
				// Обработка медиа файла
				if (attachments.media) {
					const file = attachments.media;
					const fileExt = file.name.split('.').pop().toLowerCase();
					
					// Определяем тип медиа
					let mediaType = 'file';
					if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt)) {
						mediaType = 'image';
					} else if (['mp4', 'webm', 'mov'].includes(fileExt)) {
						mediaType = 'video';
					} else if (['mp3', 'wav', 'ogg'].includes(fileExt)) {
						mediaType = 'audio';
					}
					
					// Для демо-режима создаем Blob URL
					postData.media_url = URL.createObjectURL(file);
					postData.media_type = mediaType;
					postData.media_name = file.name;
					postData.media_size = file.size;
				}
				
				// Обработка голосового сообщения
				if (attachments.voice) {
					postData.voice_url = attachments.voice.url;
					postData.voice_duration = attachments.voice.duration;
				}
				
				// Исправленный запрос: убираем SELECT из INSERT запроса
				const { data: newPost, error: postError } = await supabaseClient
					.from('posts')
					.insert([postData]);
				
				if (postError) throw postError;
				
				// Получаем созданный пост с информацией о пользователе
				const { data: fullPost, error: fetchError } = await supabaseClient
					.from('posts')
					.select(`
						*,
						user:users(*)
					`)
					.eq('user_id', currentUser.id)
					.order('created_at', { ascending: false })
					.limit(1)
					.single();
				
				if (fetchError) throw fetchError;
				
				// Обновляем локальный список постов
				allPosts.unshift(fullPost);
				
				// Обновляем интерфейс
				updateUI();
				renderPosts(allPosts);
				
				// Очищаем форму
				const postText = document.getElementById('postText');
				const attachmentsContainer = document.getElementById('postAttachments');
				if (postText) postText.value = '';
				if (attachmentsContainer) {
					attachmentsContainer.innerHTML = '';
					attachmentsContainer.classList.add('hidden');
				}
				
				// Сбрасываем выбранные файлы
				selectedFile = null;
				selectedVoice = null;
				
				showNotification('Успех', 'Пост опубликован!', 'success');
				return true;
				
			} catch (error) {
				console.error('Ошибка создания поста:', error);
				showNotification('Ошибка', 'Не удалось опубликовать пост', 'error');
				return false;
			}
		}

		// ========== УПРАВЛЕНИЕ ПРОФИЛЕМ ==========
		async function showUserProfile(userId) {
			try {
				if (!supabaseClient) {
					showNotification('Ошибка', 'База данных не доступна', 'error');
					return;
				}
				
				// Загружаем данные пользователя
				const { data: user, error } = await supabaseClient
					.from('users')
					.select('*')
					.eq('id', userId)
					.single();
				
				if (error || !user) {
					showNotification('Ошибка', 'Пользователь не найден', 'error');
					return;
				}
				
				// Загружаем количество подписчиков
				const { count: followersCount, error: followersError } = await supabaseClient
					.from('followers')
					.select('*', { count: 'exact', head: true })
					.eq('user_id', userId);
				
				// Загружаем количество подписок
				const { count: followingCount, error: followingError } = await supabaseClient
					.from('followers')
					.select('*', { count: 'exact', head: true })
					.eq('follower_id', userId);
				
				user.followers_count = followersCount || 0;
				user.following_count = followingCount || 0;
				
				// Проверяем, подписан ли текущий пользователь
				let isFollowing = false;
				if (currentUser) {
					const { data: isFollowingData } = await supabaseClient
						.from('followers')
						.select('id')
						.eq('user_id', userId)
						.eq('follower_id', currentUser.id)
						.single();
					
					isFollowing = !!isFollowingData;
				}
				
				// Загружаем посты пользователя
				const { data: posts } = await supabaseClient
					.from('posts')
					.select(`
						*,
						user:users(*)
					`)
					.eq('user_id', userId)
					.is('is_repost', false)
					.order('created_at', { ascending: false });
				
				// Загружаем репосты пользователя
				const { data: reposts } = await supabaseClient
					.from('posts')
					.select(`
						*,
						user:users(*),
						original_post:posts!original_post_id(*)
					`)
					.eq('user_id', userId)
					.eq('is_repost', true)
					.order('created_at', { ascending: false });
				
				// Рендерим страницу профиля
				renderProfilePage(user, posts || [], reposts || [], isFollowing);
				
			} catch (error) {
				console.error('Ошибка загрузки профиля:', error);
				showNotification('Ошибка', 'Не удалось загрузить профиль', 'error');
				showPage('feed');
			}
		}

		async function renderProfilePage(user, posts, reposts, isFollowing) {
			const profilePage = document.getElementById('profilePage');
			const container = document.getElementById('profileContainer');
			
			if (!profilePage || !container) return;
			
			const isOwnProfile = currentUser && currentUser.id === user.id;
			
			// Загружаем шаблон
			const template = document.getElementById('profileTemplate').innerHTML;
			let html = template
				.replace(/\{\{id\}\}/g, user.id)
				.replace(/\{\{username\}\}/g, user.username)
				.replace(/\{\{display_name\}\}/g, user.display_name)
				.replace(/\{\{emoji\}\}/g, user.emoji)
				.replace(/\{\{description\}\}/g, user.description || 'Пользователь пока ничего не написал в описании')
				.replace(/\{\{avatar_color\}\}/g, user.avatar_color || '#6366f1')
				.replace(/\{\{is_own_profile\}\}/g, isOwnProfile ? 'true' : '')
				.replace(/\{\{is_following\}\}/g, isFollowing ? 'true' : '')
				.replace(/\{\{is_online\}\}/g, onlineUsers.has(user.id) ? 'true' : '')
				.replace(/\{\{is_verified\}\}/g, user.is_verified ? 'true' : '')
				.replace(/\{\{posts_count\}\}/g, user.posts_count || 0)
				.replace(/\{\{followers_count\}\}/g, user.followers_count || 0)
				.replace(/\{\{following_count\}\}/g, user.following_count || 0)
				.replace(/\{\{reposts_count\}\}/g, reposts.length)
				.replace(/\{\{clan\}\}/g, user.clan || '😀');  // Исправлено: используем user.clan
			
			// Обработка условных блоков
			html = html.replace(/\{\{#if ([^}]+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, condition, content) => {
				const conditions = {
					'is_own_profile': isOwnProfile,
					'is_following': isFollowing,
					'is_online': onlineUsers.has(user.id),
					'is_verified': user.is_verified
				};
				
				return conditions[condition] ? content : '';
			});
			
			html = html.replace(/\{\{[^}]+\}\}/g, '');
			
			container.innerHTML = html;
			
			// Скрываем все страницы и показываем профиль
			hideAllPages();
			profilePage.classList.remove('hidden');
			
			// Убираем активный класс у всех навигационных ссылок
			document.querySelectorAll('.nav-link').forEach(link => {
				link.classList.remove('active');
			});
			
			// Рендерим посты пользователя
			const postsContainer = document.getElementById('profilePostsContainer');
			if (postsContainer) {
				if (posts.length > 0) {
					postsContainer.innerHTML = '';
					for (const post of posts) {
						const postElement = await createPostElement(post);
						if (postElement) {
							postsContainer.appendChild(postElement);
						}
					}
					addPostEventListeners();
				} else {
					postsContainer.innerHTML = '<div class="text-center py-5 text-muted">Нет публикаций</div>';
				}
			}
			
			// Рендерим репосты
			const repostsContainer = document.getElementById('profileRepostsContainer');
			if (repostsContainer) {
				if (reposts.length > 0) {
					repostsContainer.innerHTML = '';
					for (const repost of reposts) {
						const postElement = await createPostElement(repost);
						if (postElement) {
							repostsContainer.appendChild(postElement);
						}
					}
					addPostEventListeners();
				} else {
					repostsContainer.innerHTML = '<div class="text-center py-5 text-muted">Нет репостов</div>';
				}
			}
			
			// Инициализируем вкладки
			setupProfileTabs(user.id);
			
			// Добавляем обработчики событий
			setupProfileEventListeners(user.id, isOwnProfile, isFollowing);
		}

		function setupProfileTabs(userId) {
			// Обработчики для вкладок профиля
			document.querySelectorAll('.profile-tabs .tab').forEach(tab => {
				tab.addEventListener('click', async () => {
					const tabName = tab.dataset.tab;
					
					// Активируем таб
					document.querySelectorAll('.profile-tabs .tab').forEach(t => t.classList.remove('active'));
					document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
					
					tab.classList.add('active');
					
					const tabPaneId = `profile${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`;
					const tabPane = document.getElementById(tabPaneId);
					if (tabPane) {
						tabPane.classList.add('active');
					}
					
					// Загружаем данные для активной вкладки
					switch (tabName) {
						case 'media':
							await loadMediaTab(userId);
							break;
						case 'followers':
							await loadFollowersTab(userId);
							break;
						case 'following':
							await loadFollowingTab(userId);
							break;
					}
				});
			});
		}

		async function loadMediaTab(userId) {
			const container = document.getElementById('profileMediaContainer');
			if (!container) return;
			
			try {
				const { data: mediaPosts, error } = await supabaseClient
					.from('posts')
					.select('*')
					.eq('user_id', userId)
					.not('media_url', 'is', null)
					.order('created_at', { ascending: false });
				
				if (error) throw error;
				
				if (!mediaPosts || mediaPosts.length === 0) {
					container.innerHTML = '<div class="text-center py-5 text-muted">Нет медиа</div>';
					return;
				}
				
				container.innerHTML = '';
				for (const post of mediaPosts) {
					if (post.media_type === 'image') {
						const img = document.createElement('img');
						img.src = post.media_url;
						img.className = 'media-item';
						img.dataset.postId = post.id;
						img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer;';
						img.addEventListener('click', () => {
							// Можно реализовать просмотр медиа в полном размере
							window.open(post.media_url, '_blank');
						});
						container.appendChild(img);
					}
				}
				
			} catch (error) {
				console.error('Ошибка загрузки медиа:', error);
				container.innerHTML = '<div class="text-center py-5 text-muted">Ошибка загрузки медиа</div>';
			}
		}

		async function loadFollowersTab(userId) {
			const container = document.getElementById('profileFollowersContainer');
			if (!container) return;
			
			try {
				const { data: followers, error } = await supabaseClient
					.from('followers')
					.select(`
						follower:users!followers_follower_id_fkey(*)
					`)
					.eq('user_id', userId);
				
				if (error) throw error;
				
				if (!followers || followers.length === 0) {
					container.innerHTML = '<div class="text-center py-5 text-muted">Нет подписчиков</div>';
					return;
				}
				
				const users = followers.map(f => f.follower);
				container.innerHTML = users.map(user => `
					<div class="user-item" data-user-id="${user.id}">
						<div class="d-flex align-center gap-3 p-3">
							<div class="user-avatar">
								<span>${user.emoji}</span>
								${onlineUsers.has(user.id) ? '<div class="status-indicator status-online"></div>' : ''}
							</div>
							<div class="flex-1">
								<div class="font-weight-medium">${user.username}</div>
								<div class="text-muted small">${user.display_name}</div>
							</div>
							${currentUser && currentUser.id !== user.id ? 
								`<button class="btn btn-sm btn-primary follow-btn" data-user-id="${user.id}">Подписаться</button>` : 
								''}
						</div>
					</div>
				`).join('');
				
				// Добавляем обработчики
				container.querySelectorAll('.user-item').forEach(item => {
					item.addEventListener('click', (e) => {
						if (!e.target.classList.contains('follow-btn')) {
							const userId = item.dataset.userId;
							showUserProfile(userId);
						}
					});
				});
				
				container.querySelectorAll('.follow-btn').forEach(btn => {
					btn.addEventListener('click', async (e) => {
						e.stopPropagation();
						const userId = btn.dataset.userId;
						await toggleFollow(userId);
					});
				});
				
			} catch (error) {
				console.error('Ошибка загрузки подписчиков:', error);
				container.innerHTML = '<div class="text-center py-5 text-muted">Ошибка загрузки подписчиков</div>';
			}
		}

		async function loadFollowingTab(userId) {
			const container = document.getElementById('profileFollowingContainer');
			if (!container) return;
			
			try {
				const { data: following, error } = await supabaseClient
					.from('followers')
					.select(`
						user:users!followers_user_id_fkey(*)
					`)
					.eq('follower_id', userId);
				
				if (error) throw error;
				
				if (!following || following.length === 0) {
					container.innerHTML = '<div class="text-center py-5 text-muted">Нет подписок</div>';
					return;
				}
				
				const users = following.map(f => f.user);
				container.innerHTML = users.map(user => `
					<div class="user-item" data-user-id="${user.id}">
						<div class="d-flex align-center gap-3 p-3">
							<div class="user-avatar">
								<span>${user.emoji}</span>
								${onlineUsers.has(user.id) ? '<div class="status-indicator status-online"></div>' : ''}
							</div>
							<div class="flex-1">
								<div class="font-weight-medium">${user.username}</div>
								<div class="text-muted small">${user.display_name}</div>
							</div>
							${currentUser && currentUser.id !== user.id ? 
								`<button class="btn btn-sm btn-primary follow-btn" data-user-id="${user.id}">Подписаться</button>` : 
								''}
						</div>
					</div>
				`).join('');
				
				// Добавляем обработчики
				container.querySelectorAll('.user-item').forEach(item => {
					item.addEventListener('click', (e) => {
						if (!e.target.classList.contains('follow-btn')) {
							const userId = item.dataset.userId;
							showUserProfile(userId);
						}
					});
				});
				
				container.querySelectorAll('.follow-btn').forEach(btn => {
					btn.addEventListener('click', async (e) => {
						e.stopPropagation();
						const userId = btn.dataset.userId;
						await toggleFollow(userId);
					});
				});
				
			} catch (error) {
				console.error('Ошибка загрузки подписок:', error);
				container.innerHTML = '<div class="text-center py-5 text-muted">Ошибка загрузки подписок</div>';
			}
		}

		function setupProfileEventListeners(userId, isOwnProfile, isFollowing) {
			// Кнопка подписки
			const followBtn = document.querySelector('.follow-btn');
			if (followBtn && !isOwnProfile) {
				followBtn.addEventListener('click', async () => {
					await toggleFollow(userId);
				});
			}
			
			// Кнопка сообщения
			const messageBtn = document.querySelector('.message-btn');
			if (messageBtn && !isOwnProfile) {
				messageBtn.addEventListener('click', () => {
					startConversation(userId);
				});
			}
			
			// Кнопка редактирования
			const editBtn = document.querySelector('#profileEditBtn');
			if (editBtn && isOwnProfile) {
				editBtn.addEventListener('click', () => {
					showEditProfileModal();
				});
			}
			
			// Кнопка поделиться профилем
			const shareBtn = document.querySelector('#profileShareBtn');
			if (shareBtn && isOwnProfile) {
				shareBtn.addEventListener('click', () => {
					const profileUrl = `${window.location.origin}?user=${userId}`;
					navigator.clipboard.writeText(profileUrl).then(() => {
						showNotification('Успех', 'Ссылка на профиль скопирована', 'success');
					});
				});
			}
			
			// Кнопка пожаловаться
			const reportBtn = document.querySelector('#profileReportBtn');
			if (reportBtn && !isOwnProfile) {
				reportBtn.addEventListener('click', () => {
					showReportModal(userId);
				});
			}
		}

		async function toggleFollow(userId) {
			if (!currentUser || !supabaseClient) {
				showNotification('Ошибка', 'Войдите в систему', 'error');
				return;
			}
			
			try {
				// Проверяем, подписан ли уже пользователь
				const { data: existingFollow, error: checkError } = await supabaseClient
					.from('followers')
					.select('id')
					.eq('user_id', userId)
					.eq('follower_id', currentUser.id)
					.single();
				
				if (existingFollow) {
					// Удаляем подписку
					const { error: deleteError } = await supabaseClient
						.from('followers')
						.delete()
						.eq('user_id', userId)
						.eq('follower_id', currentUser.id);
					
					if (deleteError) throw deleteError;
					
					// Обновляем интерфейс
					const followBtn = document.querySelector(`.follow-btn[data-user-id="${userId}"]`);
					if (followBtn) {
						followBtn.innerHTML = '<i class="fas fa-user-plus"></i> Подписаться';
						followBtn.classList.remove('btn-danger');
						followBtn.classList.add('btn-primary');
					}
					
					// Обновляем счетчики
					await updateFollowCounters(userId, false);
					
					showNotification('Успех', 'Вы отписались', 'info');
					
				} else {
					// Добавляем подписку
					const { error: insertError } = await supabaseClient
						.from('followers')
						.insert([{
							user_id: userId,
							follower_id: currentUser.id
						}]);
					
					if (insertError) throw insertError;
					
					// Обновляем интерфейс
					const followBtn = document.querySelector(`.follow-btn[data-user-id="${userId}"]`);
					if (followBtn) {
						followBtn.innerHTML = '<i class="fas fa-user-minus"></i> Отписаться';
						followBtn.classList.remove('btn-primary');
						followBtn.classList.add('btn-danger');
					}
					
					// Обновляем счетчики
					await updateFollowCounters(userId, true);
					
					// Создаем уведомление
					await createNotification(userId, 'follow');
					
					showNotification('Успех', 'Вы подписались', 'success');
				}
				
			} catch (error) {
				console.error('Ошибка подписки:', error);
				showNotification('Ошибка', 'Не удалось выполнить действие', 'error');
			}
		}

		async function updateFollowCounters(userId, isFollow) {
			try {
				// Обновляем у пользователя, на которого подписались
				const { data: user } = await supabaseClient
					.from('users')
					.select('followers_count')
					.eq('id', userId)
					.single();
				
				if (user) {
					const newFollowersCount = isFollow ? (user.followers_count || 0) + 1 : Math.max((user.followers_count || 0) - 1, 0);
					
					await supabaseClient
						.from('users')
						.update({
							followers_count: newFollowersCount
						})
						.eq('id', userId);
					
					// Обновляем у пользователя, на которого подписались
					const followersCountEl = document.getElementById('followersCount');
					if (followersCountEl) {
						followersCountEl.textContent = newFollowersCount;
					}
				}
				
				// Обновляем количество подписок у текущего пользователя
				const { data: current } = await supabaseClient
					.from('users')
					.select('following_count')
					.eq('id', currentUser.id)
					.single();
				
				if (current) {
					const newFollowingCount = isFollow ? (current.following_count || 0) + 1 : Math.max((current.following_count || 0) - 1, 0);
					
					await supabaseClient
						.from('users')
						.update({
							following_count: newFollowingCount
						})
						.eq('id', currentUser.id);
					
					// Обновляем у текущего пользователя
					currentUser.following_count = newFollowingCount;
					
					const followingCountEl = document.getElementById('followingCount');
					if (followingCountEl) {
						followingCountEl.textContent = newFollowingCount;
					}
				}
				
			} catch (error) {
				console.error('Ошибка обновления счетчиков:', error);
			}
		}

		// ========== СИСТЕМА СООБЩЕНИЙ ==========
		async function renderConversations() {
			const container = document.getElementById('messagesContainer');
			if (!container) return;
			
			if (!conversations || conversations.length === 0) {
				container.innerHTML = `
					<div class="conversations-sidebar">
						<div class="conversations-header">
							<h3>Диалоги</h3>
						</div>
						<div class="conversations-list">
							<div class="text-center py-5 text-muted">Нет диалогов</div>
						</div>
					</div>
					<div class="messages-area">
						<div class="messages-header">
							<div class="chat-user-info">
								<div class="chat-user-avatar">
									<span>💬</span>
								</div>
								<div class="chat-user-details">
									<h3>Выберите диалог</h3>
									<p>Начните общение</p>
								</div>
							</div>
						</div>
						<div class="messages-list">
							<div class="text-center py-5 text-muted">
								<i class="fas fa-comments icon-xl mb-3"></i>
								<p>Выберите диалог для начала общения</p>
							</div>
						</div>
					</div>
				`;
				return;
			}
			
			let conversationsHTML = '';
			for (const conv of conversations) {
				conversationsHTML += `
					<div class="conversation-item" data-conversation-id="${conv.id}">
						<div class="conversation-avatar">
							<span>${conv.avatar || '👤'}</span>
							${conv.is_online ? '<div class="status-indicator status-online"></div>' : ''}
						</div>
						<div class="conversation-info">
							<div class="conversation-name">
								${conv.name || 'Диалог'}
							</div>
							<div class="conversation-last-message">${conv.last_message || 'Нет сообщений'}</div>
						</div>
						<div class="conversation-time">${formatTimeAgo(conv.last_message_at)}</div>
					</div>
				`;
			}
			
			container.innerHTML = `
				<div class="conversations-sidebar">
					<div class="conversations-header">
						<h3>Диалоги</h3>
					</div>
					<div class="conversations-list">
						${conversationsHTML}
					</div>
				</div>
				<div class="messages-area">
					<div class="messages-header">
						<div class="chat-user-info">
							<div class="chat-user-avatar">
								<span>💬</span>
							</div>
							<div class="chat-user-details">
								<h3>Выберите диалог</h3>
								<p>Начните общение</p>
							</div>
						</div>
					</div>
					<div class="messages-list" id="messagesList">
						<div class="text-center py-5 text-muted">
							<i class="fas fa-comments icon-xl mb-3"></i>
							<p>Выберите диалог для начала общения</p>
						</div>
					</div>
					<div class="message-input-container hidden" id="messageInputContainer">
						<div class="message-input-wrapper">
							<div class="message-attachments">
								<button class="btn-icon" id="addMessageFileBtn" title="Добавить файл">
									<i class="fas fa-paperclip"></i>
								</button>
								<button class="btn-icon" id="addMessageVoiceBtn" title="Голосовое сообщение">
									<i class="fas fa-microphone"></i>
								</button>
							</div>
							<textarea class="message-input" placeholder="Написать сообщение..." id="messageInput"></textarea>
							<button class="btn btn-primary" id="sendMessageBtn">
								<i class="fas fa-paper-plane"></i>
							</button>
						</div>
					</div>
				</div>
			`;
			
			// Добавляем обработчики для диалогов
			document.querySelectorAll('.conversation-item').forEach(item => {
				item.addEventListener('click', () => {
					const conversationId = item.dataset.conversationId;
					openConversation(conversationId);
				});
			});
			
			// Обработчик отправки сообщения
			const sendMessageBtn = document.getElementById('sendMessageBtn');
			const messageInput = document.getElementById('messageInput');
			
			if (sendMessageBtn && messageInput) {
				sendMessageBtn.addEventListener('click', async () => {
					if (messageInput.value.trim() && currentConversation) {
						await sendMessage(messageInput.value.trim());
						messageInput.value = '';
					}
				});
				
				messageInput.addEventListener('keypress', (e) => {
					if (e.key === 'Enter' && !e.shiftKey && currentConversation) {
						e.preventDefault();
						sendMessageBtn.click();
					}
				});
			}
		}

		async function openConversation(conversationId) {
			try {
				const conversation = conversations.find(c => c.id === conversationId);
				if (!conversation) return;
				
				currentConversation = conversation;
				
				// Показываем поле ввода
				const messageInputContainer = document.getElementById('messageInputContainer');
				if (messageInputContainer) {
					messageInputContainer.classList.remove('hidden');
				}
				
				// Обновляем заголовок
				const messagesHeader = document.querySelector('.messages-header .chat-user-details');
				if (messagesHeader) {
					messagesHeader.innerHTML = `
						<h3>${conversation.name || 'Диалог'}</h3>
						<p>${conversation.is_online ? 'В сети' : 'Был(а) недавно'}</p>
					`;
				}
				
				// Загружаем сообщения
				await loadMessages(conversationId);
				
				// Помечаем диалог как активный
				document.querySelectorAll('.conversation-item').forEach(item => {
					item.classList.remove('active');
				});
				const activeItem = document.querySelector(`.conversation-item[data-conversation-id="${conversationId}"]`);
				if (activeItem) {
					activeItem.classList.add('active');
				}
				
			} catch (error) {
				console.error('Ошибка загрузки сообщений:', error);
				showNotification('Ошибка', 'Не удалось загрузить сообщения', 'error');
			}
		}

		async function loadMessages(conversationId) {
			try {
				const { data: messages, error } = await supabaseClient
					.from('messages')
					.select('*')
					.eq('conversation_id', conversationId)
					.order('created_at', { ascending: true });
				
				if (error) throw error;
				
				currentMessages = messages || [];
				renderMessages();
				
			} catch (error) {
				console.error('Ошибка загрузки сообщений:', error);
			}
		}

		function renderMessages() {
			const container = document.getElementById('messagesList');
			if (!container) return;
			
			container.innerHTML = '';
			
			if (!currentMessages || currentMessages.length === 0) {
				container.innerHTML = '<div class="text-center py-5 text-muted">Нет сообщений</div>';
				return;
			}
			
			currentMessages.forEach(message => {
				const isOutgoing = message.sender_id === currentUser.id;
				
				let messageHTML = `
					<div class="message ${isOutgoing ? 'outgoing' : ''}" data-message-id="${message.id}">
						<div class="message-content">
							${message.content || ''}
				`;
				
				// Добавляем медиа файл если есть
				if (message.media_url) {
					if (message.media_type === 'image') {
						messageHTML += `<img src="${message.media_url}" class="mt-2" style="max-width: 200px; border-radius: 8px;">`;
					} else if (message.media_type === 'file') {
						messageHTML += `
							<div class="mt-2">
								<a href="${message.media_url}" download="${message.media_name}" class="d-flex align-center gap-2">
									<i class="fas fa-paperclip"></i>
									<span>${message.media_name}</span>
								</a>
							</div>
						`;
					}
				}
				
				messageHTML += `
							<div class="message-time">${formatTimeAgo(message.created_at)}</div>
						</div>
					</div>
				`;
				
				container.innerHTML += messageHTML;
			});
			
			// Прокручиваем вниз
			container.scrollTop = container.scrollHeight;
		}

		async function sendMessage(content) {
			if (!currentUser || !currentConversation || !supabaseClient) return;
			
			try {
				// Создаем сообщение
				const { data: newMessage, error } = await supabaseClient
					.from('messages')
					.insert([{
						conversation_id: currentConversation.id,
						sender_id: currentUser.id,
						content: content
					}])
					.select()
					.single();
				
				if (error) throw error;
				
				// Обновляем последнее сообщение в диалоге
				await supabaseClient
					.from('conversations')
					.update({
						last_message: content.length > 50 ? content.substring(0, 50) + '...' : content,
						last_message_at: new Date().toISOString()
					})
					.eq('id', currentConversation.id);
				
				// Обновляем локальный список сообщений
				currentMessages.push(newMessage);
				
				// Обновляем интерфейс
				renderMessages();
				
				// Перезагружаем список диалогов
				await loadConversations();
				
				return true;
				
			} catch (error) {
				console.error('Ошибка отправки сообщения:', error);
				showNotification('Ошибка', 'Не удалось отправить сообщение', 'error');
				return false;
			}
		}

		async function startConversation(userId) {
			if (!currentUser || !supabaseClient) {
				showNotification('Ошибка', 'Войдите в систему', 'error');
				return;
			}
			
			try {
				// Исправленный запрос создания диалога
				const { data: newConversation, error: convError } = await supabaseClient
					.from('conversations')
					.insert([{
						is_group: false,
						last_message: 'Диалог начат',
						last_message_at: new Date().toISOString()
					}])
					.select()
					.single();
				
				if (convError) throw convError;
				
				// Добавляем участников
				await supabaseClient
					.from('conversation_participants')
					.insert([
						{ conversation_id: newConversation.id, user_id: currentUser.id },
						{ conversation_id: newConversation.id, user_id: userId }
					]);
				
				// Добавляем диалог в локальный список
				const otherUser = allUsers.find(u => u.id === userId);
				if (otherUser) {
					newConversation.name = otherUser.display_name;
					newConversation.avatar = otherUser.emoji;
					newConversation.is_online = otherUser.is_online;
					conversations.unshift(newConversation);
				}
				
				// Переходим в сообщения и открываем диалог
				showPage('messages');
				await openConversation(newConversation.id);
				
			} catch (error) {
				console.error('Ошибка создания диалога:', error);
				showNotification('Ошибка', 'Не удалось начать диалог', 'error');
			}
		}

		// ========== УВЕДОМЛЕНИЯ ==========
		async function createNotification(userId, type, postId = null) {
			if (!currentUser || !supabaseClient) return;
			
			try {
				let message = '';
				switch (type) {
					case 'like':
						message = `${currentUser.username} поставил(а) лайк вашему посту`;
						break;
					case 'comment':
						message = `${currentUser.username} прокомментировал(а) ваш пост`;
						break;
					case 'repost':
						message = `${currentUser.username} репостнул(а) ваш пост`;
						break;
					case 'follow':
						message = `${currentUser.username} подписался(ась) на вас`;
						break;
					default:
						return;
				}
				
				await supabaseClient
					.from('notifications')
					.insert([{
						user_id: userId,
						from_user_id: currentUser.id,
						post_id: postId,
						type: type,
						message: message
					}]);
				
			} catch (error) {
				console.error('Ошибка создания уведомления:', error);
			}
		}

		function renderNotifications() {
			const container = document.getElementById('notificationsList');
			if (!container) return;
			
			if (notifications.length === 0) {
				container.innerHTML = '<div class="text-center py-5 text-muted">Нет уведомлений</div>';
				return;
			}
			
			container.innerHTML = notifications.map(notification => {
				const fromUser = notification.from_user || { username: 'Неизвестно', emoji: '😀' };
				return `
					<div class="notification-item ${notification.is_read ? '' : 'unread'}" data-notification-id="${notification.id}">
						<div class="d-flex align-start gap-3 p-3 border-bottom">
							<div class="user-avatar">
								<span>${fromUser.emoji}</span>
							</div>
							<div class="flex-1">
								<div class="mb-1">${notification.message}</div>
								<div class="text-muted small">${formatTimeAgo(notification.created_at)}</div>
							</div>
							${!notification.is_read ? '<span class="badge">новое</span>' : ''}
						</div>
					</div>
				`;
			}).join('');
			
			// Добавляем обработчики
			container.querySelectorAll('.notification-item').forEach(item => {
				item.addEventListener('click', async () => {
					const notificationId = item.dataset.notificationId;
					await markNotificationAsRead(notificationId);
				});
			});
		}

		async function markNotificationAsRead(notificationId) {
			if (!supabaseClient) return;
			
			try {
				await supabaseClient
					.from('notifications')
					.update({ is_read: true })
					.eq('id', notificationId);
				
				// Обновляем локально
				const notification = notifications.find(n => n.id === notificationId);
				if (notification) {
					notification.is_read = true;
				}
				
				// Обновляем интерфейс
				renderNotifications();
				await loadNotifications();
				
			} catch (error) {
				console.error('Ошибка отметки уведомления:', error);
			}
		}

		// ========== РАБОТА С ФАЙЛАМИ ==========
		function handleFileSelect(event) {
			const file = event.target.files[0];
			if (!file) return;
			
			selectedFile = file;
			
			// Показываем превью
			const preview = document.getElementById('filePreview');
			const previewImage = document.getElementById('previewImage');
			const previewFileInfo = document.getElementById('previewFileInfo');
			const uploadBtn = document.getElementById('uploadFileBtn');
			
			if (preview && previewImage && previewFileInfo && uploadBtn) {
				preview.classList.remove('hidden');
				uploadBtn.classList.remove('hidden');
				
				if (file.type.startsWith('image/')) {
					const reader = new FileReader();
					reader.onload = function(e) {
						previewImage.src = e.target.result;
						previewImage.classList.remove('hidden');
					};
					reader.readAsDataURL(file);
				} else {
					previewImage.classList.add('hidden');
				}
				
				previewFileInfo.innerHTML = `
					<div class="text-center">
						<div class="font-weight-medium">${file.name}</div>
						<div class="text-muted small">${formatFileSize(file.size)} • ${file.type}</div>
					</div>
				`;
			}
		}

		function uploadFileToPost() {
			if (!selectedFile) return;
			
			// Добавляем файл в пост
			const attachmentsContainer = document.getElementById('postAttachments');
			if (attachmentsContainer) {
				const fileExt = selectedFile.name.split('.').pop().toLowerCase();
				const isAudio = ['mp3', 'wav', 'ogg'].includes(fileExt);
				const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
				const isVideo = ['mp4', 'webm', 'mov'].includes(fileExt);
				
				let previewHTML = '';
				
				if (isAudio) {
					const audioUrl = URL.createObjectURL(selectedFile);
					previewHTML = `
						<div class="audio-player">
							<div class="audio-info">${selectedFile.name}</div>
							<audio controls style="width:100%;">
								<source src="${audioUrl}" type="audio/mpeg">
							</audio>
						</div>
					`;
				} else if (isImage) {
					const imageUrl = URL.createObjectURL(selectedFile);
					previewHTML = `<img src="${imageUrl}" class="w-100 rounded" style="max-height: 200px; object-fit: cover;">`;
				} else if (isVideo) {
					const videoUrl = URL.createObjectURL(selectedFile);
					previewHTML = `
						<video controls class="w-100 rounded" style="max-height: 200px;">
							<source src="${videoUrl}" type="video/mp4">
						</video>
					`;
				} else {
					previewHTML = `
						<div class="d-flex align-center justify-between">
							<div class="d-flex align-center gap-3">
								<i class="fas fa-file text-primary icon-lg"></i>
								<div>
									<div class="font-weight-medium">${selectedFile.name}</div>
									<div class="text-muted small">${formatFileSize(selectedFile.size)}</div>
								</div>
							</div>
							<button class="btn btn-sm btn-primary download-btn" 
									data-file-url="${URL.createObjectURL(selectedFile)}" 
									data-file-name="${selectedFile.name}">
								<i class="fas fa-download"></i>
							</button>
						</div>
					`;
				}
				
				attachmentsContainer.innerHTML = `
					<div class="card">
						<div class="card-body">
							${previewHTML}
							<button class="btn btn-sm btn-danger w-100 mt-3" id="removeFileBtn">
								<i class="fas fa-times"></i> Удалить
							</button>
						</div>
					</div>
				`;
				attachmentsContainer.classList.remove('hidden');
				
				// Обработчик удаления файла
				document.getElementById('removeFileBtn').addEventListener('click', () => {
					selectedFile = null;
					attachmentsContainer.innerHTML = '';
					attachmentsContainer.classList.add('hidden');
				});
			}
			
			// Закрываем модалку
			document.getElementById('fileModal').classList.remove('active');
		}

		// ========== ГОЛОСОВЫЕ СООБЩЕНИЯ ==========
		async function startRecording() {
			try {
				const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
				mediaRecorder = new MediaRecorder(stream);
				audioChunks = [];
				
				mediaRecorder.ondataavailable = (event) => {
					if (event.data.size > 0) {
						audioChunks.push(event.data);
					}
				};
				
				mediaRecorder.onstop = () => {
					const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
					const audioUrl = URL.createObjectURL(audioBlob);
					
					// Показываем превью
					const audioPreview = document.getElementById('voicePreview');
					if (audioPreview) {
						audioPreview.src = audioUrl;
						audioPreview.classList.remove('hidden');
					}
					
					selectedVoice = {
						blob: audioBlob,
						duration: recordingSeconds,
						url: audioUrl
					};
					
					// Показываем кнопку отправки
					const sendBtn = document.getElementById('sendVoiceBtn');
					if (sendBtn) sendBtn.classList.remove('hidden');
				};
				
				mediaRecorder.start();
				isRecording = true;
				recordingSeconds = 0;
				
				// Обновляем интерфейс
				const recordBtn = document.getElementById('recordVoiceBtn');
				if (recordBtn) {
					recordBtn.innerHTML = '<i class="fas fa-stop"></i> Остановить запись';
					recordBtn.classList.remove('btn-primary');
					recordBtn.classList.add('btn-danger');
				}
				
				// Запускаем таймер
				recordingTimer = setInterval(() => {
					recordingSeconds++;
					const recordingTime = document.getElementById('recordingTime');
					if (recordingTime) {
						const minutes = Math.floor(recordingSeconds / 60);
						const seconds = recordingSeconds % 60;
						recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
					}
				}, 1000);
				
			} catch (error) {
				console.error('Ошибка записи:', error);
				showNotification('Ошибка', 'Не удалось получить доступ к микрофону', 'error');
			}
		}

		function stopRecording() {
			if (!isRecording || !mediaRecorder) return;
			
			mediaRecorder.stop();
			isRecording = false;
			clearInterval(recordingTimer);
			
			// Обновляем интерфейс
			const recordBtn = document.getElementById('recordVoiceBtn');
			const sendBtn = document.getElementById('sendVoiceBtn');
			
			if (recordBtn) {
				recordBtn.innerHTML = '<i class="fas fa-microphone"></i> Начать запись';
				recordBtn.classList.remove('btn-danger');
				recordBtn.classList.add('btn-primary');
			}
			
			if (sendBtn && recordingSeconds > 0) {
				sendBtn.classList.remove('hidden');
			}
		}

		function sendVoiceMessageToPost() {
			if (!selectedVoice) return;
			
			// Добавляем голосовое сообщение в пост
			const attachmentsContainer = document.getElementById('postAttachments');
			if (attachmentsContainer) {
				const minutes = Math.floor(selectedVoice.duration / 60);
				const seconds = selectedVoice.duration % 60;
				
				attachmentsContainer.innerHTML = `
					<div class="card">
						<div class="card-body">
							<div class="d-flex align-center justify-between">
								<div class="d-flex align-center gap-3">
									<i class="fas fa-microphone text-primary icon-lg"></i>
									<div>
										<div class="font-weight-medium">Голосовое сообщение</div>
										<div class="text-muted small">${minutes}:${seconds.toString().padStart(2, '0')}</div>
									</div>
								</div>
								<button class="btn btn-sm btn-primary" id="playVoiceBtn">
									<i class="fas fa-play"></i> Слушать
								</button>
							</div>
							<button class="btn btn-sm btn-danger w-100 mt-3" id="removeVoiceBtn">
								<i class="fas fa-times"></i> Удалить
							</button>
						</div>
					</div>
				`;
				attachmentsContainer.classList.remove('hidden');
				
				// Обработчик воспроизведения
				document.getElementById('playVoiceBtn').addEventListener('click', () => {
					const audio = new Audio(selectedVoice.url);
					audio.play();
				});
				
				// Обработчик удаления
				document.getElementById('removeVoiceBtn').addEventListener('click', () => {
					selectedVoice = null;
					attachmentsContainer.innerHTML = '';
					attachmentsContainer.classList.add('hidden');
				});
			}
			
			// Закрываем модалку
			document.getElementById('voiceModal').classList.remove('active');
		}

		// ========== УПРАВЛЕНИЕ СТРАНИЦАМИ ==========
		function showPage(pageName) {
			// Скрываем все страницы
			hideAllPages();
			
			// Убираем активный класс у всех навигационных ссылок
			document.querySelectorAll('.nav-link').forEach(link => {
				link.classList.remove('active');
			});
			
			// Активируем нужную навигационную ссылку
			const navLink = document.getElementById(`nav${pageName.charAt(0).toUpperCase() + pageName.slice(1)}`);
			if (navLink) {
				navLink.classList.add('active');
			}
			
			// Показываем нужную страницу
			const pageElement = document.getElementById(`${pageName}Page`);
			if (pageElement) {
				pageElement.classList.remove('hidden');
			}
			
			// Выполняем специфичные действия для каждой страницы
			switch (pageName) {
				case 'feed':
					renderPosts();
					break;
				case 'messages':
					renderConversations();
					break;
				case 'groups':
					renderGroups();
					break;
				case 'notifications':
					renderNotifications();
					break;
				case 'admin':
					loadAdminPanel();
					break;
			}
		}

		function hideAllPages() {
			document.getElementById('feedPage').classList.add('hidden');
			document.getElementById('profilePage').classList.add('hidden');
			document.getElementById('messagesPage').classList.add('hidden');
			document.getElementById('groupsPage').classList.add('hidden');
			document.getElementById('notificationsPage').classList.add('hidden');
			document.getElementById('adminPage').classList.add('hidden');
		}

		// ========== ИНИЦИАЛИЗАЦИЯ ==========
		async function initApp() {
			// Проверяем сохраненного пользователя
			const savedUser = localStorage.getItem('mirror_user');
			if (savedUser) {
				try {
					currentUser = JSON.parse(savedUser);
					await loadInitialData();
					await updateOnlineStatus();
					showMainApp();
					return;
				} catch (error) {
					console.error('Ошибка загрузки пользователя:', error);
					localStorage.removeItem('mirror_user');
				}
			}
			
			// Показываем форму авторизации
			showAuthPage();
		}

		function showMainApp() {
			document.getElementById('authPage').classList.add('hidden');
			document.getElementById('mainApp').classList.remove('hidden');
			
			// Обновляем интерфейс
			updateUI();
			updateOnlineUI();
			
			// Показываем ленту
			showPage('feed');
		}

		function showAuthPage() {
			document.getElementById('authPage').classList.remove('hidden');
			document.getElementById('mainApp').classList.add('hidden');
		}

		// ========== ПОМОЩНИКИ ==========
		function populateEmojiSelectors() {
			const selectors = [
				'registerEmojiSelector',
				'clanEmojiSelector',
				'editEmojiSelector',
				'groupEmojiSelector'
			];
			
			selectors.forEach(selectorId => {
				const container = document.getElementById(selectorId);
				if (container) {
					container.innerHTML = '';
					emojis.forEach(emoji => {
						const div = document.createElement('div');
						div.className = 'emoji-option';
						div.textContent = emoji;
						div.addEventListener('click', () => {
							// Снимаем выделение со всех
							container.querySelectorAll('.emoji-option').forEach(opt => {
								opt.classList.remove('selected');
							});
							// Выделяем выбранный
							div.classList.add('selected');
							// Обновляем соответствующее скрытое поле
							const hiddenInput = document.getElementById(selectorId.replace('Selector', ''));
							if (hiddenInput) hiddenInput.value = emoji;
						});
						container.appendChild(div);
					});
					
					// Выбираем первый эмодзи по умолчанию
					if (container.firstChild) {
						container.firstChild.classList.add('selected');
					}
				}
			});
		}

		function setupModal(modalId, openBtnId = null, closeBtnId = null) {
			const modal = document.getElementById(modalId);
			if (!modal) return;
			
			// Открытие модалки
			if (openBtnId) {
				const openBtn = document.getElementById(openBtnId);
				if (openBtn) {
					openBtn.addEventListener('click', () => {
						modal.classList.add('active');
					});
				}
			}
			
			// Закрытие модалки
			if (closeBtnId) {
				const closeBtn = document.getElementById(closeBtnId);
				if (closeBtn) {
					closeBtn.addEventListener('click', () => {
						modal.classList.remove('active');
					});
				}
			}
			
			// Закрытие по клику на оверлей
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					modal.classList.remove('active');
				}
			});
		}

		function showEditProfileModal() {
			const modal = document.getElementById('editProfileModal');
			if (!modal || !currentUser) return;
			
			// Заполняем поля текущими данными
			document.getElementById('editDisplayName').value = currentUser.display_name;
			document.getElementById('editBio').value = currentUser.description || '';
			document.getElementById('editStatus').value = currentUser.status || '';
			document.getElementById('editEmoji').value = currentUser.emoji;
			
			// Выбираем текущий эмодзи
			const emojiSelector = document.getElementById('editEmojiSelector');
			if (emojiSelector) {
				emojiSelector.querySelectorAll('.emoji-option').forEach(opt => {
					opt.classList.remove('selected');
					if (opt.textContent === currentUser.emoji) {
						opt.classList.add('selected');
					}
				});
			}
			
			modal.classList.add('active');
		}

		async function saveProfileChanges() {
			if (!currentUser || !supabaseClient) return;
			
			const displayName = document.getElementById('editDisplayName').value.trim();
			const bio = document.getElementById('editBio').value.trim();
			const status = document.getElementById('editStatus').value.trim();
			const emoji = document.getElementById('editEmoji').value;
			
			if (!displayName) {
				showNotification('Ошибка', 'Введите имя', 'error');
				return;
			}
			
			try {
				// Обновляем в базе данных
				const { error } = await supabaseClient
					.from('users')
					.update({
						display_name: displayName,
						description: bio,
						status: status,
						emoji: emoji,
						clan: emoji,  // Обновляем клан
						updated_at: new Date().toISOString()
					})
					.eq('id', currentUser.id);
				
				if (error) throw error;
				
				// Обновляем локально
				currentUser.display_name = displayName;
				currentUser.description = bio;
				currentUser.status = status;
				currentUser.emoji = emoji;
				currentUser.clan = emoji;  // Обновляем клан локально
				
				// Сохраняем в localStorage
				localStorage.setItem('mirror_user', JSON.stringify(currentUser));
				
				// Обновляем интерфейс
				updateUI();
				
				// Закрываем модалку
				document.getElementById('editProfileModal').classList.remove('active');
				
				showNotification('Успех', 'Профиль обновлен', 'success');
				
			} catch (error) {
				console.error('Ошибка обновления профиля:', error);
				showNotification('Ошибка', 'Не удалось обновить профиль', 'error');
			}
		}

		// ========== ОБРАБОТЧИКИ СОБЫТИЙ ==========
		document.addEventListener('DOMContentLoaded', async () => {
			// Инициализируем селекторы эмодзи
			populateEmojiSelectors();
			
			// Настраиваем модальные окна
			setupModal('clanModal', null, 'closeClanModal');
			setupModal('editProfileModal', 'editProfileBtn', 'closeEditProfileModal');
			setupModal('createGroupModal', 'createGroupBtn', 'closeCreateGroupModal');
			setupModal('voiceModal', null, 'closeVoiceModal');
			setupModal('fileModal', null, 'closeFileModal');
			
			// Настраиваем кнопки в модалке группы
			const groupTypeSelector = document.getElementById('groupTypeSelector');
			if (groupTypeSelector) {
				groupTypeSelector.addEventListener('click', (e) => {
					if (e.target.matches('[data-group-type]')) {
						groupTypeSelector.querySelectorAll('button').forEach(btn => {
							btn.classList.remove('active');
						});
						e.target.classList.add('active');
					}
				});
			}
			
			const groupPrivacySelector = document.getElementById('groupPrivacySelector');
			if (groupPrivacySelector) {
				groupPrivacySelector.addEventListener('click', (e) => {
					if (e.target.matches('[data-privacy]')) {
						groupPrivacySelector.querySelectorAll('button').forEach(btn => {
							btn.classList.remove('active');
						});
						e.target.classList.add('active');
					}
				});
			}
			
			// Авторизация
			document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
				e.preventDefault();
				const username = document.getElementById('loginUsername').value.trim();
				const password = document.getElementById('loginPassword').value;
				
				try {
					// Ищем пользователя в базе данных
					const { data: user, error } = await supabaseClient
						.from('users')
						.select('*')
						.or(`username.eq.${username},email.eq.${username}`)
						.eq('password_hash', password)
						.single();
					
					if (error || !user) {
						showNotification('Ошибка', 'Неверные данные для входа', 'error');
						return;
					}
					
					currentUser = user;
					localStorage.setItem('mirror_user', JSON.stringify(currentUser));
					await loadInitialData();
					await updateOnlineStatus();
					showMainApp();
					
				} catch (error) {
					console.error('Ошибка входа:', error);
					showNotification('Ошибка', 'Произошла ошибка при входе', 'error');
				}
			});
			
			// Регистрация
			document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
				e.preventDefault();
				
				const username = document.getElementById('regUsername').value.trim();
				const displayName = document.getElementById('regDisplayName').value.trim();
				const email = document.getElementById('regEmail').value.trim();
				const description = document.getElementById('regDescription').value.trim();
				const emoji = document.getElementById('regEmoji').value;
				const password = document.getElementById('regPassword').value;
				const confirmPassword = document.getElementById('regConfirmPassword').value;
				
				// Валидация
				if (!username.startsWith('@')) {
					showNotification('Ошибка', 'Юзернейм должен начинаться с @', 'error');
					return;
				}
				
				if (password.length < 6) {
					showNotification('Ошибка', 'Пароль должен быть не менее 6 символов', 'error');
					return;
				}
				
				if (password !== confirmPassword) {
					showNotification('Ошибка', 'Пароли не совпадают', 'error');
					return;
				}
				
				try {
					// Проверяем, существует ли пользователь
					const { data: existingUser } = await supabaseClient
						.from('users')
						.select('id')
						.eq('username', username)
						.single();
					
					if (existingUser) {
						showNotification('Ошибка', 'Этот юзернейм уже занят', 'error');
						return;
					}
					
					// Создаем нового пользователя
					const { data: newUser, error } = await supabaseClient
						.from('users')
						.insert([{
							username,
							display_name: displayName,
							email: email || null,
							description: description || null,
							emoji,
							password_hash: password,
							clan: emoji  // Сохраняем клан при регистрации
						}])
						.select()
						.single();
					
					if (error) throw error;
					
					currentUser = newUser;
					localStorage.setItem('mirror_user', JSON.stringify(currentUser));
					await loadInitialData();
					await updateOnlineStatus();
					showMainApp();
					
					showNotification('Успех', 'Регистрация прошла успешно!', 'success');
					
				} catch (error) {
					console.error('Ошибка регистрации:', error);
					showNotification('Ошибка', 'Не удалось зарегистрироваться', 'error');
				}
			});
			
			// Переключение вкладок авторизации
			document.getElementById('loginTab')?.addEventListener('click', () => {
				document.getElementById('loginTab').classList.add('active');
				document.getElementById('registerTab').classList.remove('active');
				document.getElementById('loginForm').classList.add('active');
				document.getElementById('registerForm').classList.remove('active');
			});
			
			document.getElementById('registerTab')?.addEventListener('click', () => {
				document.getElementById('registerTab').classList.add('active');
				document.getElementById('loginTab').classList.remove('active');
				document.getElementById('registerForm').classList.add('active');
				document.getElementById('loginForm').classList.remove('active');
			});
			
			// Создание поста
			document.getElementById('publishPostBtn')?.addEventListener('click', async () => {
				const content = document.getElementById('postText').value.trim();
				
				const attachments = {};
				if (selectedFile) {
					attachments.media = selectedFile;
				}
				
				if (selectedVoice) {
					attachments.voice = selectedVoice;
				}
				
				await createPost(content, attachments);
			});
			
			// Выход
			document.getElementById('logoutBtn')?.addEventListener('click', () => {
				if (supabaseClient && currentUser) {
					// Обновляем статус оффлайн
					supabaseClient
						.from('users')
						.update({ is_online: false, last_seen: new Date().toISOString() })
						.eq('id', currentUser.id);
				}
				
				currentUser = null;
				localStorage.removeItem('mirror_user');
				showAuthPage();
				showNotification('Информация', 'Вы вышли из системы', 'info');
			});
			
			// Навигация
			document.querySelectorAll('.nav-link').forEach(link => {
				link.addEventListener('click', (e) => {
					e.preventDefault();
					const page = link.dataset.page;
					if (page) showPage(page);
				});
			});
			
			// Логотип - переход на ленту
			document.getElementById('homeLogo')?.addEventListener('click', (e) => {
				e.preventDefault();
				showPage('feed');
			});
			
			// Просмотр своего профиля
			document.getElementById('viewProfileBtn')?.addEventListener('click', () => {
				if (currentUser) {
					showUserProfile(currentUser.id);
				}
			});
			
			// Создание поста из пустой ленты
			document.getElementById('emptyFeedPostBtn')?.addEventListener('click', () => {
				const postText = document.getElementById('postText');
				if (postText) postText.focus();
			});
			
			// Сохранение профиля
			document.getElementById('saveProfileBtn')?.addEventListener('click', saveProfileChanges);
			
			// Создание группы
			document.getElementById('saveGroupBtn')?.addEventListener('click', async () => {
				const name = document.getElementById('groupName').value.trim();
				const username = document.getElementById('groupUsername').value.trim();
				const description = document.getElementById('groupDescription').value.trim();
				const emoji = document.getElementById('groupEmoji').value;
				const type = document.querySelector('#groupTypeSelector .active')?.dataset.groupType || 'group';
				const privacy = document.querySelector('#groupPrivacySelector .active')?.dataset.privacy || 'public';
				
				if (!name || !username) {
					showNotification('Ошибка', 'Заполните обязательные поля', 'error');
					return;
				}
				
				if (!username.startsWith('@')) {
					showNotification('Ошибка', 'Юзернейм должен начинаться с @', 'error');
					return;
				}
				
				const groupData = {
					name,
					username,
					description,
					avatar: emoji,
					type,
					privacy
				};
				
				const success = await createGroup(groupData);
				if (success) {
					document.getElementById('createGroupModal').classList.remove('active');
					// Очищаем форму
					document.getElementById('groupName').value = '';
					document.getElementById('groupUsername').value = '';
					document.getElementById('groupDescription').value = '';
				}
			});
			
			// Поиск
			document.getElementById('searchInput')?.addEventListener('input', (e) => {
				const query = e.target.value.trim().toLowerCase();
				const resultsContainer = document.getElementById('searchResults');
				
				if (!resultsContainer) return;
				
				if (query.length < 2) {
					resultsContainer.classList.add('hidden');
					return;
				}
				
				// Поиск пользователей
				const users = allUsers.filter(u => 
					u.username.toLowerCase().includes(query) || 
					u.display_name.toLowerCase().includes(query)
				).slice(0, 5);
				
				// Поиск групп
				const groups = allGroups.filter(g => 
					g.name.toLowerCase().includes(query) || 
					(g.username && g.username.toLowerCase().includes(query))
				).slice(0, 5);
				
				const results = [...users, ...groups];
				
				if (results.length === 0) {
					resultsContainer.innerHTML = '<div class="search-result-item text-muted p-3">Ничего не найдено</div>';
				} else {
					resultsContainer.innerHTML = results.map(item => `
						<div class="search-result-item" data-id="${item.id}" data-type="${item.username ? 'user' : 'group'}">
							<div class="d-flex align-center gap-3 p-3">
								<div class="user-avatar">
									<span>${item.emoji || item.avatar || '👤'}</span>
								</div>
								<div class="flex-1">
									<div class="font-weight-medium">${item.username || item.name}</div>
									<div class="text-muted small">${item.display_name || item.description?.slice(0, 50) || ''}</div>
								</div>
							</div>
						</div>
					`).join('');
					
					// Добавляем обработчики
					resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
						item.addEventListener('click', () => {
							const id = item.dataset.id;
							const type = item.dataset.type;
							
							if (type === 'user') {
								showUserProfile(id);
							} else {
								// Для групп показываем информацию
								const group = allGroups.find(g => g.id === id);
								if (group) {
									showNotification('Информация', `Группа: ${group.name}`, 'info');
								}
							}
							
							resultsContainer.classList.add('hidden');
							document.getElementById('searchInput').value = '';
						});
					});
				}
				
				resultsContainer.classList.remove('hidden');
			});
			
			// Закрытие результатов поиска при клике вне
			document.addEventListener('click', (e) => {
				if (!e.target.closest('.search-container')) {
					const resultsContainer = document.getElementById('searchResults');
					if (resultsContainer) {
						resultsContainer.classList.add('hidden');
					}
				}
			});
			
			// Табы групп
			document.querySelectorAll('.tab[data-tab]').forEach(tab => {
				tab.addEventListener('click', () => {
					const tabName = tab.dataset.tab;
					
					// Активируем таб
					document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
					tab.classList.add('active');
					
					// Показываем соответствующую сетку
					document.querySelectorAll('.groups-grid').forEach(grid => {
						grid.classList.add('hidden');
					});
					
					const gridId = tabName === 'all' ? 'allGroupsGrid' : 
								  tabName === 'my' ? 'myGroupsGrid' :
								  tabName === 'channels' ? 'channelsGrid' : 'communitiesGrid';
					
					const grid = document.getElementById(gridId);
					if (grid) {
						grid.classList.remove('hidden');
					}
				});
			});
			
			// Работа с файлами в посте
			document.getElementById('addFileBtn')?.addEventListener('click', () => {
				document.getElementById('fileModal').classList.add('active');
			});
			
			document.getElementById('fileInput')?.addEventListener('change', handleFileSelect);
			
			document.getElementById('uploadFileBtn')?.addEventListener('click', uploadFileToPost);
			
			document.getElementById('cancelFileBtn')?.addEventListener('click', () => {
				document.getElementById('fileModal').classList.remove('active');
				selectedFile = null;
			});
			
			// Работа с голосовыми сообщениями
			document.getElementById('addVoiceBtn')?.addEventListener('click', () => {
				document.getElementById('voiceModal').classList.add('active');
			});
			
			document.getElementById('recordVoiceBtn')?.addEventListener('click', () => {
				if (isRecording) {
					stopRecording();
				} else {
					startRecording();
				}
			});
			
			document.getElementById('sendVoiceBtn')?.addEventListener('click', sendVoiceMessageToPost);
			
			document.getElementById('cancelVoiceBtn')?.addEventListener('click', () => {
				document.getElementById('voiceModal').classList.remove('active');
				if (isRecording) {
					stopRecording();
				}
				selectedVoice = null;
			});
			
			// Отметить все уведомления как прочитанные
			document.getElementById('markAllReadBtn')?.addEventListener('click', async () => {
				if (!supabaseClient || !currentUser) return;
				
				try {
					await supabaseClient
						.from('notifications')
						.update({ is_read: true })
						.eq('user_id', currentUser.id)
						.eq('is_read', false);
					
					// Обновляем локально
					notifications.forEach(notification => {
						notification.is_read = true;
					});
					
					renderNotifications();
					await loadNotifications();
					
					showNotification('Успех', 'Все уведомления отмечены как прочитанные', 'success');
					
				} catch (error) {
					console.error('Ошибка отметки уведомлений:', error);
					showNotification('Ошибка', 'Не удалось отметить уведомления', 'error');
				}
			});
			
			// Запускаем приложение
			await initApp();
			
			// Обновляем онлайн статус каждые 30 секунд
			setInterval(async () => {
				if (currentUser) {
					await updateOnlineStatus();
				}
			}, 30000);
		});

		// ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
		async function showGroupInfo(groupId) {
			try {
				const { data: group, error } = await supabaseClient
					.from('groups')
					.select('*')
					.eq('id', groupId)
					.single();
				
				if (error) throw error;
				
				showNotification('Информация', `Группа: ${group.name}`, 'info');
				
			} catch (error) {
				console.error('Ошибка загрузки группы:', error);
				showNotification('Ошибка', 'Не удалось загрузить информацию о группе', 'error');
			}
		}

		function showReportModal(userId) {
			showNotification('Информация', 'Система жалоб в разработке', 'info');
		}

		async function loadAdminPanel() {
			if (!currentUser || currentUser.username !== '@onegin') {
				showNotification('Ошибка', 'Доступ запрещен', 'error');
				showPage('feed');
				return;
			}
			
			try {
				// Загружаем статистику
				const totalUsers = allUsers.length;
				const onlineUsersCount = onlineUsers.size;
				const totalPosts = allPosts.length;
				const totalGroups = allGroups.length;
				
				document.getElementById('adminTotalUsers').textContent = totalUsers;
				document.getElementById('adminOnlineUsers').textContent = onlineUsersCount;
				document.getElementById('adminTotalPosts').textContent = totalPosts;
				document.getElementById('adminTotalGroups').textContent = totalGroups;
				
			} catch (error) {
				console.error('Ошибка загрузки админ панели:', error);
				showNotification('Ошибка', 'Не удалось загрузить админ панель', 'error');
			}
		}

		// ========== ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ РАБОТЫ С ГРУППАМИ ==========
		async function renderGroups() {
			const allGrid = document.getElementById('allGroupsGrid');
			const myGrid = document.getElementById('myGroupsGrid');
			const channelsGrid = document.getElementById('channelsGrid');
			const communitiesGrid = document.getElementById('communitiesGrid');
			
			if (!allGrid || !myGrid || !channelsGrid || !communitiesGrid) return;
			
			// Очищаем все сетки
			allGrid.innerHTML = '';
			myGrid.innerHTML = '';
			channelsGrid.innerHTML = '';
			communitiesGrid.innerHTML = '';
			
			// Определяем, в каких группах состоит пользователь
			let userGroups = [];
			if (currentUser && supabaseClient) {
				const { data: memberships } = await supabaseClient
					.from('group_members')
					.select('group_id')
					.eq('user_id', currentUser.id);
				
				if (memberships) {
					userGroups = memberships.map(m => m.group_id);
				}
			}
			
			// Обновляем счетчик моих групп
			const myGroupsCount = document.getElementById('myGroupsCount');
			if (myGroupsCount) {
				myGroupsCount.textContent = userGroups.length;
			}
			
			// Рендерим группы
			for (const group of allGroups) {
				const isMember = userGroups.includes(group.id);
				
				// Рендерим во все группы
				renderGroupCard(group, allGrid, isMember);
				
				// Рендерим в мои группы если пользователь участник
				if (isMember) {
					renderGroupCard(group, myGrid, true);
				}
				
				// Рендерим по типам
				if (group.type === 'channel') {
					renderGroupCard(group, channelsGrid, isMember);
				} else if (group.type === 'community') {
					renderGroupCard(group, communitiesGrid, isMember);
				}
			}
			
			// Добавляем обработчики
			addGroupEventListeners();
		}

		function renderGroupCard(group, container, isMember) {
			const template = document.getElementById('groupCardTemplate').innerHTML;
			
			let html = template
				.replace(/\{\{id\}\}/g, group.id)
				.replace(/\{\{name\}\}/g, group.name)
				.replace(/\{\{avatar\}\}/g, group.avatar || '👥')
				.replace(/\{\{description\}\}/g, group.description || 'Нет описания')
				.replace(/\{\{members_count\}\}/g, group.members_count || 0)
				.replace(/\{\{posts_count\}\}/g, group.posts_count || 0)
				.replace(/\{\{is_member\}\}/g, isMember ? 'true' : '');
			
			// Обработка условных блоков
			html = html.replace(/\{\{#if is_member\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, content) => {
				return isMember ? content : '';
			});
			
			html = html.replace(/\{\{[^}]+\}\}/g, '');
			
			const div = document.createElement('div');
			div.innerHTML = html;
			container.appendChild(div.firstElementChild);
		}

		function addGroupEventListeners() {
			// Кнопки вступления в группы
			document.querySelectorAll('.join-group-btn').forEach(btn => {
				btn.addEventListener('click', async (e) => {
					e.stopPropagation();
					const groupId = btn.dataset.groupId;
					await joinGroup(groupId);
				});
			});
			
			// Клики по карточкам групп
			document.querySelectorAll('.group-card').forEach(card => {
				card.addEventListener('click', (e) => {
					if (!e.target.classList.contains('join-group-btn')) {
						const groupId = card.dataset.groupId;
						showGroupInfo(groupId);
					}
				});
			});
		}

		async function joinGroup(groupId) {
			if (!currentUser || !supabaseClient) {
				showNotification('Ошибка', 'Войдите в систему', 'error');
				return false;
			}
			
			try {
				const { data: group, error: groupError } = await supabaseClient
					.from('groups')
					.select('*')
					.eq('id', groupId)
					.single();
				
				if (groupError) throw groupError;
				
				// Проверяем, состоит ли уже пользователь в группе
				const { data: existingMembership } = await supabaseClient
					.from('group_members')
					.select('id')
					.eq('group_id', groupId)
					.eq('user_id', currentUser.id)
					.single();
				
				if (existingMembership) {
					showNotification('Информация', 'Вы уже в группе', 'info');
					return false;
				}
				
				// Добавляем пользователя в группу
				const { error: joinError } = await supabaseClient
					.from('group_members')
					.insert([{
						group_id: groupId,
						user_id: currentUser.id,
						role: 'member'
					}]);
				
				if (joinError) throw joinError;
				
				// Обновляем счетчик участников
				await supabaseClient
					.from('groups')
					.update({
						members_count: (group.members_count || 0) + 1
					})
					.eq('id', groupId);
				
				// Обновляем интерфейс
				await renderGroups();
				await loadPopularGroups();
				
				showNotification('Успех', 'Вы вступили в группу!', 'success');
				return true;
				
			} catch (error) {
				console.error('Ошибка вступления в группу:', error);
				showNotification('Ошибка', 'Не удалось вступить в группу', 'error');
				return false;
			}
		}

		async function createGroup(groupData) {
			if (!currentUser || !supabaseClient) {
				showNotification('Ошибка', 'Войдите в систему', 'error');
				return false;
			}
			
			try {
				// Создаем группу
				const { data: newGroup, error: groupError } = await supabaseClient
					.from('groups')
					.insert([{
						name: groupData.name,
						username: groupData.username,
						description: groupData.description,
						avatar: groupData.avatar,
						type: groupData.type || 'group',
						is_public: groupData.privacy === 'public',
						creator_id: currentUser.id,
						members_count: 1
					}])
					.select()
					.single();
				
				if (groupError) throw groupError;
				
				// Добавляем создателя в участники
				const { error: memberError } = await supabaseClient
					.from('group_members')
					.insert([{
						group_id: newGroup.id,
						user_id: currentUser.id,
						role: 'admin'
					}]);
				
				if (memberError) throw memberError;
				
				// Обновляем локальный список групп
				allGroups.unshift(newGroup);
				
				// Обновляем интерфейс
				await renderGroups();
				await loadPopularGroups();
				
				showNotification('Успех', 'Группа создана!', 'success');
				return true;
				
			} catch (error) {
				console.error('Ошибка создания группы:', error);
				showNotification('Ошибка', 'Не удалось создать группу', 'error');
				return false;
			}
		}
	</script>
</body>
</html>