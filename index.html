<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Зеркало - современная социальная сеть</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* ===== ОСНОВНЫЕ ПЕРЕМЕННЫЕ И СТИЛИ ===== */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #c7d2fe;
            --secondary: #f8fafc;
            --text: #1e293b;
            --text-light: #64748b;
            --text-lighter: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --card-bg: #ffffff;
            --background: #f8fafc;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --error: #ef4444;
            --error-light: #fecaca;
            --success: #10b981;
            --success-light: #a7f3d0;
            --warning: #f59e0b;
            --warning-light: #fde68a;
            --info: #3b82f6;
            --info-light: #bfdbfe;
            --online: #10b981;
            --offline: #94a3b8;
            --away: #f59e0b;
            --dnd: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ===== АНИМАЦИИ ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in { animation: fadeIn 0.3s ease; }
        .slide-in { animation: slideIn 0.3s ease; }
        .slide-up { animation: slideUp 0.3s ease; }

        /* ===== ХЕЛПЕРЫ ===== */
        .hidden { display: none !important; }
        .loading { animation: pulse 1.5s ease-in-out infinite; }
        .spinner { animation: spin 1s linear infinite; }
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== КНОПКИ ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            user-select: none;
        }

        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover { background-color: var(--primary-dark); }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }

        .btn-danger:hover { background-color: #dc2626; }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover { background-color: #059669; }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background-color: var(--secondary);
            color: var(--primary);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 16px;
        }

        .btn-block { width: 100%; }
        .btn-rounded { border-radius: 50px; }

        /* ===== КАРТОЧКИ ===== */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover { box-shadow: var(--shadow-md); }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .card-body {
            padding: 20px;
        }

        .card-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background-color: var(--secondary);
        }

        /* ===== ШАПКА ===== */
        header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.9);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            transition: transform 0.2s;
        }

        .logo:hover { transform: scale(1.05); }
        .logo-icon { font-size: 28px; }

        /* Поиск */
        .search-container {
            flex: 0 1 400px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--border);
            border-radius: 50px;
            font-size: 14px;
            background-color: var(--secondary);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-top: 4px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--secondary);
        }

        /* Навигация */
        .nav-links {
            display: flex;
            gap: 4px;
        }

        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 16px;
            color: var(--text-light);
            text-decoration: none;
            font-size: 12px;
            border-radius: var(--radius);
            transition: all 0.2s;
            min-width: 70px;
        }

        .nav-link:hover {
            background-color: var(--secondary);
            color: var(--text);
        }

        .nav-link.active {
            color: var(--primary);
            background-color: var(--primary-light);
        }

        .nav-link i {
            font-size: 20px;
        }

        /* Уведомления */
        .badge {
            background-color: var(--error);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Профиль пользователя */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover { transform: scale(1.05); }

        .status-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-online { background-color: var(--online); }
        .status-offline { background-color: var(--offline); }
        .status-away { background-color: var(--away); }
        .status-dnd { background-color: var(--dnd); }

        .status-pulse {
            animation: pulse 2s infinite;
        }

        /* ===== ОСНОВНОЙ КОНТЕНТ ===== */
        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 24px;
            padding: 24px 0;
            min-height: calc(100vh - 64px);
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Левая панель */
        .left-panel {
            position: sticky;
            top: 88px;
            height: fit-content;
        }

        .user-card {
            padding: 20px;
        }

        .user-info {
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 16px;
            position: relative;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-username {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .user-clan {
            display: inline-block;
            background-color: var(--primary-light);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .user-bio {
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: left;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .user-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Центральная панель */
        .feed {
            display: flex;
            flex-direction: column;
            gap: 24px; /* Увеличили расстояние между постами */
        }

        /* Создание поста */
        .create-post {
            padding: 16px;
        }

        .post-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .post-input {
            flex: 1;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            transition: border-color 0.2s;
        }

        .post-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }

        .post-attachments {
            display: flex;
            gap: 8px;
        }

        .attachment-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: var(--radius);
            background: none;
            border: 1px solid var(--border);
            color: var(--text-light);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .attachment-btn:hover {
            background-color: var(--secondary);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Посты */
        .post {
            position: relative;
            margin-bottom: 0; /* Убираем марджин снизу, так как используем gap в .feed */
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            cursor: pointer;
        }

        .post-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .post-author-info {
            flex: 1;
        }

        .post-author-name {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .verified-badge {
            color: var(--success);
            font-size: 14px;
        }

        .post-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            font-size: 13px;
        }

        .post-time {
            color: var(--text-lighter);
        }

        .post-content {
            padding: 0 20px 16px;
            line-height: 1.6;
        }

        .post-attachment {
            margin: 12px 0;
            border-radius: var(--radius);
            overflow: hidden;
            max-width: 100%;
        }

        .post-attachment img {
            width: 100%;
            max-height: 500px;
            object-fit: cover;
        }

        .attachment-info {
            padding: 8px 12px;
            background-color: var(--secondary);
            font-size: 13px;
            color: var(--text-light);
        }

        /* Улучшенные действия поста */
        .post-actions-footer {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 20px;
            border-top: 1px solid var(--border-light);
            background-color: var(--secondary);
        }

        .post-actions-footer .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius);
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            flex: 1;
            max-width: 100px;
        }

        .post-actions-footer .action-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .post-actions-footer .action-btn.active,
        .post-actions-footer .action-btn.liked {
            color: var(--primary);
        }

        .post-actions-footer .action-btn.liked {
            color: #f43f5e;
        }

        .post-actions-footer .action-btn.liked:hover {
            color: #e11d48;
        }

        .post-actions-footer .action-btn .fa-heart {
            color: inherit;
        }

        .post-actions-footer .action-count {
            font-weight: 600;
            font-size: 13px;
            color: inherit;
        }

        /* Репосты */
        .repost-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px 0;
            color: var(--text-light);
            font-size: 13px;
        }

        .repost-content {
            margin: 12px 20px;
            padding: 16px;
            background-color: var(--secondary);
            border-radius: var(--radius);
            border-left: 3px solid var(--primary-light);
        }

        /* Комментарии */
        .comments-section {
            padding: 0 20px;
            margin-top: 16px;
        }

        .comment {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .comment:last-child {
            margin-bottom: 0;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            background-color: var(--secondary);
            padding: 12px;
            border-radius: var(--radius);
        }

        .comment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .comment-author {
            font-weight: 600;
            font-size: 13px;
        }

        .comment-time {
            color: var(--text-lighter);
            font-size: 12px;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.5;
        }

        .add-comment {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
            transition: border-color 0.2s;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Правая панель */
        .right-panel {
            position: sticky;
            top: 88px;
            height: fit-content;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        /* Список онлайн */
        .online-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: var(--radius);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .online-user:hover {
            background-color: var(--secondary);
        }

        .online-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
        }

        .online-user-info {
            flex: 1;
        }

        .online-user-name {
            font-weight: 500;
            font-size: 14px;
        }

        .online-user-status {
            font-size: 12px;
            color: var(--online);
        }

        /* Рекомендации */
        .recommended-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .recommended-user:hover {
            background-color: var(--secondary);
        }

        .recommended-user-info {
            flex: 1;
        }

        .recommended-user-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .recommended-user-bio {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        /* ===== СТРАНИЦЫ ===== */
        .page {
            padding: 24px 0;
            min-height: calc(100vh - 64px);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text);
        }

        /* Страница профиля */
        .profile-header {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 24px;
            position: relative;
        }

        .profile-cover {
            height: 200px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            position: relative;
        }

        .profile-cover-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .profile-info {
            padding: 0 32px 32px;
            position: relative;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            position: absolute;
            top: -60px;
            left: 32px;
            border: 4px solid var(--card-bg);
        }

        .profile-main-info {
            margin-left: 140px;
            padding-top: 16px;
        }

        .profile-name-large {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-username-large {
            color: var(--text-light);
            font-size: 16px;
            margin-bottom: 8px;
        }

        .profile-bio-large {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 16px;
            max-width: 600px;
        }

        .profile-stats-large {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
        }

        .profile-stat-large {
            text-align: center;
        }

        .profile-stat-value-large {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .profile-stat-label-large {
            font-size: 14px;
            color: var(--text-light);
        }

        .profile-actions-large {
            display: flex;
            gap: 12px;
        }

        .profile-tabs {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .tab-list {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
        }

        .tab {
            padding: 16px 20px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            margin-bottom: -1px;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-badge {
            background-color: var(--primary-light);
            color: var(--primary);
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        .tab-content {
            padding: 24px;
        }

        /* Страница сообщений */
        .messages-container {
            display: flex;
            height: calc(100vh - 180px);
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .conversations-sidebar {
            width: 320px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .conversation-item:hover,
        .conversation-item.active {
            background-color: var(--secondary);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
        }

        .conversation-info {
            flex: 1;
            overflow: hidden;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .conversation-last-message {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-lighter);
        }

        .messages-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-bg);
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
        }

        .chat-user-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .chat-user-details p {
            font-size: 13px;
            color: var(--online);
        }

        .messages-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-color: var(--background);
        }

        .message {
            display: flex;
            max-width: 70%;
            animation: slideIn 0.3s ease;
        }

        .message.outgoing {
            margin-left: auto;
        }

        .message-content {
            background-color: var(--secondary);
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.outgoing .message-content {
            background-color: var(--primary);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-lighter);
            margin-top: 4px;
            text-align: right;
        }

        .message-input-container {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background-color: var(--card-bg);
        }

        .message-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-attachments {
            display: flex;
            gap: 8px;
        }

        .message-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Страница групп */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .group-card {
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .group-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .group-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 16px;
        }

        .group-name {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .group-description {
            text-align: center;
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .group-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .group-stat {
            text-align: center;
        }

        .group-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .group-stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        /* ===== АДМИН ПАНЕЛЬ ===== */
        .admin-panel {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--radius);
            padding: 32px;
            color: white;
            margin-bottom: 24px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .admin-stat-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
        }

        .admin-stat-card:hover {
            transform: translateY(-4px);
        }

        .admin-stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .admin-stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .admin-section {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .admin-users-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .admin-user-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            gap: 16px;
        }

        .admin-user-item:last-child {
            border-bottom: none;
        }

        .admin-user-info {
            flex: 1;
        }

        .admin-user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .admin-user-meta {
            font-size: 13px;
            color: var(--text-light);
        }

        /* ===== МОДАЛЬНЫЕ ОКНА ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        .modal-large {
            max-width: 800px;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background-color: var(--secondary);
            color: var(--text);
        }

        .modal-body {
            padding: 20px;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: var(--secondary);
        }

        /* Эмодзи селектор */
        .emoji-selector {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .emoji-option {
            font-size: 24px;
            cursor: pointer;
            text-align: center;
            padding: 8px;
            border-radius: var(--radius);
            transition: all 0.2s;
            user-select: none;
        }

        .emoji-option:hover {
            background-color: var(--secondary);
            transform: scale(1.1);
        }

        .emoji-option.selected {
            background-color: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* ===== УВЕДОМЛЕНИЯ ===== */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
            width: 100%;
        }

        .notification {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease;
            transition: all 0.3s;
        }

        .notification.hiding {
            transform: translateX(100%);
            opacity: 0;
        }

        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification.success .notification-icon { color: var(--success); }
        .notification.error .notification-icon { color: var(--error); }
        .notification.info .notification-icon { color: var(--primary); }
        .notification.warning .notification-icon { color: var(--warning); }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-lighter);
            cursor: pointer;
            padding: 2px;
            flex-shrink: 0;
        }

        /* ===== АВТОРИЗАЦИЯ ===== */
        .auth-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--background) 0%, #e2e8f0 100%);
            padding: 20px;
        }

        .auth-container {
            width: 100%;
            max-width: 440px;
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.5s ease;
        }

        .auth-header {
            padding: 32px 32px 20px;
            text-align: center;
        }

        .auth-logo {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--text-light);
            font-size: 16px;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
        }

        .auth-tab:hover {
            color: var(--text);
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-body {
            padding: 32px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-text {
            display: block;
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-light);
        }

        /* ===== ГОЛОСОВЫЕ СООБЩЕНИЯ ===== */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: var(--secondary);
            border-radius: var(--radius);
            margin: 8px 0;
        }

        .voice-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .voice-play-btn:hover {
            background-color: var(--primary-dark);
        }

        .voice-waveform {
            flex: 1;
            height: 36px;
            background-color: rgba(99, 102, 241, 0.1);
            border-radius: 18px;
            position: relative;
            overflow: hidden;
        }

        .voice-wave {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to right,
                var(--primary) 0px,
                var(--primary) 2px,
                transparent 2px,
                transparent 4px
            );
            animation: voiceWave 1s linear infinite;
        }

        @keyframes voiceWave {
            from { transform: translateX(-4px); }
            to { transform: translateX(0); }
        }

        .voice-duration {
            font-size: 14px;
            color: var(--text-light);
        }

        /* ===== АДАПТИВНОСТЬ ===== */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .header-content {
                flex-wrap: wrap;
                height: auto;
                padding: 12px 0;
            }

            .logo {
                font-size: 20px;
            }

            .search-container {
                order: 3;
                flex: 1 0 100%;
                margin-top: 12px;
            }

            .user-menu {
                margin-left: auto;
            }

            .nav-links {
                order: 2;
                flex: 1;
                justify-content: space-around;
                margin: 0 10px;
            }

            .nav-link {
                min-width: auto;
                padding: 8px 12px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px 0;
            }

            .left-panel,
            .right-panel {
                position: static;
            }

            .messages-container {
                flex-direction: column;
                height: calc(100vh - 120px);
            }

            .conversations-sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .profile-main-info {
                margin-left: 0;
                margin-top: 60px;
            }

            .profile-avatar-large {
                position: relative;
                top: 0;
                left: 0;
                margin: -60px auto 20px;
            }

            .groups-grid {
                grid-template-columns: 1fr;
            }

            .emoji-selector {
                grid-template-columns: repeat(6, 1fr);
            }
            
            /* Улучшаем адаптивность шапки для мобильных */
            .header-content {
                padding: 8px 0;
            }
            
            .nav-link span {
                font-size: 10px;
            }
            
            .nav-link i {
                font-size: 16px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .main-content {
                grid-template-columns: 240px 1fr;
            }

            .right-panel {
                display: none;
            }
        }

        /* ===== ПОЛЕЗНЫЕ КЛАССЫ ===== */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-light); }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }

        .bg-primary { background-color: var(--primary); }
        .bg-secondary { background-color: var(--secondary); }
        .bg-success { background-color: var(--success); }
        .bg-error { background-color: var(--error); }
        .bg-warning { background-color: var(--warning); }

        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-5 { margin-bottom: 20px; }

        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mt-5 { margin-top: 20px; }

        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .flex-column { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-1 { flex: 1; }

        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .gap-5 { gap: 20px; }

        .w-100 { width: 100%; }
        .h-100 { height: 100%; }

        .cursor-pointer { cursor: pointer; }
        .user-select-none { user-select: none; }

        .border { border: 1px solid var(--border); }
        .border-top { border-top: 1px solid var(--border); }
        .border-bottom { border-bottom: 1px solid var(--border); }

        .rounded { border-radius: var(--radius); }
        .rounded-circle { border-radius: 50%; }

        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }

        .position-relative { position: relative; }
        .position-absolute { position: absolute; }

        .d-none { display: none; }
        .d-block { display: block; }
        .d-inline-block { display: inline-block; }

        /* ===== ИКОНКИ ===== */
        .icon-sm { font-size: 14px; }
        .icon-md { font-size: 18px; }
        .icon-lg { font-size: 24px; }
        .icon-xl { font-size: 32px; }
    </style>
</head>
<body>
    <!-- Контейнер для уведомлений -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Авторизация -->
    <div id="authPage" class="auth-page">
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-mirror"></i>
                    Зеркало
                </div>
                <div class="auth-subtitle">Современная социальная сеть</div>
            </div>

            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Вход</div>
                <div class="auth-tab" id="registerTab">Регистрация</div>
            </div>

            <div class="auth-body">
                <!-- Форма входа -->
                <form class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Юзернейм или Email</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="@username или email@example.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input type="password" id="loginPassword" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                            <i class="fas fa-sign-in-alt"></i> Войти
                        </button>
                    </div>

                    <div class="text-center text-muted">
                        <small>Для демо-доступа используйте @onegin / admin123</small>
                    </div>
                </form>

                <!-- Форма регистрации -->
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Юзернейм</label>
                        <input type="text" id="regUsername" class="form-control" placeholder="@username" required>
                        <small class="form-text">Начинается с @, должен быть уникальным</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Отображаемое имя</label>
                        <input type="text" id="regDisplayName" class="form-control" placeholder="Ваше имя" required>
                        <small class="form-text">Как вас будут видеть другие пользователи</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email (опционально)</label>
                        <input type="email" id="regEmail" class="form-control" placeholder="email@example.com">
                        <small class="form-text">Для восстановления пароля и уведомлений</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">О себе</label>
                        <textarea id="regDescription" class="form-control" placeholder="Расскажите о себе..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Аватарка (эмодзи)</label>
                        <div class="emoji-selector" id="registerEmojiSelector"></div>
                        <input type="hidden" id="regEmoji" value="😀">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input type="password" id="regPassword" class="form-control" required>
                        <small class="form-text">Минимум 8 символов</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Подтвердите пароль</label>
                        <input type="password" id="regConfirmPassword" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                            <i class="fas fa-user-plus"></i> Зарегистрироваться
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Основное приложение -->
    <div id="mainApp" class="hidden">
        <!-- Шапка -->
        <header>
            <div class="container">
                <div class="header-content">
                    <!-- Логотип -->
                    <a href="#" class="logo" id="homeLogo">
                        <i class="fas fa-mirror logo-icon"></i>
                        <span>Зеркало</span>
                    </a>

                    <!-- Поиск -->
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Поиск пользователей, групп, сообществ...">
                        <div class="search-results hidden" id="searchResults"></div>
                    </div>

                    <!-- Навигация -->
                    <nav class="nav-links">
                        <a href="#" class="nav-link active" data-page="feed" id="navFeed">
                            <i class="fas fa-home"></i>
                            <span>Лента</span>
                        </a>
                        <a href="#" class="nav-link" data-page="messages" id="navMessages">
                            <i class="fas fa-comments"></i>
                            <span>Сообщения</span>
                            <span class="badge hidden" id="messagesBadge">0</span>
                        </a>
                        <a href="#" class="nav-link" data-page="groups" id="navGroups">
                            <i class="fas fa-users"></i>
                            <span>Группы</span>
                        </a>
                        <a href="#" class="nav-link" data-page="notifications" id="navNotifications">
                            <i class="fas fa-bell"></i>
                            <span>Уведомления</span>
                            <span class="badge hidden" id="notificationsBadge">0</span>
                        </a>
                        <a href="#" class="nav-link hidden" data-page="admin" id="navAdmin">
                            <i class="fas fa-shield-alt"></i>
                            <span>Админ</span>
                        </a>
                    </nav>

                    <!-- Профиль пользователя -->
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">
                            <span id="userAvatarEmoji">😀</span>
                            <div class="status-indicator status-online" id="userStatusIndicator"></div>
                        </div>
                        <button class="btn-icon" id="logoutBtn" title="Выйти">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Основной контент - Лента -->
        <div id="feedPage" class="page">
            <div class="container">
                <div class="main-content">
                    <!-- Левая панель (профиль) -->
                    <div class="left-panel">
                        <div class="card user-card">
                            <div class="user-info">
                                <div class="profile-avatar">
                                    <span id="profileEmoji">😀</span>
                                    <div class="status-indicator status-online" id="profileStatusIndicator"></div>
                                </div>
                                <h3 class="user-name" id="profileName">Имя Фамилия</h3>
                                <div class="user-username" id="profileUsername">
                                    @username
                                    <i class="fas fa-check-circle verified-badge hidden" id="profileVerifiedBadge"></i>
                                </div>
                                <div class="user-clan" id="profileClan">😀 Клан</div>
                                
                                <div class="user-bio" id="profileBio">
                                    Пользователь пока ничего не написал в описании
                                </div>

                                <div class="user-stats">
                                    <div class="stat">
                                        <div class="stat-value" id="statPosts">0</div>
                                        <div class="stat-label">Постов</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-value" id="statFollowers">0</div>
                                        <div class="stat-label">Подписчиков</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-value" id="statFollowing">0</div>
                                        <div class="stat-label">Подписок</div>
                                    </div>
                                </div>

                                <div class="user-actions">
                                    <button class="btn btn-primary btn-block" id="createPostBtn">
                                        <i class="fas fa-plus"></i> Новый пост
                                    </button>
                                    <button class="btn btn-secondary btn-block" id="editProfileBtn">
                                        <i class="fas fa-edit"></i> Редактировать
                                    </button>
                                    <button class="btn btn-secondary btn-block" id="viewProfileBtn">
                                        <i class="fas fa-user"></i> Мой профиль
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Статус сети -->
                        <div class="card panel-section">
                            <div class="card-header">
                                <div class="card-title">Статус сети</div>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-center justify-between">
                                    <div class="d-flex align-center gap-2">
                                        <div class="status-indicator status-online status-pulse"></div>
                                        <span>В сети</span>
                                    </div>
                                    <span class="text-muted" id="onlineCount">0 онлайн</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Центральная панель (лента) -->
                    <div class="feed">
                        <!-- Создание поста -->
                        <div class="card create-post" id="createPostForm">
                            <div class="post-input-container">
                                <div class="post-avatar" id="currentUserEmoji">😀</div>
                                <textarea class="post-input" id="postText" placeholder="Что у вас нового?" rows="3"></textarea>
                            </div>
                            <div class="post-actions">
                                <div class="post-attachments">
                                    <button type="button" class="attachment-btn" id="addPhotoBtn">
                                        <i class="fas fa-image"></i>
                                        <span>Фото</span>
                                    </button>
                                    <button type="button" class="attachment-btn" id="addFileBtn">
                                        <i class="fas fa-paperclip"></i>
                                        <span>Файл</span>
                                    </button>
                                    <button type="button" class="attachment-btn" id="addVoiceBtn">
                                        <i class="fas fa-microphone"></i>
                                        <span>Голос</span>
                                    </button>
                                </div>
                                <button class="btn btn-primary" id="publishPostBtn">
                                    <i class="fas fa-paper-plane"></i> Опубликовать
                                </button>
                            </div>
                            <div id="postAttachments" class="hidden mt-3"></div>
                        </div>

                        <!-- Посты -->
                        <div id="postsContainer"></div>

                        <!-- Загрузка -->
                        <div id="postsLoader" class="hidden text-center py-4">
                            <div class="spinner">
                                <i class="fas fa-circle-notch"></i>
                            </div>
                        </div>

                        <!-- Пустая лента -->
                        <div class="card hidden" id="emptyFeed">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-feather-alt icon-xl text-muted mb-3"></i>
                                <h3 class="mb-2">Лента пуста</h3>
                                <p class="text-muted mb-4">Будьте первым, кто опубликует что-нибудь!</p>
                                <button class="btn btn-primary" id="emptyFeedPostBtn">
                                    <i class="fas fa-plus"></i> Создать первый пост
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Правая панель (онлайн, рекомендации) -->
                    <div class="right-panel">
                        <!-- Онлайн сейчас -->
                        <div class="card panel-section">
                            <div class="card-header">
                                <div class="card-title">Онлайн сейчас</div>
                            </div>
                            <div class="card-body">
                                <div id="onlineUsersList"></div>
                            </div>
                        </div>

                        <!-- Рекомендации -->
                        <div class="card panel-section">
                            <div class="card-header">
                                <div class="card-title">Рекомендуем подписаться</div>
                            </div>
                            <div class="card-body">
                                <div id="recommendedUsersList"></div>
                            </div>
                        </div>

                        <!-- Популярные группы -->
                        <div class="card panel-section">
                            <div class="card-header">
                                <div class="card-title">Популярные группы</div>
                            </div>
                            <div class="card-body">
                                <div id="popularGroupsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница профиля -->
        <div id="profilePage" class="page hidden">
            <div class="container" id="profileContainer">
                <!-- Заголовок профиля будет вставляться через JS -->
            </div>
        </div>

        <!-- Страница сообщений -->
        <div id="messagesPage" class="page hidden">
            <div class="container">
                <h1 class="page-title">
                    <i class="fas fa-comments"></i>
                    Сообщения
                </h1>
                <div class="messages-container" id="messagesContainer">
                    <!-- Содержимое будет вставляться через JS -->
                </div>
            </div>
        </div>

        <!-- Страница групп -->
        <div id="groupsPage" class="page hidden">
            <div class="container">
                <div class="d-flex align-center justify-between mb-4">
                    <h1 class="page-title">
                        <i class="fas fa-users"></i>
                        Группы и сообщества
                    </h1>
                    <button class="btn btn-primary" id="createGroupBtn">
                        <i class="fas fa-plus"></i> Создать группу
                    </button>
                </div>
                
                <!-- Табы групп -->
                <div class="card mb-4">
                    <div class="tab-list">
                        <div class="tab active" data-tab="all">Все группы</div>
                        <div class="tab" data-tab="my">Мои группы <span class="tab-badge" id="myGroupsCount">0</span></div>
                        <div class="tab" data-tab="channels">Каналы</div>
                        <div class="tab" data-tab="communities">Сообщества</div>
                    </div>
                    <div class="tab-content">
                        <div id="groupsContent">
                            <div class="groups-grid" id="allGroupsGrid"></div>
                            <div class="groups-grid hidden" id="myGroupsGrid"></div>
                            <div class="groups-grid hidden" id="channelsGrid"></div>
                            <div class="groups-grid hidden" id="communitiesGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница уведомлений -->
        <div id="notificationsPage" class="page hidden">
            <div class="container">
                <div class="d-flex align-center justify-between mb-4">
                    <h1 class="page-title">
                        <i class="fas fa-bell"></i>
                        Уведомления
                    </h1>
                    <button class="btn btn-secondary" id="markAllReadBtn">
                        <i class="fas fa-check-double"></i> Прочитать все
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div id="notificationsList">
                            <!-- Уведомления будут загружены через JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Админ панель -->
        <div id="adminPage" class="page hidden">
            <div class="container">
                <div class="admin-panel">
                    <h1 class="mb-3">
                        <i class="fas fa-shield-alt"></i> Админ панель
                    </h1>
                    <p>Управление системой и пользователями</p>
                    
                    <div class="admin-stats">
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="adminTotalUsers">0</div>
                            <div class="admin-stat-label">Пользователей</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="adminOnlineUsers">0</div>
                            <div class="admin-stat-label">Онлайн сейчас</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="adminTotalPosts">0</div>
                            <div class="admin-stat-label">Постов</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="adminTotalGroups">0</div>
                            <div class="admin-stat-label">Групп</div>
                        </div>
                    </div>
                </div>

                <!-- Верификация пользователей -->
                <div class="admin-section">
                    <h2 class="mb-3">
                        <i class="fas fa-user-check"></i> Верификация пользователей
                    </h2>
                    <div class="admin-users-list" id="adminUsersList"></div>
                </div>

                <!-- Управление группами -->
                <div class="admin-section">
                    <h2 class="mb-3">
                        <i class="fas fa-users-cog"></i> Управление группами
                    </h2>
                    <div id="adminGroupsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    
    <!-- Модалка выбора эмодзи для клана -->
    <div class="modal-overlay" id="clanModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Выберите клан</h2>
                <button class="modal-close" id="closeClanModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="emoji-selector" id="clanEmojiSelector"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelClanBtn">Отмена</button>
                <button class="btn btn-primary" id="saveClanBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модалка редактирования профиля -->
    <div class="modal-overlay" id="editProfileModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Редактировать профиль</h2>
                <button class="modal-close" id="closeEditProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Отображаемое имя</label>
                    <input type="text" id="editDisplayName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">О себе</label>
                    <textarea id="editBio" class="form-control" rows="4" placeholder="Расскажите о себе..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Статус</label>
                    <input type="text" id="editStatus" class="form-control" placeholder="Ваш статус...">
                </div>
                <div class="form-group">
                    <label class="form-label">Аватарка (эмодзи)</label>
                    <div class="emoji-selector" id="editEmojiSelector"></div>
                    <input type="hidden" id="editEmoji" value="😀">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditProfileBtn">Отмена</button>
                <button class="btn btn-primary" id="saveProfileBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модалка создания группы -->
    <div class="modal-overlay" id="createGroupModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 class="modal-title">Создать группу</h2>
                <button class="modal-close" id="closeCreateGroupModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Тип</label>
                    <div class="d-flex gap-2 mb-3" id="groupTypeSelector">
                        <button type="button" class="btn btn-secondary flex-1 active" data-group-type="group">Группа</button>
                        <button type="button" class="btn btn-secondary flex-1" data-group-type="channel">Канал</button>
                        <button type="button" class="btn btn-secondary flex-1" data-group-type="community">Сообщество</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Название</label>
                    <input type="text" id="groupName" class="form-control" placeholder="Название группы" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Юзернейм</label>
                    <input type="text" id="groupUsername" class="form-control" placeholder="@groupname" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea id="groupDescription" class="form-control" rows="3" placeholder="Опишите вашу группу..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Аватарка (эмодзи)</label>
                    <div class="emoji-selector" id="groupEmojiSelector"></div>
                    <input type="hidden" id="groupEmoji" value="👥">
                </div>
                <div class="form-group">
                    <label class="form-label">Приватность</label>
                    <div class="d-flex gap-2" id="groupPrivacySelector">
                        <button type="button" class="btn btn-secondary flex-1 active" data-privacy="public">Публичная</button>
                        <button type="button" class="btn btn-secondary flex-1" data-privacy="private">Приватная</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateGroupBtn">Отмена</button>
                <button class="btn btn-primary" id="saveGroupBtn">Создать</button>
            </div>
        </div>
    </div>

    <!-- Модалка голосового сообщения -->
    <div class="modal-overlay" id="voiceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Голосовое сообщение</h2>
                <button class="modal-close" id="closeVoiceModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="voice-waveform mb-3">
                        <div class="voice-wave"></div>
                    </div>
                    <button class="btn btn-primary btn-lg" id="recordVoiceBtn">
                        <i class="fas fa-microphone"></i> Начать запись
                    </button>
                    <div class="mt-3 text-muted" id="recordingTime">00:00</div>
                    <audio id="voicePreview" class="hidden" controls></audio>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelVoiceBtn">Отмена</button>
                <button class="btn btn-primary hidden" id="sendVoiceBtn">Отправить</button>
            </div>
        </div>
    </div>

    <!-- Модалка выбора файла -->
    <div class="modal-overlay" id="fileModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Выберите файл</h2>
                <button class="modal-close" id="closeFileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <label for="fileInput" class="btn btn-primary btn-lg mb-3">
                        <i class="fas fa-upload"></i> Выбрать файл
                    </label>
                    <input type="file" id="fileInput" class="d-none" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
                    <div class="text-muted mt-2">
                        Поддерживаются: изображения, видео, PDF, документы
                    </div>
                    <div id="filePreview" class="mt-3 hidden">
                        <img id="previewImage" class="w-100 rounded" style="max-height: 200px; object-fit: cover;">
                        <div id="previewFileInfo" class="mt-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelFileBtn">Отмена</button>
                <button class="btn btn-primary hidden" id="uploadFileBtn">Загрузить</button>
            </div>
        </div>
    </div>

    <!-- Вложенные компоненты -->
    <script type="text/template" id="postTemplate">
        <div class="card post" data-post-id="{{id}}">
            {{#if isRepost}}
            <div class="repost-header">
                <i class="fas fa-retweet"></i>
                <span>{{user.username}} репостнул(а)</span>
            </div>
            {{/if}}
            
            <div class="post-header">
                <div class="post-author">
                    <div class="user-avatar cursor-pointer view-profile" data-user-id="{{user.id}}">
                        <span>{{user.emoji}}</span>
                        <div class="status-indicator {{#if user.is_online}}status-online{{else}}status-offline{{/if}}"></div>
                    </div>
                    <div class="post-author-info">
                        <div class="post-author-name">
                            <span class="view-profile cursor-pointer" data-user-id="{{user.id}}">{{user.username}}</span>
                            {{#if user.is_verified}}
                            <i class="fas fa-check-circle verified-badge"></i>
                            {{/if}}
                        </div>
                        <div class="post-meta">
                            <span class="post-time" title="{{created_at}}">{{timeAgo}}</span>
                            {{#if hasAttachment}}
                            <i class="fas fa-paperclip"></i>
                            {{/if}}
                            {{#if hasVoice}}
                            <i class="fas fa-microphone"></i>
                            {{/if}}
                        </div>
                    </div>
                </div>
                <button class="btn-icon post-menu-btn" data-post-id="{{id}}">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
            </div>

            <div class="post-content">
                {{content}}
                
                {{#if hasAttachment}}
                <div class="post-attachment mt-3">
                    {{#if isImage}}
                    <img src="{{attachmentUrl}}" alt="{{attachmentName}}" loading="lazy">
                    {{else}}
                    <div class="attachment-info">
                        <i class="fas fa-file"></i>
                        <span>{{attachmentName}} ({{attachmentSize}})</span>
                    </div>
                    {{/if}}
                </div>
                {{/if}}

                {{#if hasVoice}}
                <div class="voice-message mt-3">
                    <button class="voice-play-btn">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="voice-waveform">
                        <div class="voice-wave"></div>
                    </div>
                    <div class="voice-duration">{{voiceDuration}}</div>
                </div>
                {{/if}}

                {{#if isRepost}}
                <div class="repost-content mt-3">
                    <div class="post-author mb-2">
                        <div class="user-avatar">
                            <span>{{originalPost.user.emoji}}</span>
                        </div>
                        <div class="post-author-info">
                            <div class="post-author-name">
                                {{originalPost.user.username}}
                                {{#if originalPost.user.is_verified}}
                                <i class="fas fa-check-circle verified-badge"></i>
                                {{/if}}
                            </div>
                            <div class="post-meta">
                                <span class="post-time">{{originalPost.timeAgo}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="post-content">
                        {{originalPost.content}}
                    </div>
                </div>
                {{/if}}
            </div>

            <div class="post-actions-footer">
                <button class="action-btn like-btn {{#if liked}}liked{{/if}}" data-post-id="{{id}}" title="Нравится">
                    <i class="{{#if liked}}fas{{else}}far{{/if}} fa-heart"></i>
                    <span class="action-count">{{likesCount}}</span>
                </button>
                <button class="action-btn comment-btn" data-post-id="{{id}}" title="Комментировать">
                    <i class="far fa-comment"></i>
                    <span class="action-count">{{commentsCount}}</span>
                </button>
                <button class="action-btn repost-btn" data-post-id="{{id}}" title="Репост">
                    <i class="fas fa-retweet"></i>
                    <span class="action-count">{{repostsCount}}</span>
                </button>
                <button class="action-btn share-btn" data-post-id="{{id}}" title="Поделиться">
                    <i class="fas fa-share"></i>
                </button>
            </div>

            <div class="comments-section hidden" id="comments-{{id}}">
                <div class="comments-list" id="comments-list-{{id}}">
                    <!-- Комментарии будут загружены динамически -->
                </div>
                <div class="add-comment">
                    <textarea class="comment-input" placeholder="Написать комментарий..." data-post-id="{{id}}"></textarea>
                    <button class="btn btn-primary send-comment-btn" data-post-id="{{id}}">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </script>

    <script type="text/template" id="commentTemplate">
        <div class="comment" data-comment-id="{{id}}">
            <div class="comment-avatar view-profile cursor-pointer" data-user-id="{{user.id}}">
                <span>{{user.emoji}}</span>
            </div>
            <div class="comment-content">
                <div class="comment-header">
                    <div class="comment-author view-profile cursor-pointer" data-user-id="{{user.id}}">
                        {{user.username}}
                    </div>
                    <div class="comment-time">{{timeAgo}}</div>
                </div>
                <div class="comment-text">{{content}}</div>
            </div>
        </div>
    </script>

    <script type="text/template" id="conversationTemplate">
        <div class="conversation-item" data-conversation-id="{{id}}">
            <div class="conversation-avatar">
                <span>{{avatar}}</span>
                {{#if is_online}}
                <div class="status-indicator status-online"></div>
                {{/if}}
            </div>
            <div class="conversation-info">
                <div class="conversation-name">
                    {{name}}
                    {{#if is_verified}}
                    <i class="fas fa-check-circle verified-badge"></i>
                    {{/if}}
                </div>
                <div class="conversation-last-message">{{last_message}}</div>
            </div>
            <div class="conversation-time">{{last_message_time}}</div>
        </div>
    </script>

    <script type="text/template" id="messageTemplate">
        <div class="message {{#if outgoing}}outgoing{{/if}}" data-message-id="{{id}}">
            <div class="message-content">
                {{content}}
                {{#if file_url}}
                <div class="mt-2">
                    <a href="{{file_url}}" target="_blank" class="d-flex align-center gap-2">
                        <i class="fas fa-paperclip"></i>
                        <span>{{file_name}}</span>
                    </a>
                </div>
                {{/if}}
                <div class="message-time">{{created_at}}</div>
            </div>
        </div>
    </script>

    <script type="text/template" id="profileTemplate">
        <div class="profile-header">
            <div class="profile-cover">
                <div class="profile-cover-actions">
                    {{#if is_own_profile}}
                    <button class="btn btn-secondary" id="editProfileCoverBtn">
                        <i class="fas fa-camera"></i>
                    </button>
                    {{else}}
                    <button class="btn {{#if is_following}}btn-danger{{else}}btn-primary{{/if}} follow-btn" data-user-id="{{id}}">
                        {{#if is_following}}
                        <i class="fas fa-user-minus"></i> Отписаться
                        {{else}}
                        <i class="fas fa-user-plus"></i> Подписаться
                        {{/if}}
                    </button>
                    {{/if}}
                </div>
            </div>
            <div class="profile-info">
                <div class="profile-avatar-large">
                    <span>{{emoji}}</span>
                    <div class="status-indicator {{#if is_online}}status-online{{else}}status-offline{{/if}}"></div>
                </div>
                <div class="profile-main-info">
                    <h1 class="profile-name-large">
                        {{display_name}}
                        {{#if is_verified}}
                        <i class="fas fa-check-circle verified-badge"></i>
                        {{/if}}
                    </h1>
                    <div class="profile-username-large">{{username}}</div>
                    <div class="profile-bio-large">{{description}}</div>
                    
                    <div class="profile-stats-large">
                        <div class="profile-stat-large">
                            <div class="profile-stat-value-large">{{posts_count}}</div>
                            <div class="profile-stat-label-large">Постов</div>
                        </div>
                        <div class="profile-stat-large">
                            <div class="profile-stat-value-large followers-count" data-user-id="{{id}}">{{followers_count}}</div>
                            <div class="profile-stat-label-large">Подписчиков</div>
                        </div>
                        <div class="profile-stat-large">
                            <div class="profile-stat-value-large following-count" data-user-id="{{id}}">{{following_count}}</div>
                            <div class="profile-stat-label-large">Подписок</div>
                        </div>
                    </div>

                    <div class="profile-actions-large">
                        {{#if is_own_profile}}
                        <button class="btn btn-primary" id="profileEditBtn">
                            <i class="fas fa-edit"></i> Редактировать
                        </button>
                        <button class="btn btn-secondary" id="profileShareBtn">
                            <i class="fas fa-share"></i> Поделиться
                        </button>
                        {{else}}
                        <button class="btn btn-primary message-btn" data-user-id="{{id}}">
                            <i class="fas fa-envelope"></i> Сообщение
                        </button>
                        <button class="btn btn-secondary" id="profileReportBtn">
                            <i class="fas fa-flag"></i> Пожаловаться
                        </button>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>

        <div class="profile-tabs">
            <div class="tab-list">
                <div class="tab active" data-tab="posts">
                    Публикации
                    <span class="tab-badge">{{posts_count}}</span>
                </div>
                <div class="tab" data-tab="reposts">
                    Репосты
                    <span class="tab-badge">{{reposts_count}}</span>
                </div>
                <div class="tab" data-tab="media">
                    Медиа
                </div>
                <div class="tab" data-tab="followers">
                    Подписчики
                    <span class="tab-badge followers-count" data-user-id="{{id}}">{{followers_count}}</span>
                </div>
                <div class="tab" data-tab="following">
                    Подписки
                    <span class="tab-badge following-count" data-user-id="{{id}}">{{following_count}}</span>
                </div>
            </div>
            <div class="tab-content">
                <div id="profilePostsTab" class="tab-pane active">
                    <div id="profilePostsContainer"></div>
                </div>
                <div id="profileRepostsTab" class="tab-pane">
                    <div id="profileRepostsContainer"></div>
                </div>
                <!-- Остальные вкладки будут загружены динамически -->
            </div>
        </div>
    </script>

    <script type="text/template" id="groupCardTemplate">
        <div class="group-card" data-group-id="{{id}}">
            <div class="card-body">
                <div class="group-avatar">
                    <span>{{avatar}}</span>
                </div>
                <h3 class="group-name">{{name}}</h3>
                <div class="group-description">{{description}}</div>
                <div class="group-stats">
                    <div class="group-stat">
                        <div class="group-stat-value">{{members_count}}</div>
                        <div class="group-stat-label">Участников</div>
                    </div>
                    <div class="group-stat">
                        <div class="group-stat-value">{{posts_count}}</div>
                        <div class="group-stat-label">Постов</div>
                    </div>
                </div>
                <button class="btn btn-primary btn-block mt-3 join-group-btn" data-group-id="{{id}}">
                    {{#if is_member}}
                    <i class="fas fa-check"></i> Вы в группе
                    {{else}}
                    <i class="fas fa-plus"></i> Вступить
                    {{/if}}
                </button>
            </div>
        </div>
    </script>

    <!-- Основной JavaScript код -->
    <script>
        // ========== КОНФИГУРАЦИЯ ==========
        const SUPABASE_URL = 'https://kzbznupjamhualdewyxk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6YnpudXBqYW1odWFsZGV3eXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzNDY5OTQsImV4cCI6MjA1MzkyMjk5NH0.7Ll6UZ5BnQwJq9JYv2Z8X7Qw3y5X6Z8X7Qw3y5X6Z8';
        
        // Инициализируем Supabase клиент один раз
        let supabaseClient;
        try {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (error) {
            console.error('Ошибка создания Supabase клиента:', error);
        }
        
        const supabase = supabaseClient;
        
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let currentUser = null;
        let allUsers = [];
        let allPosts = [];
        let allGroups = [];
        let notifications = [];
        let conversations = [];
        let currentMessages = [];
        let currentConversation = null;
        let onlineUsers = new Set();
        let emojis = ['😀', '😎', '🤖', '👻', '🐱', '🦊', '🐶', '🦁', '🚀', '🎨', '🎮', '🎵', '📸', '📚', '🍳', '🌍', '👨‍💻', '👩‍💻', '🧠', '💡', '🔥', '🌟', '🌙', '☀️', '🌈', '🍕', '⚽', '🎭', '🎸', '🎬', '👑', '💎', '⭐', '🎯', '🏆', '🚀', '🎪', '🎨', '📚', '🔬', '💼', '🎭', '🎪', '🎸', '🎤', '🎬', '🎮', '🎲', '🏀', '⚽', '🎾', '🏐', '🎯', '♟️', '🎳', '🎰'];
        let selectedFile = null;
        let selectedVoice = null;
        let isRecording = false;
        let recordingTimer = null;
        let recordingSeconds = 0;
        
        // ========== СИСТЕМНЫЕ УВЕДОМЛЕНИЯ ==========
        function showNotification(title, message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-${icons[type] || 'info-circle'}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            container.appendChild(notification);
            
            const closeBtn = notification.querySelector('.notification-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    notification.classList.add('hiding');
                    setTimeout(() => notification.remove(), 300);
                });
            }
            
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.classList.add('hiding');
                        setTimeout(() => notification.remove(), 300);
                    }
                }, duration);
            }
            
            return notification;
        }
        
        // ========== ФОРМАТИРОВАНИЕ ВРЕМЕНИ ==========
        function formatTimeAgo(dateString) {
            if (!dateString) return 'давно';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'только что';
            if (diffMins < 60) return `${diffMins} мин. назад`;
            if (diffHours < 24) return `${diffHours} ч. назад`;
            if (diffDays < 7) return `${diffDays} д. назад`;
            
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short',
                year: diffDays > 365 ? 'numeric' : undefined
            });
        }
        
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // ========== РАБОТА С SUPABASE ==========
        async function loadInitialData() {
            if (!supabase) {
                console.warn('Supabase не инициализирован, работаем в демо-режиме');
                await loadDemoData();
                return true;
            }
            
            try {
                // Загружаем пользователей
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (usersError) {
                    console.error('Ошибка загрузки пользователей:', usersError);
                    allUsers = [];
                } else {
                    allUsers = users || [];
                }
                
                // Загружаем посты
                const { data: posts, error: postsError } = await supabase
                    .from('posts')
                    .select(`
                        *,
                        user:users(*)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (postsError) {
                    console.error('Ошибка загрузки постов:', postsError);
                    allPosts = [];
                } else {
                    allPosts = posts || [];
                }
                
                // Загружаем группы
                const { data: groups, error: groupsError } = await supabase
                    .from('groups')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (groupsError) {
                    console.error('Ошибка загрузки групп:', groupsError);
                    allGroups = [];
                } else {
                    allGroups = groups || [];
                }
                
                // Загружаем уведомления для текущего пользователя
                if (currentUser) {
                    await loadNotifications();
                    await loadConversations();
                }
                
                return true;
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                await loadDemoData();
                return false;
            }
        }
        
        async function loadDemoData() {
            // Создаем демо-данные для работы без базы данных
            console.log('Загружаем демо-данные');
            
            // Демо пользователи
            allUsers = [
                {
                    id: 'demo-onegin',
                    username: '@onegin',
                    display_name: 'Евгений Онегин',
                    emoji: '👑',
                    description: 'Владелец социальной сети "Зеркало"',
                    is_verified: true,
                    posts_count: 5,
                    followers_count: 1000,
                    following_count: 50,
                    following: [],
                    clan: '👑',
                    created_at: new Date().toISOString()
                },
                {
                    id: 'demo-pushkin',
                    username: '@pushkin',
                    display_name: 'Александр Пушкин',
                    emoji: '📚',
                    description: 'Великий русский поэт',
                    is_verified: true,
                    posts_count: 3,
                    followers_count: 800,
                    following_count: 30,
                    following: ['demo-onegin'],
                    clan: '📚',
                    created_at: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    id: 'demo-lermontov',
                    username: '@lermontov',
                    display_name: 'Михаил Лермонтов',
                    emoji: '⚔️',
                    description: 'Поэт и офицер',
                    is_verified: false,
                    posts_count: 2,
                    followers_count: 500,
                    following_count: 20,
                    following: ['demo-onegin', 'demo-pushkin'],
                    clan: '⚔️',
                    created_at: new Date(Date.now() - 172800000).toISOString()
                }
            ];
            
            // Демо посты
            allPosts = [
                {
                    id: 'post-1',
                    user_id: 'demo-onegin',
                    user: allUsers[0],
                    content: 'Привет! Это первый пост в социальной сети "Зеркало"! Добро пожаловать!',
                    likes: ['demo-onegin', 'demo-pushkin'],
                    comments_count: 2,
                    reposts_count: 1,
                    created_at: new Date(Date.now() - 3600000).toISOString()
                },
                {
                    id: 'post-2',
                    user_id: 'demo-pushkin',
                    user: allUsers[1],
                    content: 'Я люблю вашу социальную сеть! Отличная работа!',
                    likes: ['demo-onegin'],
                    comments_count: 1,
                    reposts_count: 0,
                    created_at: new Date(Date.now() - 7200000).toISOString()
                },
                {
                    id: 'post-3',
                    user_id: 'demo-lermontov',
                    user: allUsers[2],
                    content: 'Провожу тестирование новой функциональности. Все работает отлично!',
                    likes: ['demo-onegin', 'demo-pushkin'],
                    comments_count: 0,
                    reposts_count: 0,
                    created_at: new Date(Date.now() - 10800000).toISOString()
                }
            ];
            
            // Демо группы
            allGroups = [
                {
                    id: 'group-1',
                    name: 'Разработчики',
                    avatar: '👨‍💻',
                    description: 'Сообщество разработчиков социальной сети "Зеркало"',
                    members: ['demo-onegin', 'demo-pushkin'],
                    creator_id: 'demo-onegin',
                    members_count: 2,
                    posts_count: 5,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'group-2',
                    name: 'Поэты',
                    avatar: '📚',
                    description: 'Клуб любителей поэзии и литературы',
                    members: ['demo-pushkin', 'demo-lermontov'],
                    creator_id: 'demo-pushkin',
                    members_count: 2,
                    posts_count: 3,
                    created_at: new Date(Date.now() - 86400000).toISOString()
                }
            ];
            
            // Добавляем текущего пользователя в онлайн
            if (currentUser) {
                onlineUsers.add(currentUser.id);
            }
            
            return true;
        }
        
        async function loadNotifications() {
            if (!currentUser) return;
            
            // В демо-режиме создаем тестовые уведомления
            notifications = [
                {
                    id: 'notif-1',
                    user_id: currentUser.id,
                    from_user_id: 'demo-pushkin',
                    type: 'follow',
                    message: '@pushkin подписался на вас',
                    is_read: false,
                    created_at: new Date(Date.now() - 1800000).toISOString()
                },
                {
                    id: 'notif-2',
                    user_id: currentUser.id,
                    from_user_id: 'demo-lermontov',
                    type: 'like',
                    message: '@lermontov поставил лайк вашему посту',
                    is_read: true,
                    created_at: new Date(Date.now() - 3600000).toISOString()
                }
            ];
            
            // Обновляем бейдж
            const unreadCount = notifications.filter(n => !n.is_read).length;
            const badge = document.getElementById('notificationsBadge');
            if (badge) {
                badge.textContent = unreadCount;
                badge.classList.toggle('hidden', unreadCount === 0);
            }
            
            // Если открыта страница уведомлений, обновляем список
            if (document.getElementById('notificationsPage') && !document.getElementById('notificationsPage').classList.contains('hidden')) {
                renderNotifications();
            }
        }
        
        async function loadConversations() {
            if (!currentUser) return;
            
            // В демо-режиме создаем тестовые диалоги
            conversations = [
                {
                    id: 'conv-1',
                    name: 'Александр Пушкин',
                    avatar: '📚',
                    is_online: true,
                    last_message: 'Привет! Как дела?',
                    last_message_time: '10:30',
                    created_at: new Date().toISOString()
                },
                {
                    id: 'conv-2',
                    name: 'Михаил Лермонтов',
                    avatar: '⚔️',
                    is_online: false,
                    last_message: 'Спасибо за подписку!',
                    last_message_time: 'Вчера',
                    created_at: new Date(Date.now() - 86400000).toISOString()
                }
            ];
            
            // Если открыта страница сообщений, обновляем список
            if (document.getElementById('messagesPage') && !document.getElementById('messagesPage').classList.contains('hidden')) {
                renderConversations();
            }
        }
        
        // ========== РЕНДЕРИНГ ИНТЕРФЕЙСА ==========
        function updateUI() {
            if (!currentUser) return;
            
            // Обновляем информацию в шапке
            const userAvatarEmoji = document.getElementById('userAvatarEmoji');
            const profileEmoji = document.getElementById('profileEmoji');
            const currentUserEmoji = document.getElementById('currentUserEmoji');
            const profileName = document.getElementById('profileName');
            const profileUsername = document.getElementById('profileUsername');
            const profileClan = document.getElementById('profileClan');
            const profileBio = document.getElementById('profileBio');
            const statPosts = document.getElementById('statPosts');
            const statFollowers = document.getElementById('statFollowers');
            const statFollowing = document.getElementById('statFollowing');
            
            if (userAvatarEmoji) userAvatarEmoji.textContent = currentUser.emoji;
            if (profileEmoji) profileEmoji.textContent = currentUser.emoji;
            if (currentUserEmoji) currentUserEmoji.textContent = currentUser.emoji;
            if (profileName) profileName.textContent = currentUser.display_name;
            if (profileUsername) profileUsername.textContent = currentUser.username;
            if (profileClan) profileClan.textContent = `${currentUser.clan} Клан`;
            if (profileBio) profileBio.textContent = currentUser.description || 'Пользователь пока ничего не написал в описании';
            if (statPosts) statPosts.textContent = currentUser.posts_count || 0;
            if (statFollowers) statFollowers.textContent = currentUser.followers_count || 0;
            if (statFollowing) statFollowing.textContent = currentUser.following_count || 0;
            
            // Показываем галочку верификации
            const verifiedBadge = document.getElementById('profileVerifiedBadge');
            if (verifiedBadge) {
                verifiedBadge.classList.toggle('hidden', !currentUser.is_verified);
            }
            
            // Показываем админку если пользователь @onegin
            const adminNav = document.getElementById('navAdmin');
            if (adminNav && currentUser.username === '@onegin') {
                adminNav.classList.remove('hidden');
            }
            
            // Обновляем онлайн статус
            updateOnlineStatus();
            
            // Загружаем рекомендации и онлайн пользователей
            loadOnlineUsers();
            loadRecommendedUsers();
            loadPopularGroups();
        }
        
        function updateOnlineStatus() {
            if (!currentUser) return;
            
            // Отмечаем текущего пользователя как онлайн
            onlineUsers.add(currentUser.id);
            
            // Добавляем демо-пользователей в онлайн
            onlineUsers.add('demo-pushkin');
            
            // Обновляем статус в интерфейсе
            const statusIndicators = document.querySelectorAll('.status-indicator');
            statusIndicators.forEach(indicator => {
                const userId = indicator.closest('[data-user-id]')?.dataset.userId;
                if (userId) {
                    indicator.className = 'status-indicator ' + 
                        (onlineUsers.has(userId) ? 'status-online status-pulse' : 'status-offline');
                }
            });
            
            // Обновляем счетчик онлайн
            const onlineCount = document.getElementById('onlineCount');
            if (onlineCount) {
                onlineCount.textContent = `${onlineUsers.size} онлайн`;
            }
        }
        
        function loadOnlineUsers() {
            const container = document.getElementById('onlineUsersList');
            if (!container) return;
            
            // Показываем только онлайн пользователей, исключая текущего
            const online = allUsers.filter(user => 
                onlineUsers.has(user.id) && user.id !== currentUser?.id
            ).slice(0, 10);
            
            if (online.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">Нет пользователей онлайн</div>';
                return;
            }
            
            container.innerHTML = online.map(user => `
                <div class="online-user" data-user-id="${user.id}">
                    <div class="online-user-avatar">
                        <span>${user.emoji}</span>
                        <div class="status-indicator status-online"></div>
                    </div>
                    <div class="online-user-info">
                        <div class="online-user-name">${user.username}</div>
                        <div class="online-user-status">В сети</div>
                    </div>
                </div>
            `).join('');
            
            // Добавляем обработчики кликов
            container.querySelectorAll('.online-user').forEach(item => {
                item.addEventListener('click', () => {
                    const userId = item.dataset.userId;
                    showUserProfile(userId);
                });
            });
        }
        
        function loadRecommendedUsers() {
            const container = document.getElementById('recommendedUsersList');
            if (!container) return;
            
            // Рекомендуем пользователей, на которых не подписан текущий пользователь
            const following = currentUser?.following || [];
            const recommended = allUsers
                .filter(user => 
                    user.id !== currentUser?.id && 
                    !following.includes(user.id)
                )
                .sort(() => Math.random() - 0.5)
                .slice(0, 5);
            
            if (recommended.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">Нет рекомендаций</div>';
                return;
            }
            
            container.innerHTML = recommended.map(user => `
                <div class="recommended-user" data-user-id="${user.id}">
                    <div class="user-avatar">
                        <span>${user.emoji}</span>
                    </div>
                    <div class="recommended-user-info">
                        <div class="recommended-user-name">${user.username}</div>
                        <div class="recommended-user-bio">${user.description?.slice(0, 50) || 'Нет описания'}...</div>
                    </div>
                    <button class="btn btn-sm btn-primary follow-btn" data-user-id="${user.id}">
                        Подписаться
                    </button>
                </div>
            `).join('');
            
            // Добавляем обработчики
            container.querySelectorAll('.recommended-user').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('follow-btn')) {
                        const userId = item.dataset.userId;
                        showUserProfile(userId);
                    }
                });
            });
            
            container.querySelectorAll('.follow-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const userId = btn.dataset.userId;
                    await toggleFollow(userId);
                });
            });
        }
        
        function loadPopularGroups() {
            const container = document.getElementById('popularGroupsList');
            if (!container) return;
            
            const popular = allGroups
                .sort((a, b) => (b.members_count || 0) - (a.members_count || 0))
                .slice(0, 5);
            
            if (popular.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">Нет групп</div>';
                return;
            }
            
            container.innerHTML = popular.map(group => `
                <div class="online-user" data-group-id="${group.id}">
                    <div class="online-user-avatar">
                        <span>${group.avatar || '👥'}</span>
                    </div>
                    <div class="online-user-info">
                        <div class="online-user-name">${group.name}</div>
                        <div class="online-user-status">${group.members_count || 0} участников</div>
                    </div>
                </div>
            `).join('');
            
            // Добавляем обработчики кликов
            container.querySelectorAll('.online-user[data-group-id]').forEach(item => {
                item.addEventListener('click', () => {
                    const groupId = item.dataset.groupId;
                    showGroupInfo(groupId);
                });
            });
        }
        
        // ========== РЕНДЕРИНГ ПОСТОВ ==========
        function renderPosts(posts = allPosts) {
            const container = document.getElementById('postsContainer');
            const emptyFeed = document.getElementById('emptyFeed');
            const loader = document.getElementById('postsLoader');
            
            if (!container) return;
            
            // Скрываем лоадер
            if (loader) loader.classList.add('hidden');
            
            // Очищаем контейнер
            container.innerHTML = '';
            
            if (posts.length === 0) {
                if (emptyFeed) emptyFeed.classList.remove('hidden');
                return;
            }
            
            if (emptyFeed) emptyFeed.classList.add('hidden');
            
            // Рендерим посты
            posts.forEach(post => {
                try {
                    const postElement = createPostElement(post);
                    if (postElement) {
                        container.appendChild(postElement);
                    }
                } catch (error) {
                    console.error('Ошибка рендеринга поста:', error, post);
                }
            });
            
            // Добавляем обработчики событий
            addPostEventListeners();
        }
        
        function createPostElement(post) {
            const template = document.getElementById('postTemplate').innerHTML;
            const user = post.user || allUsers.find(u => u.id === post.user_id) || {
                id: post.user_id,
                username: 'Неизвестно',
                emoji: '😀',
                is_verified: false,
                is_online: false
            };
            
            const isLiked = post.likes?.includes(currentUser?.id) || false;
            const isImage = post.file_url && /\.(jpg|jpeg|png|gif|webp)$/i.test(post.file_url);
            const hasAttachment = !!post.file_url;
            const hasVoice = !!post.voice_url;
            
            // Подготовка данных для замены
            const replacements = {
                '{{id}}': post.id,
                '{{isRepost}}': post.original_post_id ? 'true' : '',
                '{{user.id}}': user.id,
                '{{user.username}}': user.username,
                '{{user.emoji}}': user.emoji,
                '{{user.is_online}}': onlineUsers.has(user.id) ? 'true' : '',
                '{{user.is_verified}}': user.is_verified ? 'true' : '',
                '{{created_at}}': post.created_at,
                '{{timeAgo}}': formatTimeAgo(post.created_at),
                '{{content}}': post.content || '',
                '{{hasAttachment}}': hasAttachment ? 'true' : '',
                '{{hasVoice}}': hasVoice ? 'true' : '',
                '{{attachmentUrl}}': post.file_url || '',
                '{{attachmentName}}': post.file_name || '',
                '{{attachmentSize}}': formatFileSize(post.file_size || 0),
                '{{isImage}}': isImage ? 'true' : '',
                '{{voiceDuration}}': post.voice_duration ? 
                    `${Math.floor(post.voice_duration / 60)}:${(post.voice_duration % 60).toString().padStart(2, '0')}` : '0:00',
                '{{liked}}': isLiked ? 'true' : '',
                '{{likesCount}}': post.likes?.length || 0,
                '{{commentsCount}}': post.comments_count || 0,
                '{{repostsCount}}': post.reposts_count || 0
            };
            
            let html = template;
            
            // Заменяем все переменные
            Object.keys(replacements).forEach(key => {
                html = html.replace(new RegExp(key, 'g'), replacements[key]);
            });
            
            // Удаляем условные блоки Handlebars
            html = html.replace(/\{\{#if ([^}]+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, condition, content) => {
                const conditionMet = evalCondition(condition, replacements);
                return conditionMet ? content : '';
            });
            
            // Удаляем оставшиеся выражения
            html = html.replace(/\{\{[^}]+\}\}/g, '');
            
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.firstElementChild;
        }
        
        function evalCondition(condition, data) {
            // Простая проверка условий
            if (condition === 'isRepost') return data['{{isRepost}}'] === 'true';
            if (condition === 'user.is_online') return data['{{user.is_online}}'] === 'true';
            if (condition === 'user.is_verified') return data['{{user.is_verified}}'] === 'true';
            if (condition === 'hasAttachment') return data['{{hasAttachment}}'] === 'true';
            if (condition === 'hasVoice') return data['{{hasVoice}}'] === 'true';
            if (condition === 'isImage') return data['{{isImage}}'] === 'true';
            if (condition === 'liked') return data['{{liked}}'] === 'true';
            if (condition === 'originalPost.user.is_verified') return false; // Для демо
            return false;
        }
        
        function addPostEventListeners() {
            // Лайки
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const postId = btn.dataset.postId;
                    await toggleLike(postId);
                });
            });
            
            // Комментарии
            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const postId = btn.dataset.postId;
                    const commentsSection = document.getElementById(`comments-${postId}`);
                    if (commentsSection) {
                        commentsSection.classList.toggle('hidden');
                        if (!commentsSection.classList.contains('hidden')) {
                            loadComments(postId);
                            // Фокус на поле комментария
                            const commentInput = commentsSection.querySelector('.comment-input');
                            if (commentInput) commentInput.focus();
                        }
                    }
                });
            });
            
            // Репосты
            document.querySelectorAll('.repost-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const postId = btn.dataset.postId;
                    await createRepost(postId);
                });
            });
            
            // Поделиться
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const postId = btn.dataset.postId;
                    const postUrl = `${window.location.origin}?post=${postId}`;
                    navigator.clipboard.writeText(postUrl).then(() => {
                        showNotification('Успех', 'Ссылка скопирована в буфер обмена', 'success');
                    });
                });
            });
            
            // Отправка комментариев
            document.querySelectorAll('.send-comment-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const postId = btn.dataset.postId;
                    const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
                    if (input && input.value.trim()) {
                        await addComment(postId, input.value.trim());
                        input.value = '';
                    }
                });
            });
            
            // Enter для отправки комментария
            document.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const postId = input.dataset.postId;
                        const btn = document.querySelector(`.send-comment-btn[data-post-id="${postId}"]`);
                        if (btn) btn.click();
                    }
                });
            });
            
            // Просмотр профиля
            document.querySelectorAll('.view-profile').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = el.dataset.userId;
                    if (userId) showUserProfile(userId);
                });
            });
        }
        
        // ========== ВЗАИМОДЕЙСТВИЯ С ПОСТАМИ ==========
        async function toggleLike(postId) {
            if (!currentUser) {
                showNotification('Ошибка', 'Войдите в систему', 'error');
                return;
            }
            
            try {
                const post = allPosts.find(p => p.id === postId);
                if (!post) {
                    showNotification('Ошибка', 'Пост не найден', 'error');
                    return;
                }
                
                const likes = post.likes || [];
                const isLiked = likes.includes(currentUser.id);
                
                let newLikes;
                if (isLiked) {
                    newLikes = likes.filter(id => id !== currentUser.id);
                } else {
                    newLikes = [...likes, currentUser.id];
                }
                
                // В демо-режиме обновляем локально
                post.likes = newLikes;
                
                // Обновляем интерфейс
                const likeBtn = document.querySelector(`.like-btn[data-post-id="${postId}"]`);
                if (likeBtn) {
                    const icon = likeBtn.querySelector('i');
                    const count = likeBtn.querySelector('.action-count');
                    
                    if (isLiked) {
                        icon.className = 'far fa-heart';
                        likeBtn.classList.remove('liked');
                    } else {
                        icon.className = 'fas fa-heart';
                        likeBtn.classList.add('liked');
                    }
                    
                    count.textContent = newLikes.length;
                }
                
                // Пытаемся обновить в Supabase, если доступен
                if (supabase) {
                    const { error } = await supabase
                        .from('posts')
                        .update({ likes: newLikes })
                        .eq('id', postId);
                    
                    if (error) {
                        console.error('Ошибка обновления лайка в базе:', error);
                    }
                }
                
                // Отправляем уведомление
                if (!isLiked && post.user_id !== currentUser.id) {
                    await createNotification(post.user_id, 'like', postId);
                }
                
            } catch (error) {
                console.error('Ошибка лайка:', error);
                showNotification('Ошибка', 'Не удалось поставить лайк', 'error');
            }
        }
        
        async function addComment(postId, content) {
            if (!currentUser) {
                showNotification('Ошибка', 'Войдите в систему', 'error');
                return;
            }
            
            try {
                const post = allPosts.find(p => p.id === postId);
                if (!post) {
                    showNotification('Ошибка', 'Пост не найден', 'error');
                    return;
                }
                
                const newComment = {
                    id: 'comment-' + Date.now(),
                    user_id: currentUser.id,
                    user: {
                        id: currentUser.id,
                        username: currentUser.username,
                        emoji: currentUser.emoji,
                        is_verified: currentUser.is_verified
                    },
                    content,
                    created_at: new Date().toISOString()
                };
                
                // Обновляем локально
                post.comments = post.comments || [];
                post.comments.push(newComment);
                post.comments_count = (post.comments_count || 0) + 1;
                
                // Обновляем интерфейс
                const commentsList = document.getElementById(`comments-list-${postId}`);
                if (commentsList) {
                    const template = document.getElementById('commentTemplate').innerHTML;
                    let html = template;
                    
                    const replacements = {
                        '{{id}}': newComment.id,
                        '{{user.id}}': newComment.user.id,
                        '{{user.username}}': newComment.user.username,
                        '{{user.emoji}}': newComment.user.emoji,
                        '{{timeAgo}}': 'только что',
                        '{{content}}': newComment.content
                    };
                    
                    Object.keys(replacements).forEach(key => {
                        html = html.replace(new RegExp(key, 'g'), replacements[key]);
                    });
                    
                    commentsList.insertAdjacentHTML('beforeend', html);
                    
                    // Добавляем обработчик клика на профиль
                    const newCommentEl = commentsList.lastElementChild;
                    newCommentEl.querySelectorAll('.view-profile').forEach(el => {
                        el.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const userId = el.dataset.userId;
                            if (userId) showUserProfile(userId);
                        });
                    });
                }
                
                // Обновляем счетчик комментариев
                const commentBtn = document.querySelector(`.comment-btn[data-post-id="${postId}"]`);
                if (commentBtn) {
                    const count = commentBtn.querySelector('.action-count');
                    if (count) {
                        count.textContent = post.comments_count;
                    }
                }
                
                // Пытаемся обновить в Supabase
                if (supabase) {
                    const { error } = await supabase
                        .from('posts')
                        .update({ 
                            comments_count: post.comments_count
                        })
                        .eq('id', postId);
                    
                    if (error) console.error('Ошибка обновления комментариев:', error);
                }
                
                // Отправляем уведомление
                if (post.user_id !== currentUser.id) {
                    await createNotification(post.user_id, 'comment', postId);
                }
                
            } catch (error) {
                console.error('Ошибка комментария:', error);
                showNotification('Ошибка', 'Не удалось добавить комментарий', 'error');
            }
        }
        
        async function loadComments(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post || !post.comments) return;
            
            const container = document.getElementById(`comments-list-${postId}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            post.comments.forEach(comment => {
                const template = document.getElementById('commentTemplate').innerHTML;
                let html = template;
                
                const user = comment.user || allUsers.find(u => u.id === comment.user_id) || {
                    id: comment.user_id,
                    username: 'Неизвестно',
                    emoji: '😀'
                };
                
                const replacements = {
                    '{{id}}': comment.id || 'comment-' + Date.now(),
                    '{{user.id}}': user.id,
                    '{{user.username}}': user.username,
                    '{{user.emoji}}': user.emoji,
                    '{{timeAgo}}': formatTimeAgo(comment.created_at),
                    '{{content}}': comment.content
                };
                
                Object.keys(replacements).forEach(key => {
                    html = html.replace(new RegExp(key, 'g'), replacements[key]);
                });
                
                container.insertAdjacentHTML('beforeend', html);
            });
            
            // Добавляем обработчики клика на профиль
            container.querySelectorAll('.view-profile').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = el.dataset.userId;
                    if (userId) showUserProfile(userId);
                });
            });
        }
        
        async function createRepost(postId) {
            if (!currentUser) {
                showNotification('Ошибка', 'Войдите в систему', 'error');
                return;
            }
            
            try {
                const originalPost = allPosts.find(p => p.id === postId);
                if (!originalPost) {
                    showNotification('Ошибка', 'Пост не найден', 'error');
                    return;
                }
                
                const newPost = {
                    id: 'repost-' + Date.now(),
                    user_id: currentUser.id,
                    user: currentUser,
                    content: '',
                    original_post_id: postId,
                    original_post: originalPost,
                    likes: [],
                    comments_count: 0,
                    reposts_count: 0,
                    created_at: new Date().toISOString()
                };
                
                // Обновляем локально
                allPosts.unshift(newPost);
                originalPost.reposts_count = (originalPost.reposts_count || 0) + 1;
                
                // Обновляем интерфейс
                renderPosts(allPosts);
                
                // Пытаемся обновить в Supabase
                if (supabase) {
                    const { error } = await supabase
                        .from('posts')
                        .update({ 
                            reposts_count: originalPost.reposts_count 
                        })
                        .eq('id', postId);
                    
                    if (error) console.error('Ошибка обновления репостов:', error);
                }
                
                // Отправляем уведомление
                if (originalPost.user_id !== currentUser.id) {
                    await createNotification(originalPost.user_id, 'repost', postId);
                }
                
                showNotification('Успех', 'Пост репостнут!', 'success');
                
            } catch (error) {
                console.error('Ошибка репоста:', error);
                showNotification('Ошибка', 'Не удалось сделать репост', 'error');
            }
        }
        
        // ========== СОЗДАНИЕ ПОСТА ==========
        async function createPost(content, attachments = {}) {
            if (!currentUser) {
                showNotification('Ошибка', 'Войдите в систему', 'error');
                return false;
            }
            
            if (!content.trim() && !attachments.file && !attachments.voice) {
                showNotification('Ошибка', 'Введите текст или добавьте вложение', 'error');
                return false;
            }
            
            try {
                const newPost = {
                    id: 'post-' + Date.now(),
                    user_id: currentUser.id,
                    user: currentUser,
                    content: content.trim(),
                    likes: [],
                    comments: [],
                    comments_count: 0,
                    reposts_count: 0,
                    created_at: new Date().toISOString()
                };
                
                // Добавляем вложения если есть
                if (attachments.file) {
                    newPost.file_url = attachments.file.url;
                    newPost.file_name = attachments.file.name;
                    newPost.file_size = attachments.file.size;
                }
                
                if (attachments.voice) {
                    newPost.voice_url = attachments.voice.url;
                    newPost.voice_duration = attachments.voice.duration;
                }
                
                // Обновляем счетчик постов у пользователя
                currentUser.posts_count = (currentUser.posts_count || 0) + 1;
                
                // Обновляем локально
                allPosts.unshift(newPost);
                
                // Обновляем интерфейс
                updateUI();
                renderPosts(allPosts);
                
                // Очищаем форму
                document.getElementById('postText').value = '';
                const attachmentsContainer = document.getElementById('postAttachments');
                if (attachmentsContainer) {
                    attachmentsContainer.innerHTML = '';
                    attachmentsContainer.classList.add('hidden');
                }
                
                // Сбрасываем выбранные файлы
                selectedFile = null;
                selectedVoice = null;
                
                // Пытаемся сохранить в Supabase
                if (supabase) {
                    const postData = {
                        user_id: currentUser.id,
                        content: newPost.content,
                        file_url: newPost.file_url,
                        file_name: newPost.file_name,
                        file_size: newPost.file_size,
                        voice_url: newPost.voice_url,
                        voice_duration: newPost.voice_duration,
                        likes: [],
                        comments: [],
                        comments_count: 0,
                        reposts_count: 0
                    };
                    
                    const { error } = await supabase
                        .from('posts')
                        .insert([postData]);
                    
                    if (error) throw error;
                    
                    // Обновляем пользователя в базе
                    await supabase
                        .from('users')
                        .update({ posts_count: currentUser.posts_count })
                        .eq('id', currentUser.id);
                }
                
                showNotification('Успех', 'Пост опубликован!', 'success');
                return true;
                
            } catch (error) {
                console.error('Ошибка создания поста:', error);
                showNotification('Ошибка', 'Не удалось опубликовать пост', 'error');
                return false;
            }
        }
        
        // ========== УПРАВЛЕНИЕ ПРОФИЛЕМ ==========
        async function showUserProfile(userId) {
            try {
                let user = allUsers.find(u => u.id === userId);
                if (!user) {
                    // Если пользователь не найден
                    showNotification('Ошибка', 'Пользователь не найден', 'error');
                    return;
                }
                
                // Загружаем посты пользователя
                const userPosts = allPosts.filter(p => p.user_id === userId && !p.original_post_id);
                const reposts = allPosts.filter(p => p.user_id === userId && p.original_post_id);
                
                // Подготавливаем данные для шаблона
                const isOwnProfile = currentUser && currentUser.id === userId;
                const isFollowing = currentUser?.following?.includes(userId) || false;
                
                const template = document.getElementById('profileTemplate').innerHTML;
                let html = template;
                
                const replacements = {
                    '{{id}}': user.id,
                    '{{username}}': user.username,
                    '{{display_name}}': user.display_name,
                    '{{emoji}}': user.emoji,
                    '{{description}}': user.description || 'Пользователь пока ничего не написал в описании',
                    '{{is_own_profile}}': isOwnProfile ? 'true' : '',
                    '{{is_following}}': isFollowing ? 'true' : '',
                    '{{is_online}}': onlineUsers.has(userId) ? 'true' : '',
                    '{{is_verified}}': user.is_verified ? 'true' : '',
                    '{{posts_count}}': user.posts_count || 0,
                    '{{followers_count}}': user.followers_count || 0,
                    '{{following_count}}': user.following_count || 0,
                    '{{reposts_count}}': reposts.length
                };
                
                // Заменяем все переменные
                Object.keys(replacements).forEach(key => {
                    html = html.replace(new RegExp(key, 'g'), replacements[key]);
                });
                
                // Удаляем условные блоки Handlebars
                html = html.replace(/\{\{#if ([^}]+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, condition, content) => {
                    if (condition === 'is_own_profile') return isOwnProfile ? content : '';
                    if (condition === 'is_following') return isFollowing ? content : '';
                    if (condition === 'is_online') return onlineUsers.has(userId) ? content : '';
                    if (condition === 'is_verified') return user.is_verified ? content : '';
                    return '';
                });
                
                // Удаляем оставшиеся выражения
                html = html.replace(/\{\{[^}]+\}\}/g, '');
                
                // Показываем страницу профиля
                const profilePage = document.getElementById('profilePage');
                const container = document.getElementById('profileContainer');
                
                if (!profilePage || !container) {
                    console.error('Не найдены элементы профиля');
                    return;
                }
                
                container.innerHTML = html;
                
                // Скрываем все страницы и показываем профиль
                hideAllPages();
                profilePage.classList.remove('hidden');
                
                // Убираем активный класс у всех навигационных ссылок
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                // Рендерим посты пользователя
                const postsContainer = document.getElementById('profilePostsContainer');
                if (postsContainer && userPosts.length > 0) {
                    postsContainer.innerHTML = '';
                    userPosts.forEach(post => {
                        const postElement = createPostElement(post);
                        if (postElement) {
                            postsContainer.appendChild(postElement);
                        }
                    });
                    addPostEventListeners();
                } else if (postsContainer) {
                    postsContainer.innerHTML = '<div class="text-center py-5 text-muted">Нет публикаций</div>';
                }
                
                // Рендерим репосты
                const repostsContainer = document.getElementById('profileRepostsContainer');
                if (repostsContainer && reposts.length > 0) {
                    repostsContainer.innerHTML = '';
                    reposts.forEach(post => {
                        const postElement = createPostElement(post);
                        if (postElement) {
                            repostsContainer.appendChild(postElement);
                        }
                    });
                    addPostEventListeners();
                } else if (repostsContainer) {
                    repostsContainer.innerHTML = '<div class="text-center py-5 text-muted">Нет репостов</div>';
                }
                
                // Добавляем обработчики событий
                setupProfileEventListeners(userId, isOwnProfile, isFollowing);
                
            } catch (error) {
                console.error('Ошибка загрузки профиля:', error);
                showNotification('Ошибка', 'Не удалось загрузить профиль', 'error');
                showPage('feed');
            }
        }
        
        function setupProfileEventListeners(userId, isOwnProfile, isFollowing) {
            // Кнопка подписки
            const followBtn = document.querySelector('.follow-btn');
            if (followBtn && !isOwnProfile) {
                followBtn.addEventListener('click', async () => {
                    await toggleFollow(userId);
                });
            }
            
            // Кнопка редактирования
            const editBtn = document.querySelector('#profileEditBtn');
            if (editBtn && isOwnProfile) {
                editBtn.addEventListener('click', () => {
                    showEditProfileModal();
                });
            }
            
            // Кнопка сообщения
            const messageBtn = document.querySelector('.message-btn');
            if (messageBtn && !isOwnProfile) {
                messageBtn.addEventListener('click', () => {
                    startConversation(userId);
                });
            }
            
            // Табы профиля
            document.querySelectorAll('.tab[data-tab]').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Активируем таб
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabPane = document.getElementById(`profile${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
                    if (tabPane) {
                        tabPane.classList.add('active');
                    }
                    
                    // Загружаем контент для вкладки
                    switch (tabName) {
                        case 'followers':
                            loadFollowers(userId);
                            break;
                        case 'following':
                            loadFollowing(userId);
                            break;
                        case 'media':
                            loadMedia(userId);
                            break;
                    }
                });
            });
        }
        
        async function toggleFollow(userId) {
            if (!currentUser) {
                showNotification('Ошибка', 'Войдите в систему', 'error');
                return;
            }
            
            try {
                const userToFollow = allUsers.find(u => u.id === userId);
                if (!userToFollow) {
                    showNotification('Ошибка', 'Пользователь не найден', 'error');
                    return;
                }
                
                const following = currentUser.following || [];
                const isFollowing = following.includes(userId);
                
                let newFollowing;
                if (isFollowing) {
                    newFollowing = following.filter(id => id !== userId);
                } else {
                    newFollowing = [...following, userId];
                }
                
                // Обновляем локально
                currentUser.following = newFollowing;
                currentUser.following_count = newFollowing.length;
                
                // Обновляем счетчик подписчиков у другого пользователя
                const followers = userToFollow.followers || [];
                let newFollowers;
                if (isFollowing) {
                    newFollowers = followers.filter(id => id !== currentUser.id);
                } else {
                    newFollowers = [...followers, currentUser.id];
                }
                
                userToFollow.followers = newFollowers;
                userToFollow.followers_count = newFollowers.length;
                
                // Обновляем интерфейс
                updateUI();
                
                // Обновляем кнопку подписки
                const followBtn = document.querySelector(`.follow-btn[data-user-id="${userId}"]`);
                if (followBtn) {
                    if (isFollowing) {
                        followBtn.innerHTML = '<i class="fas fa-user-plus"></i> Подписаться';
                        followBtn.classList.remove('btn-danger');
                        followBtn.classList.add('btn-primary');
                    } else {
                        followBtn.innerHTML = '<i class="fas fa-user-minus"></i> Отписаться';
                        followBtn.classList.remove('btn-primary');
                        followBtn.classList.add('btn-danger');
                    }
                }
                
                // Обновляем счетчики в профиле
                const followersCount = document.querySelector(`.followers-count[data-user-id="${userId}"]`);
                if (followersCount) {
                    followersCount.textContent = userToFollow.followers_count;
                }
                
                const followingCount = document.querySelector(`.following-count[data-user-id="${userId}"]`);
                if (followingCount) {
                    followingCount.textContent = currentUser.following_count;
                }
                
                // Пытаемся обновить в Supabase
                if (supabase) {
                    // Обновляем текущего пользователя
                    await supabase
                        .from('users')
                        .update({ 
                            following: newFollowing,
                            following_count: newFollowing.length
                        })
                        .eq('id', currentUser.id);
                    
                    // Обновляем другого пользователя
                    await supabase
                        .from('users')
                        .update({ 
                            followers: newFollowers,
                            followers_count: newFollowers.length
                        })
                        .eq('id', userId);
                }
                
                // Отправляем уведомление
                if (!isFollowing) {
                    await createNotification(userId, 'follow');
                }
                
                showNotification('Успех', 
                    isFollowing ? 'Вы отписались' : 'Вы подписались', 
                    'success');
                
            } catch (error) {
                console.error('Ошибка подписки:', error);
                showNotification('Ошибка', 'Не удалось выполнить действие', 'error');
            }
        }
        
        // ========== УПРАВЛЕНИЕ ГРУППАМИ ==========
        async function renderGroups() {
            const allGrid = document.getElementById('allGroupsGrid');
            const myGrid = document.getElementById('myGroupsGrid');
            
            if (!allGrid || !myGrid) return;
            
            // Очищаем все сетки
            allGrid.innerHTML = '';
            myGrid.innerHTML = '';
            document.getElementById('channelsGrid').innerHTML = '';
            document.getElementById('communitiesGrid').innerHTML = '';
            
            // Определяем, в каких группах состоит пользователь
            const userGroups = allGroups.filter(group => 
                group.members?.includes(currentUser?.id)
            );
            
            // Обновляем счетчик моих групп
            const myGroupsCount = document.getElementById('myGroupsCount');
            if (myGroupsCount) {
                myGroupsCount.textContent = userGroups.length;
            }
            
            // Рендерим все группы
            allGroups.forEach(group => {
                renderGroupCard(group, allGrid);
            });
            
            // Рендерим мои группы
            userGroups.forEach(group => {
                renderGroupCard(group, myGrid);
            });
            
            // Рендерим каналы и сообщества (в демо все группы)
            allGroups.forEach(group => {
                renderGroupCard(group, document.getElementById('channelsGrid'));
                renderGroupCard(group, document.getElementById('communitiesGrid'));
            });
            
            // Добавляем обработчики
            addGroupEventListeners();
        }
        
        function renderGroupCard(group, container) {
            const template = document.getElementById('groupCardTemplate').innerHTML;
            let html = template;
            
            const isMember = group.members?.includes(currentUser?.id) || false;
            
            const replacements = {
                '{{id}}': group.id,
                '{{name}}': group.name,
                '{{avatar}}': group.avatar || '👥',
                '{{description}}': group.description || 'Нет описания',
                '{{members_count}}': group.members_count || 0,
                '{{posts_count}}': group.posts_count || 0,
                '{{is_member}}': isMember ? 'true' : ''
            };
            
            Object.keys(replacements).forEach(key => {
                html = html.replace(new RegExp(key, 'g'), replacements[key]);
            });
            
            // Удаляем условные блоки
            html = html.replace(/\{\{#if is_member\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, content) => {
                return isMember ? content : '';
            });
            
            html = html.replace(/\{\{[^}]+\}\}/g, '');
            
            const div = document.createElement('div');
            div.innerHTML = html;
            container.appendChild(div.firstElementChild);
        }
        
        function addGroupEventListeners() {
            // Кнопки вступления в группы
            document.querySelectorAll('.join-group-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const groupId = btn.dataset.groupId;
                    await joinGroup(groupId);
                });
            });
            
            // Клики по карточкам групп
            document.querySelectorAll('.group-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('join-group-btn')) {
                        const groupId = card.dataset.groupId;
                        showGroupInfo(groupId);
                    }
                });
            });
        }
        
        async function joinGroup(groupId) {
            if (!currentUser) {
                showNotification('Ошибка', 'Войдите в систему', 'error');
                return false;
            }
            
            try {
                const group = allGroups.find(g => g.id === groupId);
                if (!group) {
                    showNotification('Ошибка', 'Группа не найдена', 'error');
                    return false;
                }
                
                const members = group.members || [];
                if (members.includes(currentUser.id)) {
                    showNotification('Информация', 'Вы уже в группе', 'info');
                    return false;
                }
                
                // Обновляем локально
                group.members = [...members, currentUser.id];
                group.members_count = (group.members_count || 0) + 1;
                
                // Обновляем интерфейс
                renderGroups();
                
                // Пытаемся обновить в Supabase
                if (supabase) {
                    const { error } = await supabase
                        .from('groups')
                        .update({ 
                            members: group.members,
                            members_count: group.members_count
                        })
                        .eq('id', groupId);
                    
                    if (error) throw error;
                }
                
                showNotification('Успех', 'Вы вступили в группу!', 'success');
                return true;
                
            } catch (error) {
                console.error('Ошибка вступления в группу:', error);
                showNotification('Ошибка', 'Не удалось вступить в группу', 'error');
                return false;
            }
        }
        
        async function createGroup(groupData) {
            if (!currentUser) {
                showNotification('Ошибка', 'Войдите в систему', 'error');
                return false;
            }
            
            try {
                const newGroup = {
                    id: 'group-' + Date.now(),
                    name: groupData.name,
                    username: groupData.username,
                    description: groupData.description,
                    avatar: groupData.avatar,
                    type: groupData.type || 'group',
                    is_public: groupData.privacy === 'public',
                    members: [currentUser.id],
                    creator_id: currentUser.id,
                    members_count: 1,
                    posts_count: 0,
                    created_at: new Date().toISOString()
                };
                
                // Обновляем локально
                allGroups.unshift(newGroup);
                
                // Обновляем интерфейс
                renderGroups();
                loadPopularGroups();
                
                // Пытаемся сохранить в Supabase
                if (supabase) {
                    const { error } = await supabase
                        .from('groups')
                        .insert([{
                            name: groupData.name,
                            avatar: groupData.avatar,
                            description: groupData.description,
                            members: [currentUser.id],
                            creator_id: currentUser.id,
                            members_count: 1,
                            created_at: new Date().toISOString()
                        }]);
                    
                    if (error) throw error;
                }
                
                showNotification('Успех', 'Группа создана!', 'success');
                return true;
                
            } catch (error) {
                console.error('Ошибка создания группы:', error);
                showNotification('Ошибка', 'Не удалось создать группу', 'error');
                return false;
            }
        }
        
        // ========== СООБЩЕНИЯ ==========
        async function renderConversations() {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            const template = `
                <div class="conversations-sidebar">
                    <div class="conversations-header">
                        <h3>Диалоги</h3>
                    </div>
                    <div class="conversations-list" id="conversationsList">
                        ${conversations.map(conv => `
                            <div class="conversation-item" data-conversation-id="${conv.id}">
                                <div class="conversation-avatar">
                                    <span>${conv.avatar}</span>
                                    ${conv.is_online ? '<div class="status-indicator status-online"></div>' : ''}
                                </div>
                                <div class="conversation-info">
                                    <div class="conversation-name">${conv.name}</div>
                                    <div class="conversation-last-message">${conv.last_message}</div>
                                </div>
                                <div class="conversation-time">${conv.last_message_time}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="messages-area">
                    <div class="messages-header">
                        <div class="chat-user-info">
                            <div class="chat-user-avatar">
                                <span>💬</span>
                            </div>
                            <div class="chat-user-details">
                                <h3>Выберите диалог</h3>
                                <p>Начните общение</p>
                            </div>
                        </div>
                    </div>
                    <div class="messages-list" id="messagesList">
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-comments icon-xl mb-3"></i>
                            <p>Выберите диалог для начала общения</p>
                        </div>
                    </div>
                    <div class="message-input-container hidden" id="messageInputContainer">
                        <div class="message-input-wrapper">
                            <div class="message-attachments">
                                <button class="btn-icon" title="Добавить файл">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="btn-icon" title="Голосовое сообщение">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                            <textarea class="message-input" placeholder="Написать сообщение..." id="messageInput"></textarea>
                            <button class="btn btn-primary" id="sendMessageBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = template;
            
            // Добавляем обработчики для диалогов
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', () => {
                    const conversationId = item.dataset.conversationId;
                    openConversation(conversationId);
                });
            });
            
            // Обработчик отправки сообщения
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendMessageBtn && messageInput) {
                sendMessageBtn.addEventListener('click', async () => {
                    if (messageInput.value.trim() && currentConversation) {
                        await sendMessage(messageInput.value.trim());
                        messageInput.value = '';
                    }
                });
                
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey && currentConversation) {
                        e.preventDefault();
                        sendMessageBtn.click();
                    }
                });
            }
        }
        
        async function openConversation(conversationId) {
            try {
                const conversation = conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                currentConversation = conversation;
                
                // Показываем поле ввода
                const messageInputContainer = document.getElementById('messageInputContainer');
                if (messageInputContainer) {
                    messageInputContainer.classList.remove('hidden');
                }
                
                // Обновляем заголовок
                const messagesHeader = document.querySelector('.messages-header .chat-user-details');
                if (messagesHeader) {
                    messagesHeader.innerHTML = `
                        <h3>${conversation.name}</h3>
                        <p>${conversation.is_online ? 'В сети' : 'Был(а) недавно'}</p>
                    `;
                }
                
                // Загружаем сообщения (в демо создаем тестовые)
                currentMessages = [
                    {
                        id: 'msg-1',
                        conversation_id: conversationId,
                        sender_id: conversation.id === 'conv-1' ? 'demo-pushkin' : 'demo-lermontov',
                        content: conversation.last_message,
                        created_at: new Date(Date.now() - 3600000).toISOString()
                    },
                    {
                        id: 'msg-2',
                        conversation_id: conversationId,
                        sender_id: currentUser.id,
                        content: 'Привет! Как дела?',
                        created_at: new Date().toISOString()
                    }
                ];
                
                renderMessages();
                
                // Помечаем диалог как активный
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.querySelector(`.conversation-item[data-conversation-id="${conversationId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
                
            } catch (error) {
                console.error('Ошибка загрузки сообщений:', error);
                showNotification('Ошибка', 'Не удалось загрузить сообщения', 'error');
            }
        }
        
        function renderMessages() {
            const container = document.getElementById('messagesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            currentMessages.forEach(message => {
                const isOutgoing = message.sender_id === currentUser.id;
                const template = document.getElementById('messageTemplate').innerHTML;
                let html = template;
                
                const replacements = {
                    '{{id}}': message.id,
                    '{{outgoing}}': isOutgoing ? 'outgoing' : '',
                    '{{content}}': message.content,
                    '{{file_url}}': message.file_url || '',
                    '{{file_name}}': message.file_name || '',
                    '{{created_at}}': formatTimeAgo(message.created_at)
                };
                
                Object.keys(replacements).forEach(key => {
                    html = html.replace(new RegExp(key, 'g'), replacements[key]);
                });
                
                // Удаляем условные блоки
                html = html.replace(/\{\{#if file_url\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, content) => {
                    return message.file_url ? content : '';
                });
                
                html = html.replace(/\{\{[^}]+\}\}/g, '');
                
                container.insertAdjacentHTML('beforeend', html);
            });
            
            // Прокручиваем вниз
            container.scrollTop = container.scrollHeight;
        }
        
        async function sendMessage(content) {
            if (!currentUser || !currentConversation) return;
            
            try {
                const newMessage = {
                    id: 'msg-' + Date.now(),
                    conversation_id: currentConversation.id,
                    sender_id: currentUser.id,
                    content: content.trim(),
                    created_at: new Date().toISOString()
                };
                
                // Обновляем локально
                currentMessages.push(newMessage);
                
                // Обновляем последнее сообщение в диалоге
                currentConversation.last_message = content.slice(0, 50) + (content.length > 50 ? '...' : '');
                currentConversation.last_message_time = 'только что';
                
                // Обновляем интерфейс
                renderMessages();
                renderConversations();
                
                // Пытаемся сохранить в Supabase
                if (supabase) {
                    const { error } = await supabase
                        .from('messages')
                        .insert([{
                            conversation_id: currentConversation.id,
                            sender_id: currentUser.id,
                            content: content.trim(),
                            created_at: new Date().toISOString()
                        }]);
                    
                    if (error) console.error('Ошибка отправки сообщения:', error);
                }
                
                return true;
                
            } catch (error) {
                console.error('Ошибка отправки сообщения:', error);
                showNotification('Ошибка', 'Не удалось отправить сообщение', 'error');
                return false;
            }
        }
        
        async function startConversation(userId) {
            if (!currentUser) return;
            
            showNotification('Информация', 'Функция сообщений в разработке', 'info');
            // В будущем здесь будет полноценная реализация
        }
        
        // ========== УПРАВЛЕНИЕ УВЕДОМЛЕНИЯМИ ==========
        async function createNotification(userId, type, postId = null) {
            // В демо-режиме просто показываем уведомление
            let message = '';
            switch (type) {
                case 'like':
                    message = `${currentUser.username} поставил(а) лайк вашему посту`;
                    break;
                case 'comment':
                    message = `${currentUser.username} прокомментировал(а) ваш пост`;
                    break;
                case 'repost':
                    message = `${currentUser.username} репостнул(а) ваш пост`;
                    break;
                case 'follow':
                    message = `${currentUser.username} подписался(ась) на вас`;
                    break;
            }
            
            showNotification('Новое уведомление', message, 'info');
        }
        
        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            if (!container) return;
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">Нет уведомлений</div>';
                return;
            }
            
            container.innerHTML = notifications.map(notification => {
                const fromUser = allUsers.find(u => u.id === notification.from_user_id);
                return `
                    <div class="notification-item ${notification.is_read ? '' : 'unread'}" data-notification-id="${notification.id}">
                        <div class="d-flex align-start gap-3 p-3 border-bottom">
                            <div class="user-avatar">
                                <span>${fromUser?.emoji || '😀'}</span>
                            </div>
                            <div class="flex-1">
                                <div class="mb-1">${notification.message}</div>
                                <div class="text-muted small">${formatTimeAgo(notification.created_at)}</div>
                            </div>
                            ${!notification.is_read ? '<span class="badge">новое</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Добавляем обработчики
            container.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', async () => {
                    const notificationId = item.dataset.notificationId;
                    await markNotificationAsRead(notificationId);
                });
            });
        }
        
        async function markNotificationAsRead(notificationId) {
            // В демо-режиме просто обновляем локально
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.is_read = true;
                renderNotifications();
                loadNotifications();
            }
        }
        
        // ========== УПРАВЛЕНИЕ СТРАНИЦАМИ ==========
        function showPage(pageName) {
            // Скрываем все страницы
            hideAllPages();
            
            // Убираем активный класс у всех навигационных ссылок
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Активируем нужную навигационную ссылку
            const navLink = document.getElementById(`nav${pageName.charAt(0).toUpperCase() + pageName.slice(1)}`);
            if (navLink) {
                navLink.classList.add('active');
            }
            
            // Показываем нужную страницу
            switch (pageName) {
                case 'feed':
                    document.getElementById('feedPage').classList.remove('hidden');
                    renderPosts();
                    break;
                    
                case 'messages':
                    document.getElementById('messagesPage').classList.remove('hidden');
                    renderConversations();
                    break;
                    
                case 'groups':
                    document.getElementById('groupsPage').classList.remove('hidden');
                    renderGroups();
                    break;
                    
                case 'notifications':
                    document.getElementById('notificationsPage').classList.remove('hidden');
                    renderNotifications();
                    break;
                    
                case 'admin':
                    document.getElementById('adminPage').classList.remove('hidden');
                    loadAdminPanel();
                    break;
            }
        }
        
        function hideAllPages() {
            document.getElementById('feedPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
            document.getElementById('messagesPage').classList.add('hidden');
            document.getElementById('groupsPage').classList.add('hidden');
            document.getElementById('notificationsPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
        }
        
        // ========== РАБОТА С ФАЙЛАМИ ==========
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            
            // Показываем превью
            const preview = document.getElementById('filePreview');
            const previewImage = document.getElementById('previewImage');
            const previewFileInfo = document.getElementById('previewFileInfo');
            const uploadBtn = document.getElementById('uploadFileBtn');
            
            if (preview && previewImage && previewFileInfo && uploadBtn) {
                preview.classList.remove('hidden');
                uploadBtn.classList.remove('hidden');
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewImage.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImage.classList.add('hidden');
                }
                
                previewFileInfo.innerHTML = `
                    <div class="text-center">
                        <div class="font-weight-medium">${file.name}</div>
                        <div class="text-muted small">${formatFileSize(file.size)}</div>
                    </div>
                `;
            }
        }
        
        function uploadFile() {
            if (!selectedFile) return;
            
            // В демо-режиме создаем URL для файла
            const fileUrl = URL.createObjectURL(selectedFile);
            
            // Добавляем файл в пост
            const attachmentsContainer = document.getElementById('postAttachments');
            if (attachmentsContainer) {
                attachmentsContainer.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between">
                                <div class="d-flex align-center gap-3">
                                    <i class="fas fa-file text-primary icon-lg"></i>
                                    <div>
                                        <div class="font-weight-medium">${selectedFile.name}</div>
                                        <div class="text-muted small">${formatFileSize(selectedFile.size)}</div>
                                    </div>
                                </div>
                                <button class="btn-icon" id="removeFileBtn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                attachmentsContainer.classList.remove('hidden');
                
                // Обработчик удаления файла
                document.getElementById('removeFileBtn').addEventListener('click', () => {
                    selectedFile = null;
                    attachmentsContainer.innerHTML = '';
                    attachmentsContainer.classList.add('hidden');
                });
            }
            
            // Закрываем модалку
            document.getElementById('fileModal').classList.remove('active');
            
            showNotification('Успех', 'Файл добавлен к посту', 'success');
        }
        
        // ========== РАБОТА С ГОЛОСОВЫМИ СООБЩЕНИЯМИ ==========
        function startRecording() {
            if (isRecording) return;
            
            isRecording = true;
            recordingSeconds = 0;
            
            const recordBtn = document.getElementById('recordVoiceBtn');
            const sendBtn = document.getElementById('sendVoiceBtn');
            const recordingTime = document.getElementById('recordingTime');
            
            if (recordBtn) {
                recordBtn.innerHTML = '<i class="fas fa-stop"></i> Остановить запись';
                recordBtn.classList.remove('btn-primary');
                recordBtn.classList.add('btn-danger');
            }
            
            if (sendBtn) {
                sendBtn.classList.add('hidden');
            }
            
            // Обновляем таймер
            recordingTimer = setInterval(() => {
                recordingSeconds++;
                if (recordingTime) {
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            clearInterval(recordingTimer);
            
            const recordBtn = document.getElementById('recordVoiceBtn');
            const sendBtn = document.getElementById('sendVoiceBtn');
            const recordingTime = document.getElementById('recordingTime');
            
            if (recordBtn) {
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i> Начать запись';
                recordBtn.classList.remove('btn-danger');
                recordBtn.classList.add('btn-primary');
            }
            
            if (sendBtn && recordingSeconds > 0) {
                sendBtn.classList.remove('hidden');
            }
            
            // Создаем демо-голосовое сообщение
            if (recordingSeconds > 0) {
                selectedVoice = {
                    url: '#',
                    duration: recordingSeconds
                };
                
                showNotification('Успех', `Запись сохранена (${recordingSeconds} сек.)`, 'success');
            }
        }
        
        function sendVoiceMessage() {
            if (!selectedVoice) return;
            
            // Добавляем голосовое сообщение в пост
            const attachmentsContainer = document.getElementById('postAttachments');
            if (attachmentsContainer) {
                const minutes = Math.floor(selectedVoice.duration / 60);
                const seconds = selectedVoice.duration % 60;
                
                attachmentsContainer.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-center justify-between">
                                <div class="d-flex align-center gap-3">
                                    <i class="fas fa-microphone text-primary icon-lg"></i>
                                    <div>
                                        <div class="font-weight-medium">Голосовое сообщение</div>
                                        <div class="text-muted small">${minutes}:${seconds.toString().padStart(2, '0')}</div>
                                    </div>
                                </div>
                                <button class="btn-icon" id="removeVoiceBtn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                attachmentsContainer.classList.remove('hidden');
                
                // Обработчик удаления голосового сообщения
                document.getElementById('removeVoiceBtn').addEventListener('click', () => {
                    selectedVoice = null;
                    attachmentsContainer.innerHTML = '';
                    attachmentsContainer.classList.add('hidden');
                });
            }
            
            // Закрываем модалку
            document.getElementById('voiceModal').classList.remove('active');
        }
        
        // ========== АДМИН ПАНЕЛЬ ==========
        async function loadAdminPanel() {
            if (!currentUser || currentUser.username !== '@onegin') {
                showNotification('Ошибка', 'Доступ запрещен', 'error');
                showPage('feed');
                return;
            }
            
            try {
                // Загружаем статистику
                const totalUsers = allUsers.length;
                const onlineUsersCount = onlineUsers.size;
                const totalPosts = allPosts.length;
                const totalGroups = allGroups.length;
                
                document.getElementById('adminTotalUsers').textContent = totalUsers;
                document.getElementById('adminOnlineUsers').textContent = onlineUsersCount;
                document.getElementById('adminTotalPosts').textContent = totalPosts;
                document.getElementById('adminTotalGroups').textContent = totalGroups;
                
                // Загружаем пользователей для верификации
                const usersToVerify = allUsers.filter(u => !u.is_verified).slice(0, 20);
                
                const usersList = document.getElementById('adminUsersList');
                if (usersList) {
                    usersList.innerHTML = usersToVerify.map(user => `
                        <div class="admin-user-item">
                            <div class="user-avatar">
                                <span>${user.emoji}</span>
                            </div>
                            <div class="admin-user-info">
                                <div class="admin-user-name">
                                    ${user.username}
                                    <span class="text-muted">(${user.display_name})</span>
                                </div>
                                <div class="admin-user-meta">
                                    Постов: ${user.posts_count || 0} • 
                                    Подписчиков: ${user.followers_count || 0}
                                </div>
                            </div>
                            <button class="btn btn-success verify-user-btn" data-user-id="${user.id}">
                                <i class="fas fa-check"></i> Верифицировать
                            </button>
                        </div>
                    `).join('');
                    
                    // Добавляем обработчики
                    usersList.querySelectorAll('.verify-user-btn').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const userId = btn.dataset.userId;
                            await verifyUser(userId);
                        });
                    });
                }
                
            } catch (error) {
                console.error('Ошибка загрузки админ панели:', error);
                showNotification('Ошибка', 'Не удалось загрузить админ панель', 'error');
            }
        }
        
        async function verifyUser(userId) {
            try {
                const user = allUsers.find(u => u.id === userId);
                if (user) {
                    user.is_verified = true;
                    showNotification('Успех', 'Пользователь верифицирован', 'success');
                    loadAdminPanel();
                }
            } catch (error) {
                console.error('Ошибка верификации:', error);
                showNotification('Ошибка', 'Не удалось верифицировать пользователя', 'error');
            }
        }
        
        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        function populateEmojiSelectors() {
            const selectors = [
                'registerEmojiSelector',
                'clanEmojiSelector',
                'editEmojiSelector',
                'groupEmojiSelector'
            ];
            
            selectors.forEach(selectorId => {
                const container = document.getElementById(selectorId);
                if (container) {
                    container.innerHTML = '';
                    emojis.forEach(emoji => {
                        const div = document.createElement('div');
                        div.className = 'emoji-option';
                        div.textContent = emoji;
                        div.addEventListener('click', () => {
                            // Снимаем выделение со всех
                            container.querySelectorAll('.emoji-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            // Выделяем выбранный
                            div.classList.add('selected');
                            // Обновляем соответствующее скрытое поле
                            const hiddenInput = document.getElementById(selectorId.replace('Selector', ''));
                            if (hiddenInput) hiddenInput.value = emoji;
                        });
                        container.appendChild(div);
                    });
                    
                    // Выбираем первый эмодзи по умолчанию
                    if (container.firstChild) {
                        container.firstChild.classList.add('selected');
                    }
                }
            });
        }
        
        function setupModal(modalId, openBtnId = null, closeBtnId = null) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Открытие модалки
            if (openBtnId) {
                const openBtn = document.getElementById(openBtnId);
                if (openBtn) {
                    openBtn.addEventListener('click', () => {
                        modal.classList.add('active');
                    });
                }
            }
            
            // Закрытие модалки
            if (closeBtnId) {
                const closeBtn = document.getElementById(closeBtnId);
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        modal.classList.remove('active');
                    });
                }
            }
            
            // Закрытие по клику на оверлей
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }
        
        function showEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            if (!modal) return;
            
            // Заполняем поля текущими данными
            document.getElementById('editDisplayName').value = currentUser.display_name;
            document.getElementById('editBio').value = currentUser.description || '';
            document.getElementById('editStatus').value = currentUser.status || '';
            document.getElementById('editEmoji').value = currentUser.emoji;
            
            // Выбираем текущий эмодзи
            const emojiSelector = document.getElementById('editEmojiSelector');
            if (emojiSelector) {
                emojiSelector.querySelectorAll('.emoji-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.textContent === currentUser.emoji) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            modal.classList.add('active');
        }
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        async function initApp() {
            // Проверяем сохраненного пользователя
            const savedUser = localStorage.getItem('mirror_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    await loadInitialData();
                    showMainApp();
                    return;
                } catch (error) {
                    console.error('Ошибка загрузки пользователя:', error);
                    localStorage.removeItem('mirror_user');
                }
            }
            
            // Показываем форму авторизации
            showAuthPage();
        }
        
        function showMainApp() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Обновляем интерфейс
            updateUI();
            
            // Рендерим посты
            renderPosts();
            
            // Показываем ленту
            showPage('feed');
        }
        
        function showAuthPage() {
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
        
        // ========== ОБРАБОТЧИКИ СОБЫТИЙ ==========
        document.addEventListener('DOMContentLoaded', async () => {
            // Инициализируем селекторы эмодзи
            populateEmojiSelectors();
            
            // Настраиваем модальные окна
            setupModal('clanModal', null, 'closeClanModal');
            setupModal('editProfileModal', 'editProfileBtn', 'closeEditProfileModal');
            setupModal('createGroupModal', 'createGroupBtn', 'closeCreateGroupModal');
            setupModal('voiceModal', null, 'closeVoiceModal');
            setupModal('fileModal', null, 'closeFileModal');
            
            // Настраиваем кнопки в модалке группы
            const groupTypeSelector = document.getElementById('groupTypeSelector');
            if (groupTypeSelector) {
                groupTypeSelector.addEventListener('click', (e) => {
                    if (e.target.matches('[data-group-type]')) {
                        groupTypeSelector.querySelectorAll('button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                    }
                });
            }
            
            const groupPrivacySelector = document.getElementById('groupPrivacySelector');
            if (groupPrivacySelector) {
                groupPrivacySelector.addEventListener('click', (e) => {
                    if (e.target.matches('[data-privacy]')) {
                        groupPrivacySelector.querySelectorAll('button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                    }
                });
            }
            
            // Авторизация
            document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                // Для демо - проверяем хардкод
                if (username === '@onegin' && password === 'admin123') {
                    currentUser = {
                        id: 'demo-onegin',
                        username: '@onegin',
                        display_name: 'Евгений Онегин',
                        emoji: '👑',
                        description: 'Владелец социальной сети "Зеркало"',
                        is_verified: true,
                        posts_count: 5,
                        followers_count: 1000,
                        following_count: 50,
                        following: [],
                        clan: '👑',
                        created_at: new Date().toISOString()
                    };
                    
                    localStorage.setItem('mirror_user', JSON.stringify(currentUser));
                    await loadInitialData();
                    showMainApp();
                    return;
                }
                
                // Проверяем других демо-пользователей
                if (username === '@pushkin' && password === 'poet123') {
                    currentUser = {
                        id: 'demo-pushkin',
                        username: '@pushkin',
                        display_name: 'Александр Пушкин',
                        emoji: '📚',
                        description: 'Великий русский поэт',
                        is_verified: true,
                        posts_count: 3,
                        followers_count: 800,
                        following_count: 30,
                        following: ['demo-onegin'],
                        clan: '📚',
                        created_at: new Date().toISOString()
                    };
                    
                    localStorage.setItem('mirror_user', JSON.stringify(currentUser));
                    await loadInitialData();
                    showMainApp();
                    return;
                }
                
                // Пытаемся найти пользователя в базе данных
                if (supabase) {
                    try {
                        const { data: user, error } = await supabase
                            .from('users')
                            .select('*')
                            .or(`username.eq.${username},email.eq.${username}`)
                            .eq('password_hash', password)
                            .single();
                        
                        if (error || !user) {
                            showNotification('Ошибка', 'Неверные данные для входа', 'error');
                            return;
                        }
                        
                        currentUser = user;
                        localStorage.setItem('mirror_user', JSON.stringify(currentUser));
                        await loadInitialData();
                        showMainApp();
                        
                    } catch (error) {
                        console.error('Ошибка входа:', error);
                        showNotification('Ошибка', 'Произошла ошибка при входе', 'error');
                    }
                } else {
                    showNotification('Ошибка', 'Неверные данные для входа', 'error');
                }
            });
            
            // Регистрация
            document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('regUsername').value.trim();
                const displayName = document.getElementById('regDisplayName').value.trim();
                const email = document.getElementById('regEmail').value.trim();
                const description = document.getElementById('regDescription').value.trim();
                const emoji = document.getElementById('regEmoji').value;
                const password = document.getElementById('regPassword').value;
                const confirmPassword = document.getElementById('regConfirmPassword').value;
                
                // Валидация
                if (!username.startsWith('@')) {
                    showNotification('Ошибка', 'Юзернейм должен начинаться с @', 'error');
                    return;
                }
                
                if (password.length < 8) {
                    showNotification('Ошибка', 'Пароль должен быть не менее 8 символов', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showNotification('Ошибка', 'Пароли не совпадают', 'error');
                    return;
                }
                
                try {
                    // Проверяем, существует ли пользователь
                    const existingUser = allUsers.find(u => u.username === username);
                    if (existingUser) {
                        showNotification('Ошибка', 'Этот юзернейм уже занят', 'error');
                        return;
                    }
                    
                    // Создаем нового пользователя
                    const newUser = {
                        id: 'user-' + Date.now(),
                        username,
                        display_name: displayName,
                        email: email || null,
                        description: description || null,
                        emoji,
                        password_hash: password,
                        clan: emoji,
                        is_verified: false,
                        posts_count: 0,
                        followers_count: 0,
                        following_count: 0,
                        following: [],
                        followers: [],
                        created_at: new Date().toISOString()
                    };
                    
                    currentUser = newUser;
                    allUsers.push(newUser);
                    
                    // Пытаемся сохранить в Supabase
                    if (supabase) {
                        const { error } = await supabase
                            .from('users')
                            .insert([{
                                username,
                                display_name: displayName,
                                email: email || null,
                                description: description || null,
                                emoji,
                                password_hash: password,
                                clan: emoji
                            }]);
                        
                        if (error) throw error;
                    }
                    
                    localStorage.setItem('mirror_user', JSON.stringify(currentUser));
                    await loadInitialData();
                    showMainApp();
                    
                    showNotification('Успех', 'Регистрация прошла успешно!', 'success');
                    
                } catch (error) {
                    console.error('Ошибка регистрации:', error);
                    showNotification('Ошибка', 'Не удалось зарегистрироваться', 'error');
                }
            });
            
            // Переключение вкладок авторизации
            document.getElementById('loginTab')?.addEventListener('click', () => {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('registerTab').classList.remove('active');
                document.getElementById('loginForm').classList.add('active');
                document.getElementById('registerForm').classList.remove('active');
            });
            
            document.getElementById('registerTab')?.addEventListener('click', () => {
                document.getElementById('registerTab').classList.add('active');
                document.getElementById('loginTab').classList.remove('active');
                document.getElementById('registerForm').classList.add('active');
                document.getElementById('loginForm').classList.remove('active');
            });
            
            // Создание поста
            document.getElementById('publishPostBtn')?.addEventListener('click', async () => {
                const content = document.getElementById('postText').value.trim();
                
                const attachments = {};
                if (selectedFile) {
                    attachments.file = {
                        url: URL.createObjectURL(selectedFile),
                        name: selectedFile.name,
                        size: selectedFile.size
                    };
                }
                
                if (selectedVoice) {
                    attachments.voice = selectedVoice;
                }
                
                await createPost(content, attachments);
            });
            
            // Выход
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                currentUser = null;
                localStorage.removeItem('mirror_user');
                showAuthPage();
                showNotification('Информация', 'Вы вышли из системы', 'info');
            });
            
            // Навигация
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    if (page) showPage(page);
                });
            });
            
            // Логотип - переход на ленту
            document.getElementById('homeLogo')?.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('feed');
            });
            
            // Просмотр своего профиля
            document.getElementById('viewProfileBtn')?.addEventListener('click', () => {
                if (currentUser) {
                    showUserProfile(currentUser.id);
                }
            });
            
            // Создание поста из пустой ленты
            document.getElementById('emptyFeedPostBtn')?.addEventListener('click', () => {
                document.getElementById('postText').focus();
            });
            
            // Сохранение профиля
            document.getElementById('saveProfileBtn')?.addEventListener('click', async () => {
                const displayName = document.getElementById('editDisplayName').value.trim();
                const bio = document.getElementById('editBio').value.trim();
                const status = document.getElementById('editStatus').value.trim();
                const emoji = document.getElementById('editEmoji').value;
                
                if (!displayName) {
                    showNotification('Ошибка', 'Введите имя', 'error');
                    return;
                }
                
                try {
                    // Обновляем локально
                    currentUser.display_name = displayName;
                    currentUser.description = bio;
                    currentUser.status = status;
                    currentUser.emoji = emoji;
                    currentUser.clan = emoji;
                    
                    // Сохраняем в localStorage
                    localStorage.setItem('mirror_user', JSON.stringify(currentUser));
                    
                    // Обновляем интерфейс
                    updateUI();
                    
                    // Пытаемся обновить в Supabase
                    if (supabase) {
                        const { error } = await supabase
                            .from('users')
                            .update({
                                display_name: displayName,
                                description: bio,
                                status: status,
                                emoji: emoji,
                                clan: emoji,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', currentUser.id);
                        
                        if (error) throw error;
                    }
                    
                    // Закрываем модалку
                    document.getElementById('editProfileModal').classList.remove('active');
                    
                    showNotification('Успех', 'Профиль обновлен', 'success');
                    
                } catch (error) {
                    console.error('Ошибка обновления профиля:', error);
                    showNotification('Ошибка', 'Не удалось обновить профиль', 'error');
                }
            });
            
            // Создание группы
            document.getElementById('saveGroupBtn')?.addEventListener('click', async () => {
                const name = document.getElementById('groupName').value.trim();
                const username = document.getElementById('groupUsername').value.trim();
                const description = document.getElementById('groupDescription').value.trim();
                const emoji = document.getElementById('groupEmoji').value;
                const type = document.querySelector('#groupTypeSelector .active')?.dataset.groupType || 'group';
                const privacy = document.querySelector('#groupPrivacySelector .active')?.dataset.privacy || 'public';
                
                if (!name || !username) {
                    showNotification('Ошибка', 'Заполните обязательные поля', 'error');
                    return;
                }
                
                if (!username.startsWith('@')) {
                    showNotification('Ошибка', 'Юзернейм должен начинаться с @', 'error');
                    return;
                }
                
                const groupData = {
                    name,
                    username,
                    description,
                    avatar: emoji,
                    type,
                    privacy
                };
                
                const success = await createGroup(groupData);
                if (success) {
                    document.getElementById('createGroupModal').classList.remove('active');
                    // Очищаем форму
                    document.getElementById('groupName').value = '';
                    document.getElementById('groupUsername').value = '';
                    document.getElementById('groupDescription').value = '';
                }
            });
            
            // Поиск
            document.getElementById('searchInput')?.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();
                const resultsContainer = document.getElementById('searchResults');
                
                if (!resultsContainer) return;
                
                if (query.length < 2) {
                    resultsContainer.classList.add('hidden');
                    return;
                }
                
                // Поиск пользователей и групп
                const users = allUsers.filter(u => 
                    u.username.toLowerCase().includes(query) || 
                    u.display_name.toLowerCase().includes(query)
                ).slice(0, 5);
                
                const groups = allGroups.filter(g => 
                    g.name.toLowerCase().includes(query) || 
                    (g.username && g.username.toLowerCase().includes(query))
                ).slice(0, 5);
                
                const results = [...users, ...groups];
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item text-muted p-3">Ничего не найдено</div>';
                } else {
                    resultsContainer.innerHTML = results.map(item => `
                        <div class="search-result-item" data-id="${item.id}" data-type="${item.username ? 'user' : 'group'}">
                            <div class="d-flex align-center gap-3 p-3">
                                <div class="user-avatar">
                                    <span>${item.emoji || item.avatar || '👤'}</span>
                                </div>
                                <div class="flex-1">
                                    <div class="font-weight-medium">${item.username || item.name}</div>
                                    <div class="text-muted small">${item.display_name || item.description?.slice(0, 50) || ''}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Добавляем обработчики
                    resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const id = item.dataset.id;
                            const type = item.dataset.type;
                            
                            if (type === 'user') {
                                showUserProfile(id);
                            } else {
                                // Для групп показываем уведомление
                                showNotification('Информация', 'Просмотр групп в разработке', 'info');
                            }
                            
                            resultsContainer.classList.add('hidden');
                            document.getElementById('searchInput').value = '';
                        });
                    });
                }
                
                resultsContainer.classList.remove('hidden');
            });
            
            // Закрытие результатов поиска при клике вне
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    const resultsContainer = document.getElementById('searchResults');
                    if (resultsContainer) {
                        resultsContainer.classList.add('hidden');
                    }
                }
            });
            
            // Табы групп
            document.querySelectorAll('.tab[data-tab]').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Активируем таб
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Показываем соответствующую сетку
                    document.querySelectorAll('.groups-grid').forEach(grid => {
                        grid.classList.add('hidden');
                    });
                    
                    const gridId = tabName === 'all' ? 'allGroupsGrid' : 
                                  tabName === 'my' ? 'myGroupsGrid' :
                                  tabName === 'channels' ? 'channelsGrid' : 'communitiesGrid';
                    
                    const grid = document.getElementById(gridId);
                    if (grid) {
                        grid.classList.remove('hidden');
                    }
                });
            });
            
            // Работа с файлами
            document.getElementById('addFileBtn')?.addEventListener('click', () => {
                document.getElementById('fileModal').classList.add('active');
            });
            
            document.getElementById('fileInput')?.addEventListener('change', handleFileSelect);
            
            document.getElementById('uploadFileBtn')?.addEventListener('click', uploadFile);
            
            document.getElementById('cancelFileBtn')?.addEventListener('click', () => {
                document.getElementById('fileModal').classList.remove('active');
                selectedFile = null;
            });
            
            // Работа с голосовыми сообщениями
            document.getElementById('addVoiceBtn')?.addEventListener('click', () => {
                document.getElementById('voiceModal').classList.add('active');
            });
            
            document.getElementById('recordVoiceBtn')?.addEventListener('click', () => {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
            
            document.getElementById('sendVoiceBtn')?.addEventListener('click', sendVoiceMessage);
            
            document.getElementById('cancelVoiceBtn')?.addEventListener('click', () => {
                document.getElementById('voiceModal').classList.remove('active');
                if (isRecording) {
                    stopRecording();
                }
                selectedVoice = null;
            });
            
            // Отметить все уведомления как прочитанные
            document.getElementById('markAllReadBtn')?.addEventListener('click', () => {
                notifications.forEach(notification => {
                    notification.is_read = true;
                });
                renderNotifications();
                loadNotifications();
                showNotification('Успех', 'Все уведомления отмечены как прочитанные', 'success');
            });
            
            // Запускаем приложение
            await initApp();
            
            // Обновляем онлайн статус каждые 30 секунд
            setInterval(() => {
                updateOnlineStatus();
            }, 30000);
        });
    </script>
</body>
</html>