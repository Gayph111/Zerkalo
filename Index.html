<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ó–µ—Ä–∫–∞–ª–æ - —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ===== –†–ê–°–®–ò–†–ï–ù–ù–´–ï –°–¢–ò–õ–ò ===== */
:root {
--primary: #6366f1;
--primary-dark: #4f46e5;
--secondary: #f8fafc;
--text: #1e293b;
--text-light: #64748b;
--border: #e2e8f0;
--card-bg: #ffffff;
--shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
--shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
--radius: 12px;
--error: #ef4444;
--success: #10b981;
--warning: #f59e0b;
--online: #10b981;
--offline: #94a3b8;
--verified: #fbbf24;
}

/* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞ ... */

/* ===== –ù–û–í–´–ï –°–¢–ò–õ–ò ===== */

/* –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω */
.status-indicator {
position: relative;
}
.status-badge {
position: absolute;
bottom: 0;
right: 0;
width: 12px;
height: 12px;
border-radius: 50%;
border: 2px solid white;
}
.status-online {
background-color: var(--online);
}
.status-offline {
background-color: var(--offline);
}

/* –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è */
.verified-badge {
color: var(--verified);
font-size: 0.8em;
margin-left: 5px;
}

/* –í–∫–ª–∞–¥–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è */
.profile-tabs {
display: flex;
border-bottom: 1px solid var(--border);
margin-bottom: 20px;
}
.profile-tab {
padding: 12px 20px;
cursor: pointer;
font-weight: 500;
color: var(--text-light);
border-bottom: 3px solid transparent;
transition: all 0.2s;
}
.profile-tab:hover {
color: var(--primary);
}
.profile-tab.active {
color: var(--primary);
border-bottom-color: var(--primary);
}
.profile-tab-content {
display: none;
}
.profile-tab-content.active {
display: block;
animation: fadeIn 0.3s ease;
}

/* –ß–∞—Ç—ã */
.chat-container {
display: flex;
height: calc(100vh - 200px);
}
.chat-sidebar {
width: 300px;
border-right: 1px solid var(--border);
overflow-y: auto;
}
.chat-messages {
flex: 1;
display: flex;
flex-direction: column;
height: 100%;
}
.chat-header {
padding: 15px;
border-bottom: 1px solid var(--border);
background-color: var(--card-bg);
}
.chat-message-list {
flex: 1;
overflow-y: auto;
padding: 20px;
}
.chat-input-area {
padding: 15px;
border-top: 1px solid var(--border);
background-color: var(--card-bg);
}
.chat-message {
display: flex;
margin-bottom: 15px;
animation: fadeIn 0.3s ease;
}
.chat-message.sent {
justify-content: flex-end;
}
.chat-message-bubble {
max-width: 70%;
padding: 10px 15px;
border-radius: 18px;
background-color: var(--secondary);
position: relative;
}
.chat-message.sent .chat-message-bubble {
background-color: var(--primary);
color: white;
}
.chat-message-info {
font-size: 0.8rem;
color: var(--text-light);
margin-top: 5px;
}
.chat-contact {
display: flex;
align-items: center;
padding: 12px 15px;
border-bottom: 1px solid var(--border);
cursor: pointer;
transition: background-color 0.2s;
}
.chat-contact:hover {
background-color: var(--secondary);
}
.chat-contact.active {
background-color: rgba(99, 102, 241, 0.1);
}
.chat-contact-avatar {
font-size: 1.5rem;
margin-right: 12px;
}
.chat-contact-info {
flex: 1;
}
.chat-contact-name {
font-weight: 600;
margin-bottom: 3px;
}
.chat-contact-last-message {
font-size: 0.9rem;
color: var(--text-light);
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
.chat-contact-time {
font-size: 0.8rem;
color: var(--text-light);
}

/* –ì—Ä—É–ø–ø—ã */
.group-card {
background-color: var(--card-bg);
border-radius: var(--radius);
padding: 20px;
margin-bottom: 15px;
box-shadow: var(--shadow);
cursor: pointer;
transition: transform 0.2s;
}
.group-card:hover {
transform: translateY(-3px);
box-shadow: var(--shadow-hover);
}
.group-header {
display: flex;
align-items: center;
margin-bottom: 15px;
}
.group-avatar {
font-size: 2.5rem;
margin-right: 15px;
}
.group-info {
flex: 1;
}
.group-name {
font-weight: 700;
font-size: 1.2rem;
margin-bottom: 5px;
}
.group-members {
font-size: 0.9rem;
color: var(--text-light);
}
.group-description {
color: var(--text-light);
margin-top: 10px;
font-size: 0.95rem;
line-height: 1.5;
}

/* –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
.user-description {
margin-top: 15px;
padding: 15px;
background-color: var(--secondary);
border-radius: var(--radius);
font-size: 0.95rem;
line-height: 1.6;
color: var(--text);
}

/* –§–∞–π–ª—ã */
.file-attachment {
display: flex;
align-items: center;
padding: 10px;
background-color: var(--secondary);
border-radius: 8px;
margin-top: 10px;
cursor: pointer;
transition: background-color 0.2s;
}
.file-attachment:hover {
background-color: var(--border);
}
.file-icon {
font-size: 1.5rem;
margin-right: 10px;
color: var(--primary);
}
.file-info {
flex: 1;
}
.file-name {
font-weight: 600;
font-size: 0.9rem;
}
.file-size {
font-size: 0.8rem;
color: var(--text-light);
}
.file-download {
color: var(--primary);
cursor: pointer;
margin-left: 10px;
}

/* –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
.voice-message {
display: flex;
align-items: center;
background-color: var(--secondary);
border-radius: 20px;
padding: 8px 15px;
cursor: pointer;
transition: background-color 0.2s;
}
.voice-message:hover {
background-color: var(--border);
}
.voice-icon {
font-size: 1.2rem;
margin-right: 10px;
color: var(--primary);
}
.voice-duration {
font-size: 0.9rem;
color: var(--text-light);
margin-left: 10px;
}

/* –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å */
.admin-panel {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
border-radius: var(--radius);
padding: 30px;
margin-bottom: 20px;
}
.admin-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-top: 20px;
}
.admin-stat-card {
background-color: rgba(255, 255, 255, 0.1);
border-radius: var(--radius);
padding: 20px;
text-align: center;
backdrop-filter: blur(10px);
}
.admin-stat-value {
font-size: 2.5rem;
font-weight: 700;
margin-bottom: 5px;
}
.admin-stat-label {
font-size: 0.9rem;
opacity: 0.9;
}
.admin-actions {
margin-top: 30px;
}
.admin-user-list {
background-color: rgba(255, 255, 255, 0.1);
border-radius: var(--radius);
padding: 20px;
margin-top: 20px;
max-height: 400px;
overflow-y: auto;
}
.admin-user-item {
display: flex;
align-items: center;
padding: 15px;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.admin-user-item:last-child {
border-bottom: none;
}
.admin-user-info {
flex: 1;
margin-left: 15px;
}
.admin-verify-btn {
background-color: var(--verified);
color: white;
border: none;
padding: 8px 15px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: transform 0.2s;
}
.admin-verify-btn:hover {
transform: scale(1.05);
}
.admin-verify-btn.verified {
background-color: var(--success);
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã */
.create-group-modal .modal-content {
max-width: 600px;
}
.group-members-list {
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-top: 15px;
max-height: 200px;
overflow-y: auto;
}
.group-member-item {
display: flex;
align-items: center;
background-color: var(--secondary);
padding: 8px 12px;
border-radius: 20px;
font-size: 0.9rem;
}
.remove-member {
margin-left: 8px;
color: var(--error);
cursor: pointer;
font-size: 0.8rem;
}

/* –ù–æ–≤—ã–µ –ø–æ—Å—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ */
.post-file-preview {
max-width: 100%;
border-radius: 8px;
margin-top: 15px;
max-height: 400px;
object-fit: cover;
}
.post-voice-message {
margin-top: 15px;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
@keyframes pulseOnline {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}
.status-online {
animation: pulseOnline 2s ease-in-out infinite;
}
</style>
</head>
<body>
<!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞ ... -->

<!-- –ù–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´ -->

<!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–æ–≤ -->
<div class="container hidden" id="chatsPage">
<div class="panel-card" style="margin-top: 20px;">
<h2><i class="fas fa-comments"></i> –°–æ–æ–±—â–µ–Ω–∏—è</h2>
<div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
<button class="btn btn-primary" id="createGroupBtn">
<i class="fas fa-users"></i> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
</button>
<button class="btn btn-secondary" id="newChatBtn">
<i class="fas fa-user-plus"></i> –ù–æ–≤—ã–π —á–∞—Ç
</button>
</div>
<div class="chat-container">
<!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
<div class="chat-sidebar">
<div id="chatContactsList">
<!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
</div>
</div>
<!-- –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div class="chat-messages" id="chatMessagesContainer">
<div class="chat-header" id="chatHeader">
<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ -->
</div>
<div class="chat-message-list" id="chatMessageList">
<!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
</div>
<div class="chat-input-area">
<div style="display: flex; gap: 10px; align-items: center;">
<input type="file" id="chatFileInput" style="display: none;">
<button class="btn btn-secondary" id="attachFileBtn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
<i class="fas fa-paperclip"></i>
</button>
<button class="btn btn-secondary" id="recordVoiceBtn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ">
üé§
</button>
<textarea class="form-input" id="chatMessageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1; min-height: 40px; resize: none;"></textarea>
<button class="btn btn-primary" id="sendChatMessageBtn">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥—Ä—É–ø–ø -->
<div class="container hidden" id="groupsPage">
<div class="panel-card" style="margin-top: 20px;">
<h2><i class="fas fa-users"></i> –ì—Ä—É–ø–ø—ã</h2>
<div style="margin-bottom: 20px;">
<button class="btn btn-primary" id="createGroupFromPageBtn">
<i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
</button>
</div>
<div id="groupsList">
<!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
</div>
</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
<div class="modal" id="createGroupModal">
<div class="modal-content create-group-modal">
<div class="modal-header">
<div class="modal-title">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
<button class="close-modal" id="closeCreateGroupModal">&times;</button>
</div>
<div class="form-group">
<label class="form-label" for="groupNameInput">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
<input type="text" id="groupNameInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
</div>
<div class="form-group">
<label class="form-label" for="groupDescriptionInput">–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
<textarea id="groupDescriptionInput" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" rows="3"></textarea>
</div>
<div class="form-group">
<label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
<div id="availableMembersList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 10px;">
<!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
</div>
</div>
<div class="form-group">
<label class="form-label">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</label>
<div class="group-members-list" id="selectedMembersList">
<!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ -->
</div>
</div>
<button class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="createGroupSubmitBtn">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
<div class="modal" id="viewProfileModal">
<div class="modal-content" style="max-width: 700px;">
<div class="modal-header">
<div class="modal-title">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
<button class="close-modal" id="closeViewProfileModal">&times;</button>
</div>
<div id="viewProfileContent">
<!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ JS -->
</div>
</div>
</div>

<!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
<div class="container hidden" id="adminPanelPage">
<div class="admin-panel">
<h2 style="margin-bottom: 30px;"><i class="fas fa-shield-alt"></i> –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
<div class="admin-stats">
<div class="admin-stat-card">
<div class="admin-stat-value" id="adminTotalUsers">0</div>
<div class="admin-stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-value" id="adminOnlineUsers">0</div>
<div class="admin-stat-label">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-value" id="adminTotalPosts">0</div>
<div class="admin-stat-label">–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-value" id="adminTotalGroups">0</div>
<div class="admin-stat-label">–í—Å–µ–≥–æ –≥—Ä—É–ø–ø</div>
</div>
</div>
<div class="admin-actions">
<h3 style="margin-bottom: 15px;"><i class="fas fa-user-check"></i> –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
<div class="admin-user-list" id="adminUsersList">
<!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
</div>
</div>
</div>
</div>

<script>
// ========== –ù–ê–°–¢–†–û–ô–ö–ê SUPABASE ==========
const supabaseUrl = 'https://kzbznupjamhualdewyxk.supabase.co'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL
const supabaseKey = 'sb_publishable_VSXNcvoaf2meTwwR8gr80g_Y_YEhSgd'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π anon key
const supabase = supabaseUrl && supabaseKey ? supabase.create({ supabaseUrl, supabaseKey }) : null;

// ========== –†–ê–°–®–ò–†–ï–ù–ù–´–ï –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let currentUser = null;
let allUsers = [];
let allPosts = [];
let allChats = [];
let allGroups = [];
let allMessages = [];
let notifications = [];
let clans = {};
let onlineUsers = new Set();
let mediaRecorder = null;
let audioChunks = [];

// –≠–º–æ–¥–∑–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞
const availableEmojis = ['üòÄ', 'üòé', 'ü§ñ', 'üëª', 'üê±', 'ü¶ä', 'üê∂', 'ü¶Å', 'üöÄ', 'üé®', 'üéÆ', 'üéµ', 'üì∏', 'üìö', 'üç≥', 'üåç', 'üë®‚Äçüíª', 'üë©‚Äçüíª', 'üß†', 'üí°', 'üî•', 'üåü', 'üåô', '‚òÄÔ∏è', 'üåà', 'üçï', '‚öΩ', 'üé≠', 'üé∏', 'üé¨'];

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SUPABASE ==========
async function initializeSupabase() {
if (!supabase) {
console.warn('Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è localStorage.');
initializeData();
return;
}

try {
// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase
const { data: usersData, error: usersError } = await supabase
.from('users')
.select('*')
.order('created_at', { ascending: false });

const { data: postsData, error: postsError } = await supabase
.from('posts')
.select('*')
.order('created_at', { ascending: false });

const { data: chatsData, error: chatsError } = await supabase
.from('chats')
.select('*');

const { data: groupsData, error: groupsError } = await supabase
.from('groups')
.select('*');

const { data: messagesData, error: messagesError } = await supabase
.from('messages')
.select('*')
.order('created_at', { ascending: false });

if (usersData) allUsers = usersData;
if (postsData) allPosts = postsData;
if (chatsData) allChats = chatsData;
if (groupsData) allGroups = groupsData;
if (messagesData) allMessages = messagesData;

updateClanStats();
initializeUI();

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
subscribeToRealtimeUpdates();

} catch (error) {
console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'error');
}
}

// ========== REALTIME –û–ë–ù–û–í–õ–ï–ù–ò–Ø ==========
function subscribeToRealtimeUpdates() {
if (!supabase) return;

// –ù–æ–≤—ã–µ –ø–æ—Å—Ç—ã
supabase
.channel('posts-channel')
.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, 
(payload) => {
allPosts.unshift(payload.new);
if (document.getElementById('feedContent').classList.contains('hidden') === false) {
loadPosts();
}
})
.subscribe();

// –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
supabase
.channel('messages-channel')
.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, 
(payload) => {
allMessages.push(payload.new);
const chatId = payload.new.chat_id;
if (currentChatId === chatId) {
loadChatMessages(chatId);
}
})
.subscribe();

// –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
supabase
.channel('online-channel')
.on('presence', { event: 'join' }, (payload) => {
onlineUsers.add(payload.user_id);
updateOnlineStatus();
})
.on('presence', { event: 'leave' }, (payload) => {
onlineUsers.delete(payload.user_id);
updateOnlineStatus();
})
.subscribe();
}

// ========== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ü–†–û–°–ú–û–¢–†–ê –ü–†–û–§–ò–õ–Ø ==========
function showUserProfile(userId) {
const user = allUsers.find(u => u.id === userId);
if (!user) return;

const userPosts = allPosts.filter(p => p.user_id === userId);
const userReposts = allPosts.filter(p => p.user_id === userId && p.original_post_id);

const isFollowing = currentUser.following?.includes(userId);
const isVerified = user.is_verified || false;

const modal = document.getElementById('viewProfileModal');
const content = document.getElementById('viewProfileContent');

content.innerHTML = `
<div style="text-align: center; margin-bottom: 30px;">
<div style="position: relative; display: inline-block; margin-bottom: 15px;">
<div class="profile-emoji" style="font-size: 6rem;">${user.emoji}</div>
<div class="status-indicator">
<div class="status-badge ${onlineUsers.has(userId) ? 'status-online' : 'status-offline'}"></div>
</div>
${isVerified ? '<i class="fas fa-check-circle verified-badge" title="–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç"></i>' : ''}
</div>
<h2 style="font-size: 1.8rem; margin-bottom: 5px;">${user.display_name}</h2>
<div class="username" style="font-size: 1.1rem; color: var(--text-light); margin-bottom: 8px;">${user.username}</div>
<div class="clan" style="display: inline-block; margin-bottom: 15px;">${user.clan}</div>
${user.description ? `<div class="user-description">${user.description}</div>` : ''}
</div>

<div class="profile-tabs">
<div class="profile-tab active" data-tab="posts">–ü—É–±–ª–∏–∫–∞—Ü–∏–∏ (${userPosts.length})</div>
<div class="profile-tab" data-tab="reposts">–†–µ–ø–æ—Å—Ç—ã (${userReposts.length})</div>
<div class="profile-tab" data-tab="about">–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</div>
</div>

<div class="profile-tab-content active" id="profilePostsTab">
${userPosts.length > 0 ? userPosts.map(post => createPostHTML(post)).join('') : 
'<div style="text-align: center; padding: 40px; color: var(--text-light);">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'}
</div>

<div class="profile-tab-content" id="profileRepostsTab">
${userReposts.length > 0 ? userReposts.map(post => createPostHTML(post)).join('') : 
'<div style="text-align: center; padding: 40px; color: var(--text-light);">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–ø–æ—Å—Ç–æ–≤</div>'}
</div>

<div class="profile-tab-content" id="profileAboutTab">
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
<div>
<h4 style="margin-bottom: 10px; color: var(--text-light);">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
<div style="background-color: var(--secondary); padding: 15px; border-radius: var(--radius);">
<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
<span>–ü–æ—Å—Ç–æ–≤:</span>
<strong>${userPosts.length}</strong>
</div>
<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
<span>–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤:</span>
<strong>${user.followers?.length || 0}</strong>
</div>
<div style="display: flex; justify-content: space-between;">
<span>–ü–æ–¥–ø–∏—Å–æ–∫:</span>
<strong>${user.following?.length || 0}</strong>
</div>
</div>
</div>
<div>
<h4 style="margin-bottom: 10px; color: var(--text-light);">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
<div style="background-color: var(--secondary); padding: 15px; border-radius: var(--radius);">
<div style="margin-bottom: 10px;">
<span style="color: var(--text-light);">–°—Ç–∞—Ç—É—Å:</span>
<span style="margin-left: 10px;">
<i class="fas fa-circle ${onlineUsers.has(userId) ? 'status-online' : 'status-offline'}"></i>
${onlineUsers.has(userId) ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}
</span>
</div>
<div style="margin-bottom: 10px;">
<span style="color: var(--text-light);">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</span>
<span style="margin-left: 10px;">${new Date(user.created_at).toLocaleDateString('ru-RU')}</span>
</div>
${user.status ? `<div>
<span style="color: var(--text-light);">–°—Ç–∞—Ç—É—Å:</span>
<span style="margin-left: 10px; font-weight: 600;">${user.status}</span>
</div>` : ''}
</div>
</div>
</div>
</div>
`;

modal.classList.add('active');

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
document.querySelectorAll('.profile-tab').forEach(tab => {
tab.addEventListener('click', function() {
document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
document.querySelectorAll('.profile-tab-content').forEach(c => c.classList.remove('active'));
this.classList.add('active');
document.getElementById(`profile${this.dataset.tab.charAt(0).toUpperCase() + this.dataset.tab.slice(1)}Tab`).classList.add('active');
});
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è
document.getElementById('closeViewProfileModal').onclick = () => {
modal.classList.remove('active');
};

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ—Å—Ç–æ–≤
setTimeout(() => {
document.querySelectorAll('#viewProfileContent .post').forEach(postEl => {
const postId = parseInt(postEl.dataset.postId);
const post = allPosts.find(p => p.id === postId);
if (post) addPostEventListeners(postEl, post);
});
}, 100);
}

// ========== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô ==========
function getRecommendedPosts() {
if (!currentUser) return allPosts;

const followingIds = currentUser.following || [];
const userClan = currentUser.clan;

// –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É:
// 1. –ü–æ—Å—Ç—ã –æ—Ç –ª—é–¥–µ–π, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω (+50 –±–∞–ª–ª–æ–≤)
// 2. –ü–æ—Å—Ç—ã –æ—Ç –ª—é–¥–µ–π –∏–∑ —Ç–æ–≥–æ –∂–µ –∫–ª–∞–Ω–∞ (+30 –±–∞–ª–ª–æ–≤)
// 3. –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ—Å—Ç—ã (–ø–æ –ª–∞–π–∫–∞–º) (+10 –±–∞–ª–ª–æ–≤ –∑–∞ –ª–∞–π–∫)
// 4. –ù–µ–¥–∞–≤–Ω–∏–µ –ø–æ—Å—Ç—ã (+5 –±–∞–ª–ª–æ–≤ –∑–∞ –∫–∞–∂–¥—ã–π —á–∞—Å)
// 5. –†–µ–ø–æ—Å—Ç—ã –æ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö (+20 –±–∞–ª–ª–æ–≤)

const scoredPosts = allPosts.map(post => {
const author = allUsers.find(u => u.id === post.user_id);
if (!author) return { ...post, score: 0 };

let score = 0;

// –ü–æ—Å—Ç—ã –æ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö
if (followingIds.includes(post.user_id)) score += 50;

// –ü–æ—Å—Ç—ã –æ—Ç –∫–ª–∞–Ω–∞
if (author.clan === userClan) score += 30;

// –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
score += (post.likes?.length || 0) * 10;

// –ù–µ–¥–∞–≤–Ω–æ—Å—Ç—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞)
const hoursAgo = (Date.now() - new Date(post.created_at).getTime()) / (1000 * 60 * 60);
if (hoursAgo < 24) score += (24 - hoursAgo) * 5;

// –†–µ–ø–æ—Å—Ç—ã –æ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö
if (post.original_post_id && followingIds.includes(post.user_id)) score += 20;

return { ...post, score, author };
});

// –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –∏ –±–µ—Ä–µ–º —Ç–æ–ø-20
return scoredPosts
.sort((a, b) => b.score - a.score)
.slice(0, 20);
}

// ========== –ß–ê–¢–´ –ò –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ==========
let currentChatId = null;
let currentChatType = null; // 'private' –∏–ª–∏ 'group'

function loadChats() {
const contactsList = document.getElementById('chatContactsList');
contactsList.innerHTML = '';

// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const userChats = allChats.filter(chat => 
chat.participants?.includes(currentUser.id)
);

if (userChats.length === 0) {
contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-light);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
return;
}

// –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
userChats.sort((a, b) => {
const lastMsgA = allMessages.filter(m => m.chat_id === a.id).slice(-1)[0];
const lastMsgB = allMessages.filter(m => m.chat_id === b.id).slice(-1)[0];
return (lastMsgB?.created_at || 0) - (lastMsgA?.created_at || 0);
});

userChats.forEach(chat => {
const otherParticipants = chat.participants.filter(p => p !== currentUser.id);
const isGroup = chat.is_group || false;
const lastMessage = allMessages.filter(m => m.chat_id === chat.id).slice(-1)[0];

let contactName = '';
let contactAvatar = '';
let isOnline = false;

if (isGroup) {
contactName = chat.name || `–ì—Ä—É–ø–ø–∞ ${chat.id}`;
contactAvatar = chat.avatar || 'üë•';
} else {
const otherUser = allUsers.find(u => u.id === otherParticipants[0]);
if (otherUser) {
contactName = otherUser.display_name;
contactAvatar = otherUser.emoji;
isOnline = onlineUsers.has(otherUser.id);
}
}

const contactElement = document.createElement('div');
contactElement.className = `chat-contact ${currentChatId === chat.id ? 'active' : ''}`;
contactElement.dataset.chatId = chat.id;
contactElement.dataset.chatType = isGroup ? 'group' : 'private';

contactElement.innerHTML = `
<div class="chat-contact-avatar">${contactAvatar}</div>
<div class="chat-contact-info">
<div class="chat-contact-name">
${contactName}
${isGroup && chat.is_verified ? '<i class="fas fa-check-circle verified-badge" title="–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞"></i>' : ''}
</div>
<div class="chat-contact-last-message">
${lastMessage ? (lastMessage.file_url ? 'üìé –§–∞–π–ª' : lastMessage.voice_url ? 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ' : lastMessage.content.substring(0, 30)) : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}
</div>
</div>
<div style="text-align: right;">
<div class="status-badge ${isOnline ? 'status-online' : 'status-offline'}" style="margin-left: auto;"></div>
${lastMessage ? `<div class="chat-contact-time">${formatTimeAgo(lastMessage.created_at)}</div>` : ''}
</div>
`;

contactElement.addEventListener('click', () => {
document.querySelectorAll('.chat-contact').forEach(c => c.classList.remove('active'));
contactElement.classList.add('active');
currentChatId = chat.id;
currentChatType = isGroup ? 'group' : 'private';
loadChatMessages(chat.id);
updateChatHeader(chat);
});

contactsList.appendChild(contactElement);
});
}

function loadChatMessages(chatId) {
const messagesList = document.getElementById('chatMessageList');
messagesList.innerHTML = '';

const chatMessages = allMessages
.filter(m => m.chat_id === chatId)
.sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
.slice(-50); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π

if (chatMessages.length === 0) {
messagesList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</div>';
} else {
chatMessages.forEach(msg => {
const sender = allUsers.find(u => u.id === msg.user_id);
const isSent = msg.user_id === currentUser.id;

const messageElement = document.createElement('div');
messageElement.className = `chat-message ${isSent ? 'sent' : ''}`;

let messageContent = msg.content || '';

if (msg.file_url) {
messageContent += `
<div class="file-attachment">
<i class="fas fa-file-alt file-icon"></i>
<div class="file-info">
<div class="file-name">${msg.file_name || '–§–∞–π–ª'}</div>
<div class="file-size">${formatFileSize(msg.file_size)}</div>
</div>
<a href="${msg.file_url}" class="file-download" download><i class="fas fa-download"></i></a>
</div>
`;
}

if (msg.voice_url) {
messageContent += `
<div class="voice-message">
<i class="fas fa-microphone voice-icon"></i>
<span>–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
<audio src="${msg.voice_url}" controls style="margin-left: 10px;"></audio>
<div class="voice-duration">${formatVoiceDuration(msg.voice_duration)}</div>
</div>
`;
}

messageElement.innerHTML = `
<div style="flex: 1; display: flex; ${isSent ? 'justify-content: flex-end;' : ''}">
<div class="chat-message-bubble">
${messageContent}
<div class="chat-message-info">
${sender ? sender.display_name + ' ‚Ä¢ ' : ''}
${formatTimeAgo(msg.created_at)}
</div>
</div>
</div>
`;

messagesList.appendChild(messageElement);
});
}

// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
setTimeout(() => {
messagesList.scrollTop = messagesList.scrollHeight;
}, 100);
}

function updateChatHeader(chat) {
const header = document.getElementById('chatHeader');
const isGroup = chat.is_group || false;

if (isGroup) {
header.innerHTML = `
<div style="display: flex; align-items: center; gap: 15px;">
<div class="group-avatar">${chat.avatar || 'üë•'}</div>
<div style="flex: 1;">
<h3 style="margin-bottom: 5px;">${chat.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
<div style="font-size: 0.9rem; color: var(--text-light);">
${chat.participants?.length || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
</div>
</div>
</div>
`;
} else {
const otherUserId = chat.participants.find(p => p !== currentUser.id);
const otherUser = allUsers.find(u => u.id === otherUserId);
const isOnline = otherUser && onlineUsers.has(otherUserId);

header.innerHTML = `
<div style="display: flex; align-items: center; gap: 15px;">
<div class="emoji-avatar" style="font-size: 2rem;">${otherUser?.emoji || 'üë§'}</div>
<div style="flex: 1;">
<h3 style="margin-bottom: 5px;">${otherUser?.display_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</h3>
<div style="font-size: 0.9rem; color: var(--text-light);">
<i class="fas fa-circle ${isOnline ? 'status-online' : 'status-offline'}"></i>
${isOnline ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}
</div>
</div>
</div>
`;
}
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
document.getElementById('sendChatMessageBtn')?.addEventListener('click', async function() {
if (!currentChatId) return;

const content = document.getElementById('chatMessageInput').value.trim();
if (!content && !pendingFile && !pendingVoice) return;

const messageData = {
id: allMessages.length + 1,
chat_id: currentChatId,
user_id: currentUser.id,
content: content || null,
created_at: new Date().toISOString()
};

// –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª
if (pendingFile) {
messageData.file_url = pendingFile.url;
messageData.file_name = pendingFile.name;
messageData.file_size = pendingFile.size;
pendingFile = null;
}

// –ï—Å–ª–∏ –µ—Å—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ
if (pendingVoice) {
messageData.voice_url = pendingVoice.url;
messageData.voice_duration = pendingVoice.duration;
pendingVoice = null;
}

allMessages.push(messageData);

if (supabase) {
await supabase.from('messages').insert([messageData]);
} else {
saveData();
}

document.getElementById('chatMessageInput').value = '';
loadChatMessages(currentChatId);
});

// ========== –ì–†–£–ü–ü–´ ==========
function loadGroups() {
const groupsList = document.getElementById('groupsList');
groupsList.innerHTML = '';

const userGroups = allGroups.filter(group => 
group.members?.includes(currentUser.id)
);

if (userGroups.length === 0) {
groupsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø</div>';
return;
}

userGroups.forEach(group => {
const memberCount = group.members?.length || 0;
const creator = allUsers.find(u => u.id === group.creator_id);

const groupElement = document.createElement('div');
groupElement.className = 'group-card slide-up';
groupElement.dataset.groupId = group.id;

groupElement.innerHTML = `
<div class="group-header">
<div class="group-avatar">${group.avatar || 'üë•'}</div>
<div class="group-info">
<div class="group-name">
${group.name}
${group.is_verified ? '<i class="fas fa-check-circle verified-badge" title="–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞"></i>' : ''}
</div>
<div class="group-members">${memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
</div>
</div>
${group.description ? `<div class="group-description">${group.description}</div>` : ''}
<div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
<div style="font-size: 0.85rem; color: var(--text-light);">
–°–æ–∑–¥–∞–ª: ${creator?.display_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ‚Ä¢ 
${formatTimeAgo(group.created_at)}
</div>
<button class="btn btn-primary" style="padding: 8px 15px; font-size: 0.9rem;">–û—Ç–∫—Ä—ã—Ç—å</button>
</div>
`;

groupElement.querySelector('button').addEventListener('click', () => {
// –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç –≥—Ä—É–ø–ø—ã
const groupChat = allChats.find(c => c.is_group && c.participants?.includes(group.id));
if (groupChat) {
currentChatId = groupChat.id;
currentChatType = 'group';
showPage('chats');
loadChatMessages(groupChat.id);
updateChatHeader(groupChat);
document.querySelectorAll('.chat-contact').forEach(c => c.classList.remove('active'));
const contact = document.querySelector(`[data-chat-id="${groupChat.id}"]`);
if (contact) contact.classList.add('active');
}
});

groupsList.appendChild(groupElement);
});
}

// –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
document.getElementById('createGroupBtn')?.addEventListener('click', function() {
document.getElementById('createGroupModal').classList.add('active');
loadAvailableMembers();
});

document.getElementById('createGroupFromPageBtn')?.addEventListener('click', function() {
document.getElementById('createGroupModal').classList.add('active');
loadAvailableMembers();
});

function loadAvailableMembers() {
const availableList = document.getElementById('availableMembersList');
const selectedList = document.getElementById('selectedMembersList');

availableList.innerHTML = '';
selectedList.innerHTML = '';

// –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
const currentUserItem = document.createElement('div');
currentUserItem.className = 'group-member-item';
currentUserItem.innerHTML = `${currentUser.display_name} <span class="remove-member" style="display: none;">√ó</span>`;
currentUserItem.dataset.userId = currentUser.id;
selectedList.appendChild(currentUserItem);

// –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
allUsers
.filter(u => u.id !== currentUser.id)
.slice(0, 20) // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ
.forEach(user => {
const memberItem = document.createElement('div');
memberItem.style.padding = '10px';
memberItem.style.cursor = 'pointer';
memberItem.style.borderRadius = '8px';
memberItem.style.transition = 'background-color 0.2s';
memberItem.innerHTML = `
<div style="display: flex; align-items: center; gap: 10px;">
<div style="font-size: 1.5rem;">${user.emoji}</div>
<div>
<div style="font-weight: 600;">${user.display_name}</div>
<div style="font-size: 0.85rem; color: var(--text-light);">${user.username}</div>
</div>
</div>
`;
memberItem.onmouseover = () => memberItem.style.backgroundColor = 'var(--secondary)';
memberItem.onmouseout = () => memberItem.style.backgroundColor = '';
memberItem.onclick = () => {
// –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
availableList.removeChild(memberItem);
const selectedItem = document.createElement('div');
selectedItem.className = 'group-member-item';
selectedItem.innerHTML = `${user.display_name} <span class="remove-member">√ó</span>`;
selectedItem.dataset.userId = user.id;
selectedList.appendChild(selectedItem);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
selectedItem.querySelector('.remove-member').onclick = (e) => {
e.stopPropagation();
selectedList.removeChild(selectedItem);
availableList.appendChild(memberItem);
};
};
availableList.appendChild(memberItem);
});
}

// ========== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ==========
function loadAdminPanel() {
if (currentUser.username !== '@onegin') {
showNotification('–û—à–∏–±–∫–∞', '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏', 'error');
showPage('feed');
return;
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
document.getElementById('adminTotalUsers').textContent = allUsers.length;
document.getElementById('adminOnlineUsers').textContent = onlineUsers.size;
document.getElementById('adminTotalPosts').textContent = allPosts.length;
document.getElementById('adminTotalGroups').textContent = allGroups.length;

// –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
const usersList = document.getElementById('adminUsersList');
usersList.innerHTML = '';

allUsers.slice(0, 20).forEach(user => {
const userItem = document.createElement('div');
userItem.className = 'admin-user-item';

userItem.innerHTML = `
<div style="font-size: 2rem;">${user.emoji}</div>
<div class="admin-user-info">
<div style="font-weight: 600; font-size: 1.1rem;">
${user.display_name}
${user.is_verified ? '<i class="fas fa-check-circle verified-badge" title="–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω"></i>' : ''}
</div>
<div style="color: rgba(255,255,255,0.8); margin-bottom: 5px;">${user.username}</div>
<div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
–ü–æ—Å—Ç–æ–≤: ${allPosts.filter(p => p.user_id === user.id).length} ‚Ä¢ 
–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: ${user.followers?.length || 0}
</div>
</div>
<button class="admin-verify-btn ${user.is_verified ? 'verified' : ''}">
${user.is_verified ? '‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' : '–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å'}
</button>
`;

userItem.querySelector('button').addEventListener('click', async () => {
const isVerified = !user.is_verified;
user.is_verified = isVerified;

if (supabase) {
await supabase
.from('users')
.update({ is_verified: isVerified })
.eq('id', user.id);
} else {
saveData();
}

loadAdminPanel();
showNotification('–£—Å–ø–µ—Ö', `${user.display_name} ${isVerified ? '–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' : '–ª–∏—à–µ–Ω –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏'}`, 'success');
});

usersList.appendChild(userItem);
});
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
function formatTimeAgo(dateString) {
const date = new Date(dateString);
const diffMs = Date.now() - date.getTime();
const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
const diffDays = Math.floor(diffHours / 24);

if (diffHours < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
if (diffHours < 24) return `${diffHours}—á –Ω–∞–∑–∞–¥`;
if (diffDays < 7) return `${diffDays}–¥ –Ω–∞–∑–∞–¥`;
return date.toLocaleDateString('ru-RU');
}

function formatFileSize(bytes) {
if (bytes < 1024) return `${bytes} –ë`;
if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} –ö–ë`;
return `${(bytes / (1024 * 1024)).toFixed(1)} –ú–ë`;
}

function formatVoiceDuration(seconds) {
const mins = Math.floor(seconds / 60);
const secs = Math.floor(seconds % 60);
return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function createPostHTML(post) {
const author = allUsers.find(u => u.id === post.user_id);
if (!author) return '';

const isLiked = post.likes?.includes(currentUser.id);
const hoursAgo = Math.floor((Date.now() - new Date(post.created_at).getTime()) / (1000 * 60 * 60));
const timeText = hoursAgo < 1 ? '—Ç–æ–ª—å–∫–æ —á—Ç–æ' : hoursAgo < 24 ? `${hoursAgo}—á –Ω–∞–∑–∞–¥` : `${Math.floor(hoursAgo / 24)}–¥ –Ω–∞–∑–∞–¥`;

return `
<div class="post panel-card slide-up" data-post-id="${post.id}">
<div class="post-header" data-user-id="${author.id}">
<div class="emoji-avatar">${author.emoji}</div>
<div class="post-user-info">
<div class="post-username">
${author.username}
${author.is_verified ? '<i class="fas fa-check-circle verified-badge" title="–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç"></i>' : ''}
</div>
<div class="post-time">${timeText}</div>
</div>
</div>
<div class="post-content">${post.content}</div>
${post.file_url ? `<img src="${post.file_url}" class="post-file-preview" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">` : ''}
${post.voice_url ? `<div class="post-voice-message">
<audio src="${post.voice_url}" controls></audio>
<div style="margin-top: 5px; font-size: 0.9rem; color: var(--text-light);">–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
</div>` : ''}
<div class="post-stats">
<div class="post-stat ${isLiked ? 'liked' : ''}" data-action="like">
<i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
<span>${post.likes?.length || 0}</span>
</div>
<div class="post-stat" data-action="comment">
<i class="far fa-comment"></i>
<span>${post.comments?.length || 0}</span>
</div>
<div class="post-stat" data-action="repost">
<i class="fas fa-retweet"></i>
<span>${post.reposts || 0}</span>
</div>
</div>
</div>
`;
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
// –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞ –Ω–æ–≤—É—é
window.addEventListener('DOMContentLoaded', () => {
initializeSupabase();
});

// –ï—Å–ª–∏ Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–¥
if (!supabase) {
console.log('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ—Ä—Å–∏—è –±–µ–∑ Supabase (localStorage)');
// –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–≤–æ–π —Å—Ç–∞—Ä—ã–π –∫–æ–¥ —Å localStorage
}
</script>
</body>
</html>